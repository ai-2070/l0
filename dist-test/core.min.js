var te=class{rules;config;state;constructor(e){this.rules=e.rules||[],this.config={stopOnFatal:!0,enableStreaming:!0,checkInterval:100,...e},this.state=this.createInitialState()}createInitialState(){return{violations:[],violationsByRule:new Map,hasFatalViolations:!1,hasErrorViolations:!1,violationCount:0}}check(e){let n=[],r=Date.now();for(let a of this.rules)if(!(a.streaming&&!this.config.enableStreaming&&!e.completed)&&!(!a.streaming&&!e.completed))try{let s=a.check({...e,previousViolations:this.state.violations});for(let l of s)n.push({...l,timestamp:r});if(s.length>0){let l=this.state.violationsByRule.get(a.name)||[];this.state.violationsByRule.set(a.name,[...l,...s])}if(this.config.stopOnFatal&&s.some(l=>l.severity==="fatal"))break}catch(s){n.push({rule:a.name,message:`Rule execution failed: ${s instanceof Error?s.message:"Unknown error"}`,severity:"warning",recoverable:!0,timestamp:r})}if(this.state.violations.push(...n),this.state.violationCount=this.state.violations.length,this.state.hasFatalViolations=n.some(a=>a.severity==="fatal"),this.state.hasErrorViolations=n.some(a=>a.severity==="error"),this.state.lastCheckTime=r,this.config.onViolation)for(let a of n)this.config.onViolation(a);return{passed:n.length===0,violations:n,shouldRetry:this.shouldRetry(n),shouldHalt:this.shouldHalt(n),summary:{total:n.length,fatal:n.filter(a=>a.severity==="fatal").length,errors:n.filter(a=>a.severity==="error").length,warnings:n.filter(a=>a.severity==="warning").length}}}shouldRetry(e){return e.some(n=>n.recoverable&&(n.severity==="error"||n.severity==="fatal"))}shouldHalt(e){return!!(e.some(n=>n.severity==="fatal")||e.some(n=>!n.recoverable&&n.severity==="error"))}getState(){return{...this.state}}reset(){this.state=this.createInitialState()}addRule(e){this.rules.push(e)}removeRule(e){let n=this.rules.findIndex(r=>r.name===e);return n!==-1?(this.rules.splice(n,1),!0):!1}getViolationsByRule(e){return this.state.violationsByRule.get(e)||[]}getAllViolations(){return[...this.state.violations]}hasViolations(){return this.state.violationCount>0}hasFatalViolations(){return this.state.hasFatalViolations}hasErrorViolations(){return this.state.hasErrorViolations}};function je(t,e){return new te({rules:t,...e})}function vt(t,e){return je(e).check(t)}var d={attempts:3,maxRetries:6,baseDelay:1e3,maxDelay:1e4,networkMaxDelay:3e4,backoff:"fixed-jitter",retryOn:["zero_output","guardrail_violation","drift","incomplete","network_error","timeout","rate_limit","server_error"]},N={connectionDropped:1e3,fetchError:500,econnreset:1e3,econnrefused:2e3,sseAborted:500,noBytes:500,partialChunks:500,runtimeKilled:2e3,backgroundThrottle:5e3,dnsError:3e3,timeout:1e3,unknown:1e3},ce=(l=>(l.NETWORK="network",l.TRANSIENT="transient",l.MODEL="model",l.CONTENT="content",l.PROVIDER="provider",l.FATAL="fatal",l.INTERNAL="internal",l))(ce||{});function We(t,e=d.baseDelay,n=d.maxDelay){let r=e*Math.pow(2,t);return{delay:Math.min(r,n),cappedAtMax:r>n,rawDelay:r}}function Tt(t,e=d.baseDelay,n=d.maxDelay){let r=e*(t+1);return{delay:Math.min(r,n),cappedAtMax:r>n,rawDelay:r}}function xt(t=d.baseDelay){return{delay:t,cappedAtMax:!1,rawDelay:t}}function wt(t=d.baseDelay,e=d.maxDelay){let n=Math.random()*t*.5,r=t+n;return{delay:Math.min(Math.floor(r),e),cappedAtMax:r>e,rawDelay:r}}function Ct(t,e=d.baseDelay,n=d.maxDelay){let r=e*Math.pow(2,t),o=Math.min(r,n),a=Math.random()*o;return{delay:Math.floor(a),cappedAtMax:r>n,rawDelay:a}}function Oe(t,e,n=d.baseDelay,r=d.maxDelay){switch(t){case"exponential":return We(e,n,r);case"linear":return Tt(e,n,r);case"fixed":return xt(n);case"full-jitter":return Ct(e,n,r);case"fixed-jitter":return wt(n,r);default:return We(e,n,r)}}function Ne(t){return new Promise(e=>setTimeout(e,t))}function Lt(t,e="Timeout"){return new Promise((n,r)=>{setTimeout(()=>r(new Error(e)),t)})}async function Dt(t,e,n){return Promise.race([t,Lt(e,n)])}function Ot(t){switch(t){case"NETWORK_ERROR":return"network";case"INITIAL_TOKEN_TIMEOUT":case"INTER_TOKEN_TIMEOUT":return"transient";case"GUARDRAIL_VIOLATION":case"FATAL_GUARDRAIL_VIOLATION":case"DRIFT_DETECTED":case"ZERO_OUTPUT":return"content";case"INVALID_STREAM":case"ADAPTER_NOT_FOUND":case"FEATURE_NOT_ENABLED":return"internal";case"STREAM_ABORTED":case"ALL_STREAMS_EXHAUSTED":default:return"provider"}}var w=class t extends Error{code;context;timestamp;constructor(e,n){super(e),this.name="L0Error",this.code=n.code,this.context=n,this.timestamp=Date.now(),Object.setPrototypeOf(this,t.prototype)}get category(){return Ot(this.code)}get isRecoverable(){return this.context.recoverable===!0&&this.context.checkpoint!==void 0&&this.context.checkpoint.length>0}getCheckpoint(){return this.context.checkpoint}toDetailedString(){let e=[this.message];return this.context.tokenCount!==void 0&&e.push(`Tokens: ${this.context.tokenCount}`),this.context.modelRetryCount!==void 0&&e.push(`Retries: ${this.context.modelRetryCount}`),this.context.fallbackIndex!==void 0&&this.context.fallbackIndex>0&&e.push(`Fallback: ${this.context.fallbackIndex}`),this.context.checkpoint&&e.push(`Checkpoint: ${this.context.checkpoint.length} chars`),e.join(" | ")}toJSON(){return{name:this.name,code:this.code,category:this.category,message:this.message,timestamp:this.timestamp,recoverable:this.isRecoverable,checkpoint:this.context.checkpoint?this.context.checkpoint.length:void 0,tokenCount:this.context.tokenCount,modelRetryCount:this.context.modelRetryCount,networkRetryCount:this.context.networkRetryCount,fallbackIndex:this.context.fallbackIndex}}};function Nt(t){return t instanceof w}function St(t){return"code"in t&&typeof t.code=="string"}function be(t){return St(t)?t.code:void 0}var Se=(k=>(k.CONNECTION_DROPPED="connection_dropped",k.FETCH_ERROR="fetch_error",k.ECONNRESET="econnreset",k.ECONNREFUSED="econnrefused",k.SSE_ABORTED="sse_aborted",k.NO_BYTES="no_bytes",k.PARTIAL_CHUNKS="partial_chunks",k.RUNTIME_KILLED="runtime_killed",k.BACKGROUND_THROTTLE="background_throttle",k.DNS_ERROR="dns_error",k.SSL_ERROR="ssl_error",k.TIMEOUT="timeout",k.UNKNOWN="unknown",k))(Se||{});function Je(t){let e=t.message.toLowerCase();return e.includes("connection dropped")||e.includes("connection closed")||e.includes("connection lost")||e.includes("connection reset")||e.includes("econnreset")||e.includes("pipe broken")||e.includes("broken pipe")}function Ze(t){return t.name==="TypeError"&&(t.message.toLowerCase().includes("fetch")||t.message.toLowerCase().includes("failed to fetch")||t.message.toLowerCase().includes("network request failed"))}function Ye(t){let e=t.message.toLowerCase();return e.includes("econnreset")||e.includes("connection reset by peer")||be(t)==="ECONNRESET"}function qe(t){let e=t.message.toLowerCase();return e.includes("econnrefused")||e.includes("connection refused")||be(t)==="ECONNREFUSED"}function Xe(t){let e=t.message.toLowerCase();return e.includes("sse")||e.includes("server-sent events")||e.includes("stream")&&e.includes("abort")||e.includes("stream aborted")||e.includes("eventstream")||t.name==="AbortError"}function Qe(t){let e=t.message.toLowerCase();return e.includes("no bytes")||e.includes("empty response")||e.includes("zero bytes")||e.includes("no data received")||e.includes("content-length: 0")}function et(t){let e=t.message.toLowerCase();return e.includes("partial chunk")||e.includes("incomplete chunk")||e.includes("truncated")||e.includes("premature close")||e.includes("unexpected end of data")||e.includes("incomplete data")}function tt(t){let e=t.message.toLowerCase();return e.includes("worker")&&e.includes("terminated")||e.includes("runtime")&&e.includes("killed")||e.includes("edge runtime")||e.includes("lambda timeout")||e.includes("function timeout")||e.includes("execution timeout")||e.includes("worker died")||e.includes("process exited")||e.includes("sigterm")||e.includes("sigkill")}function rt(t){let e=t.message.toLowerCase();return e.includes("background")&&e.includes("suspend")||e.includes("background throttle")||e.includes("tab suspended")||e.includes("page hidden")||e.includes("visibility hidden")||e.includes("inactive tab")||e.includes("background tab")}function nt(t){let e=t.message.toLowerCase();return e.includes("dns")||e.includes("enotfound")||e.includes("name resolution")||e.includes("host not found")||e.includes("getaddrinfo")||be(t)==="ENOTFOUND"}function At(t){let e=t.message.toLowerCase();return e.includes("ssl")||e.includes("tls")||e.includes("certificate")||e.includes("cert")||e.includes("handshake")||e.includes("self signed")||e.includes("unable to verify")}function Re(t){let e=t.message.toLowerCase();return t.name==="TimeoutError"||e.includes("timeout")||e.includes("timed out")||e.includes("time out")||e.includes("deadline exceeded")||e.includes("etimedout")||be(t)==="ETIMEDOUT"}function de(t){return Je(t)?{type:"connection_dropped",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with exponential backoff - connection was interrupted"}:Ze(t)?{type:"fetch_error",retryable:!0,countsTowardLimit:!1,suggestion:"Retry immediately - fetch() failed to initiate"}:Ye(t)?{type:"econnreset",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with backoff - connection was reset by peer"}:qe(t)?{type:"econnrefused",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with longer delay - server refused connection",context:{possibleCause:"Server may be down or not accepting connections"}}:Xe(t)?{type:"sse_aborted",retryable:!0,countsTowardLimit:!1,suggestion:"Retry immediately - SSE stream was aborted"}:Qe(t)?{type:"no_bytes",retryable:!0,countsTowardLimit:!1,suggestion:"Retry immediately - server sent no data",context:{possibleCause:"Empty response or connection closed before data sent"}}:et(t)?{type:"partial_chunks",retryable:!0,countsTowardLimit:!1,suggestion:"Retry immediately - received incomplete data",context:{possibleCause:"Connection closed mid-stream"}}:tt(t)?{type:"runtime_killed",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with shorter timeout - runtime was terminated (likely timeout)",context:{possibleCause:"Edge runtime timeout or Lambda timeout - consider breaking into smaller requests"}}:rt(t)?{type:"background_throttle",retryable:!0,countsTowardLimit:!1,suggestion:"Retry when page becomes visible - mobile/browser throttling",context:{possibleCause:"Browser suspended network activity for background tab",resolution:"Wait for visibilitychange event"}}:nt(t)?{type:"dns_error",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with longer delay - DNS lookup failed",context:{possibleCause:"Network connectivity issue or invalid hostname"}}:At(t)?{type:"ssl_error",retryable:!1,countsTowardLimit:!1,suggestion:"Don't retry - SSL/TLS error (configuration issue)",context:{possibleCause:"Certificate validation failed or SSL handshake error",resolution:"Check server certificate or SSL configuration"}}:Re(t)?{type:"timeout",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with longer timeout - request timed out"}:{type:"unknown",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with caution - unknown network error"}}function J(t){return Je(t)||Ze(t)||Ye(t)||qe(t)||Xe(t)||Qe(t)||et(t)||tt(t)||rt(t)||nt(t)||Re(t)}function Ae(t,e,n,r=d.networkMaxDelay){let o=de(t),a={connection_dropped:N.connectionDropped,fetch_error:N.fetchError,econnreset:N.econnreset,econnrefused:N.econnrefused,sse_aborted:N.sseAborted,no_bytes:N.noBytes,partial_chunks:N.partialChunks,runtime_killed:N.runtimeKilled,background_throttle:N.backgroundThrottle,dns_error:N.dnsError,ssl_error:0,timeout:N.timeout,unknown:N.unknown},s=n?.[o.type]??a[o.type];return s===0?0:Math.min(s*Math.pow(2,e),r)}var Z=class{config;state;constructor(e={}){this.config={attempts:e.attempts??d.attempts,maxRetries:e.maxRetries??d.maxRetries,baseDelay:e.baseDelay??d.baseDelay,maxDelay:e.maxDelay??d.maxDelay,backoff:e.backoff??d.backoff,retryOn:e.retryOn??[...d.retryOn],maxErrorHistory:e.maxErrorHistory},this.state=this.createInitialState()}createInitialState(){return{attempt:0,networkRetryCount:0,transientRetries:0,errorHistory:[],totalDelay:0,limitReached:!1}}categorizeError(e,n){let r=this.classifyError(e),o=this.determineCategory(r),a=o==="model",s=o!=="fatal";return{error:e,category:o,reason:n??this.inferReason(r),countsTowardLimit:a,retryable:s,timestamp:Date.now(),statusCode:r.statusCode}}classifyError(e){let n=e.message?.toLowerCase()||"",r=J(e),o=Re(e),a,s=n.match(/status\s*(?:code)?\s*:?\s*(\d{3})/i);s&&s[1]&&(a=parseInt(s[1],10));let l=a===429||n.includes("rate limit"),c=a!==void 0&&a>=500&&a<600,u=a===401||a===403||n.includes("unauthorized")||n.includes("forbidden"),m=a!==void 0&&a>=400&&a<500&&a!==429;return{isNetwork:r,isRateLimit:l,isServerError:c,isTimeout:o,isAuthError:u,isClientError:m,statusCode:a}}determineCategory(e){return e.isNetwork?"network":e.isRateLimit||e.isServerError||e.isTimeout?"transient":e.isAuthError||e.isClientError&&!e.isRateLimit?"fatal":"model"}inferReason(e,n){if(e.isNetwork){if(n)switch(de(n).type){case"connection_dropped":case"econnreset":case"econnrefused":case"sse_aborted":case"partial_chunks":case"no_bytes":return"network_error";case"runtime_killed":case"timeout":return"timeout";default:return"network_error"}return"network_error"}return e.isTimeout?"timeout":e.isRateLimit?"rate_limit":e.isServerError?"server_error":"unknown"}shouldRetry(e,n){let r=this.categorizeError(e,n);if(r.category==="network"&&J(e)){let s=de(e);if(!s.retryable)return{shouldRetry:!1,delay:0,reason:`Fatal network error: ${s.suggestion}`,category:"fatal",countsTowardLimit:!1}}if(r.category==="fatal")return{shouldRetry:!1,delay:0,reason:"Fatal error - not retryable",category:r.category,countsTowardLimit:!1};if(r.reason&&!this.config.retryOn.includes(r.reason))return{shouldRetry:!1,delay:0,reason:`Retry reason '${r.reason}' not in retryOn list`,category:r.category,countsTowardLimit:!1};if(this.config.maxRetries!==void 0&&this.getTotalRetries()>=this.config.maxRetries)return this.state.limitReached=!0,{shouldRetry:!1,delay:0,reason:`Absolute maximum retries (${this.config.maxRetries}) reached`,category:r.category,countsTowardLimit:!1};if(r.countsTowardLimit&&this.state.attempt>=this.config.attempts)return this.state.limitReached=!0,{shouldRetry:!1,delay:0,reason:"Maximum retry attempts reached",category:r.category,countsTowardLimit:!0};let o=r.countsTowardLimit?this.state.attempt:r.category==="network"?this.state.networkRetryCount:this.state.transientRetries,a;if(r.category==="network"&&this.config.errorTypeDelays&&J(e)){let s=this.mapErrorTypeDelays(this.config.errorTypeDelays),l=Ae(e,o,s,this.config.maxDelay);a={delay:l,cappedAtMax:l>=(this.config.maxDelay??1e4),rawDelay:l}}else a=Oe(this.config.backoff,o,this.config.baseDelay,this.config.maxDelay);return{shouldRetry:!0,delay:a.delay,reason:`Retrying after ${r.category} error`,category:r.category,countsTowardLimit:r.countsTowardLimit}}async recordRetry(e,n){n.countsTowardLimit?this.state.attempt++:e.category==="network"?this.state.networkRetryCount++:e.category==="transient"&&this.state.transientRetries++,this.state.lastError=e,this.state.errorHistory.push(e);let r=this.config.maxErrorHistory;r!==void 0&&this.state.errorHistory.length>r&&(this.state.errorHistory=this.state.errorHistory.slice(-r)),this.state.totalDelay+=n.delay,n.delay>0&&await Ne(n.delay)}async execute(e,n){for(;;)try{return await e()}catch(r){let o=r instanceof Error?r:new Error(String(r)),a=this.categorizeError(o),s=this.shouldRetry(o);if(!s.shouldRetry)throw o;let l=s.countsTowardLimit?this.state.attempt:a.category==="network"?this.state.networkRetryCount:this.state.transientRetries,c;if(a.category==="network"&&this.config.errorTypeDelays&&J(o)){let u=this.mapErrorTypeDelays(this.config.errorTypeDelays),m=Ae(o,l,u,this.config.maxDelay);c={delay:m,cappedAtMax:m>=(this.config.maxDelay??1e4),rawDelay:m}}else c=Oe(this.config.backoff,l,this.config.baseDelay,this.config.maxDelay);n&&n({state:this.getState(),config:this.config,error:a,backoff:c}),await this.recordRetry(a,s)}}getState(){return{...this.state}}reset(){this.state=this.createInitialState()}hasReachedLimit(){return this.state.limitReached}getTotalRetries(){return this.state.attempt+this.state.networkRetryCount+this.state.transientRetries}getmodelRetryCount(){return this.state.attempt}mapErrorTypeDelays(e){return{connection_dropped:e.connectionDropped,fetch_error:e.fetchError,econnreset:e.econnreset,econnrefused:e.econnrefused,sse_aborted:e.sseAborted,no_bytes:e.noBytes,partial_chunks:e.partialChunks,runtime_killed:e.runtimeKilled,background_throttle:e.backgroundThrottle,dns_error:e.dnsError,timeout:e.timeout,unknown:e.unknown}}};function Gt(t){return new Z(t)}function It(t){return new Z().categorizeError(t).retryable}function _t(t){return new Z().categorizeError(t).category}function Ee(t){return!(!t||t.length===0||t.trim().length===0||/^[\r\n\t\s]+$/.test(t))}function Ge(t,e,n={}){if(!t||!e||t.length===0||e.length===0)return{overlapLength:0,overlapText:"",deduplicatedContinuation:e||"",hasOverlap:!1};let{minOverlap:r=2,maxOverlap:o=Math.min(500,e.length),caseSensitive:a=!0,normalizeWhitespace:s=!1}=n,l=t,c=e;a||(l=t.toLowerCase(),c=e.toLowerCase()),s&&(l=l.replace(/\s+/g," "),c=c.replace(/\s+/g," "));let u=Math.min(l.length,c.length,o);if(u<r)return{overlapLength:0,overlapText:"",deduplicatedContinuation:e,hasOverlap:!1};for(let m=u;m>=r;m--){let C=l.slice(-m),se=c.slice(0,m);if(C===se){let k=m;if(s){let j=0,S=0,le=c.slice(0,m);for(;j<le.length&&S<e.length;)if(/\s/.test(e[S]))if(le[j]===" ")for(j++,S++;S<e.length&&/\s/.test(e[S]);)S++;else S++;else j++,S++;k=S}return{overlapLength:k,overlapText:e.slice(0,k),deduplicatedContinuation:e.slice(k),hasOverlap:!0}}}return{overlapLength:0,overlapText:"",deduplicatedContinuation:e,hasOverlap:!1}}function ot(t){if(!t||t.length===0||!Ee(t))return!0;let e=t.trim();return!!(e.length<3||/^[^\w\s]+$/.test(e)||/^(.)\1+$/.test(e))}function Ie(t){if(!t)return{type:"error",error:new Error("Received null or undefined chunk"),timestamp:Date.now()};if(Mt(t))return t;if(t.type)switch(t.type){case"text-delta":case"content-delta":return{type:"token",value:t.textDelta||t.delta||t.content||"",timestamp:Date.now()};case"finish":case"complete":return{type:"complete",timestamp:Date.now()};case"error":return{type:"error",error:t.error||new Error(t.message||"Stream error"),timestamp:Date.now()};case"tool-call":case"function-call":return{type:"message",value:JSON.stringify(t),role:"assistant",timestamp:Date.now()};default:let n=it(t);return n?{type:"token",value:n,timestamp:Date.now()}:{type:"error",error:new Error(`Unknown chunk type: ${t.type}`),timestamp:Date.now()}}if(t.choices&&Array.isArray(t.choices)){let n=t.choices[0];if(n?.delta?.content)return{type:"token",value:n.delta.content,timestamp:Date.now()};if(n?.finish_reason)return{type:"complete",timestamp:Date.now()}}if(t.delta?.text)return{type:"token",value:t.delta.text,timestamp:Date.now()};if(t.type==="message_stop"||t.type==="content_block_stop")return{type:"complete",timestamp:Date.now()};if(typeof t=="string")return{type:"token",value:t,timestamp:Date.now()};let e=it(t);return e?{type:"token",value:e,timestamp:Date.now()}:{type:"error",error:new Error(`Unable to normalize chunk: ${JSON.stringify(t)}`),timestamp:Date.now()}}function Mt(t){return t&&typeof t=="object"&&"type"in t&&(t.type==="token"||t.type==="message"||t.type==="data"||t.type==="progress"||t.type==="error"||t.type==="complete")}function it(t){if(!t||typeof t!="object")return null;let e=["text","content","delta","textDelta","token","message","data"];for(let n of e)if(t[n]&&typeof t[n]=="string")return t[n];if(t.delta&&typeof t.delta=="object"){for(let n of e)if(t.delta[n]&&typeof t.delta[n]=="string")return t.delta[n]}return null}function Pt(t){return{type:"token",value:t,timestamp:Date.now()}}function Ft(){return{type:"complete",timestamp:Date.now()}}function Vt(t){return{type:"error",error:t,timestamp:Date.now()}}function at(){return{content:"",checkpoint:"",tokenCount:0,modelRetryCount:0,networkRetryCount:0,fallbackIndex:0,violations:[],driftDetected:!1,completed:!1,networkErrors:[],resumed:!1,dataOutputs:[]}}function q(t,e={}){t.content="",t.tokenCount=0,t.violations=[],t.driftDetected=!1,t.dataOutputs=[],t.lastProgress=void 0,t.completed=!1,t.networkErrors=[],e.checkpoint!==void 0&&(t.checkpoint=e.checkpoint),e.resumed!==void 0&&(t.resumed=e.resumed),e.resumePoint!==void 0&&(t.resumePoint=e.resumePoint),e.resumeFrom!==void 0&&(t.resumeFrom=e.resumeFrom),e.modelRetryCount!==void 0&&(t.modelRetryCount=e.modelRetryCount),e.networkRetryCount!==void 0&&(t.networkRetryCount=e.networkRetryCount),e.fallbackIndex!==void 0&&(t.fallbackIndex=e.fallbackIndex)}function _e(t,e,n){let r={skipContinuation:!1,violations:[],driftDetected:!1,driftTypes:[]};if(e){let o={content:t,checkpoint:"",delta:t,tokenCount:1,completed:!0},a=e.check(o);a.violations.length>0&&(r.violations=a.violations,a.violations.some(l=>l.severity==="fatal")&&(r.skipContinuation=!0))}if(!r.skipContinuation&&n){let o=n.check(t);o.detected&&(r.driftDetected=!0,r.driftTypes=o.types)}return r}function M(t,e,n,r="callback"){if(t)try{t(e)}catch(o){n?.logEvent({type:"warning",message:`${r} threw: ${o instanceof Error?o.message:String(o)}`})}}var T={INIT:"init",WAITING_FOR_TOKEN:"waiting_for_token",STREAMING:"streaming",CONTINUATION_MATCHING:"continuation_matching",CHECKPOINT_VERIFYING:"checkpoint_verifying",RETRYING:"retrying",FALLBACK:"fallback",FINALIZING:"finalizing",COMPLETE:"complete",ERROR:"error"},re=class{state=T.INIT;history=[];listeners=new Set;transition(e){this.state!==e&&(this.history.push({from:this.state,to:e,timestamp:Date.now()}),this.state=e,this.notify())}get(){return this.state}is(...e){return e.includes(this.state)}isTerminal(){return this.state===T.COMPLETE||this.state===T.ERROR}reset(){let e=this.state;this.state=T.INIT,this.history=[],e!==T.INIT&&this.notify()}getHistory(){return this.history}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){for(let e of this.listeners)try{e(this.state)}catch{}}};var ne=class{requests=0;tokens=0;retries=0;networkRetryCount=0;errors=0;violations=0;driftDetections=0;fallbacks=0;completions=0;timeouts=0;reset(){this.requests=0,this.tokens=0,this.retries=0,this.networkRetryCount=0,this.errors=0,this.violations=0,this.driftDetections=0,this.fallbacks=0,this.completions=0,this.timeouts=0}snapshot(){return{requests:this.requests,tokens:this.tokens,retries:this.retries,networkRetryCount:this.networkRetryCount,errors:this.errors,violations:this.violations,driftDetections:this.driftDetections,fallbacks:this.fallbacks,completions:this.completions,timeouts:this.timeouts}}toJSON(){return this.snapshot()}};async function st(t){for await(let e of t.stream);return t.state.content}async function lt(t,e){for await(let n of t.stream)n.type==="token"&&n.value&&e(n.value);return t.state.content}var ut=null,ct=null,dt=null,ke=null;async function $t(t){let{signal:e,interceptors:n=[]}=t,r=null,o=t;if(n.length>0){if(!dt)throw new w('Interceptors require enableInterceptors() to be called first. Import and call: import { enableInterceptors } from "@ai2070/l0"; enableInterceptors();',{code:"FEATURE_NOT_ENABLED",recoverable:!1});r=dt(n);try{o=await r.executeBefore(t)}catch(y){let _=y instanceof Error?y:new Error(String(y));throw await r.executeError(_,t),_}}let{stream:a,fallbackStreams:s=[],guardrails:l=[],retry:c={},timeout:u={},signal:m,monitoring:C,detectDrift:se=!1,detectZeroTokens:k=!0,checkIntervals:j={},onStart:S,onComplete:le,onError:Fe,onEvent:P,onViolation:U,onRetry:X,onFallback:Ve,onResume:pe,continueFromLastKnownGoodToken:fe=!1,buildContinuationPrompt:ye,deduplicateContinuation:Et,deduplicationOptions:z={}}=o,$e=Et??fe,Be=j.guardrails??5,Ue=j.drift??10,ze=j.checkpoint??10,i=at(),xe=[],Ke=new AbortController,He=m||e||Ke.signal,f=null;if(C?.enabled){if(!ct)throw new w('Monitoring requires enableMonitoring() to be called first. Import and call: import { enableMonitoring } from "@ai2070/l0"; enableMonitoring();',{code:"FEATURE_NOT_ENABLED",recoverable:!1});f=ct({enabled:!0,sampleRate:C?.sampleRate??1,includeNetworkDetails:C?.includeNetworkDetails??!0,includeTimings:C?.includeTimings??!0,metadata:C?.metadata}),f.start(),f.recordContinuation(fe,!1)}let I=l.length>0?new te({rules:l,stopOnFatal:!0,enableStreaming:!0,onViolation:U}):null,we=new Z({attempts:c.attempts??2,maxRetries:c.maxRetries,baseDelay:c.baseDelay??1e3,maxDelay:c.maxDelay??1e4,backoff:c.backoff??"fixed-jitter",retryOn:c.retryOn??["zero_output","guardrail_violation","drift","incomplete","network_error","timeout","rate_limit","server_error"]}),A=null;if(se){if(!ut)throw new w('Drift detection requires enableDriftDetection() to be called first. Import and call: import { enableDriftDetection } from "@ai2070/l0"; enableDriftDetection();',{code:"FEATURE_NOT_ENABLED",recoverable:!1});A=ut()}let O=new re,F=new ne;F.requests++;let Ce={stream:async function*(){let y=0,_=[a,...s],D=[],R="",V="",Q=!1;for(;y<_.length;){let kt=_[y],L=0,Le=!1,De=c.attempts??2;for(i.fallbackIndex=y;L<=De;){if(O.transition(T.INIT),S){let E=L>0||Le,g=y>0;S(L+1,E,g)}try{if(L>0||Le)if(fe&&i.checkpoint.length>0){R=i.checkpoint,O.transition(T.CHECKPOINT_VERIFYING);let h=_e(R,I,A);if(h.violations.length>0&&(i.violations.push(...h.violations),f?.recordGuardrailViolations(h.violations)),h.driftDetected&&(i.driftDetected=!0,f?.recordDrift(!0,h.driftTypes),U&&U({rule:"drift",severity:"warning",message:`Drift detected in checkpoint: ${h.driftTypes.join(", ")}`,recoverable:!0})),h.skipContinuation){D=[],q(i);continue}i.resumed=!0,i.resumePoint=R,i.resumeFrom=R.length,V="",Q=!1,pe&&pe(R,i.tokenCount),ye&&ye(R),f?.recordContinuation(!0,!0,R);let p={type:"token",value:R,timestamp:Date.now()};M(P,p,f,"onEvent"),yield p,D=[R],i.content=R,i.tokenCount=1,q(i,{checkpoint:i.checkpoint,resumed:!0,resumePoint:R,resumeFrom:R.length}),i.content=R,i.tokenCount=1}else D=[],q(i);let E=await kt(),g;if(o.adapter){let h;if(typeof o.adapter=="string"){if(!ke)throw new w('String adapter names require enableAdapterRegistry() to be called first. Import and call: import { enableAdapterRegistry } from "@ai2070/l0"; enableAdapterRegistry();',{code:"FEATURE_NOT_ENABLED",recoverable:!1});if(h=ke.getAdapter(o.adapter),!h)throw new w(`Adapter "${o.adapter}" not found. Use registerAdapter() to register it first.`,{code:"ADAPTER_NOT_FOUND",modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:!1})}else h=o.adapter;g=h.wrap(E,o.adapterOptions)}else if(E.textStream)g=E.textStream;else if(E.fullStream)g=E.fullStream;else if(ke?.hasMatchingAdapter(E))g=ke.detectAdapter(E).wrap(E,o.adapterOptions);else if(Symbol.asyncIterator in E)g=E;else throw new w("Invalid stream result - no iterable stream found and no adapter matched. Use explicit `adapter: myAdapter` or register an adapter with detect().",{code:"INVALID_STREAM",modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:!0});let $=Date.now();i.firstTokenAt=void 0,i.lastTokenAt=void 0;let v=!1;O.transition(T.WAITING_FOR_TOKEN);let ee=$,ge=5e3,he=u.initialToken??ge,x=null,G=!1;He?.aborted||(x=setTimeout(()=>{G=!0},he));for await(let h of g){if(He?.aborted)throw new w("Stream aborted by signal",{code:"STREAM_ABORTED",checkpoint:i.checkpoint,tokenCount:i.tokenCount,contentLength:i.content.length,modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:i.checkpoint.length>0});if(v){let b=u.interToken??1e4,B=Date.now()-ee;if(B>b)throw F.timeouts++,new w("Inter-token timeout reached",{code:"INTER_TOKEN_TIMEOUT",checkpoint:i.checkpoint,tokenCount:i.tokenCount,contentLength:i.content.length,modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:i.checkpoint.length>0,metadata:{timeout:b,timeSinceLastToken:B}})}if(x&&!v&&(clearTimeout(x),x=null,G=!1),G&&!v)throw F.timeouts++,new w("Initial token timeout reached",{code:"INITIAL_TOKEN_TIMEOUT",checkpoint:i.checkpoint,tokenCount:0,contentLength:0,modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:!0,metadata:{timeout:u.initialToken??ge}});let p;try{p=Ie(h)}catch(b){let B=b instanceof Error?b.message:String(b);f?.logEvent({type:"warning",message:`Failed to normalize stream chunk: ${B}`,chunk:typeof h=="object"?JSON.stringify(h):h});continue}if(p.type==="token"&&p.value){let b=p.value;if(v||(v=!0,i.firstTokenAt=Date.now(),O.transition(T.STREAMING)),F.tokens++,i.resumed&&$e&&R.length>0&&!Q){V.length===0&&O.transition(T.CONTINUATION_MATCHING),V+=b;let H=Ge(R,V,{minOverlap:z.minOverlap??2,maxOverlap:z.maxOverlap??500,caseSensitive:z.caseSensitive??!0,normalizeWhitespace:z.normalizeWhitespace??!1}),W=z.maxOverlap??500;if(H.hasOverlap&&H.deduplicatedContinuation.length>0||V.length>W)if(Q=!0,O.transition(T.STREAMING),H.hasOverlap){if(b=H.deduplicatedContinuation,b.length===0)continue}else b=V;else continue}if(D.push(b),i.tokenCount++,i.lastTokenAt=Date.now(),(I&&i.tokenCount%Be===0||A&&i.tokenCount%Ue===0||i.tokenCount%ze===0)&&(i.content=D.join("")),f?.recordToken(i.lastTokenAt),i.tokenCount%ze===0&&(i.checkpoint=i.content),I&&i.tokenCount%Be===0){let H={content:i.content,checkpoint:i.checkpoint,delta:b,tokenCount:i.tokenCount,completed:!1},W=I.check(H);if(W.violations.length>0&&(i.violations.push(...W.violations),f?.recordGuardrailViolations(W.violations)),W.shouldHalt)throw new w(`Fatal guardrail violation: ${W.violations[0]?.message}`,{code:"FATAL_GUARDRAIL_VIOLATION",checkpoint:i.checkpoint,tokenCount:i.tokenCount,contentLength:i.content.length,modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:!1,metadata:{violation:W.violations[0]}})}if(A&&i.tokenCount%Ue===0){let H=A.check(i.content,b);H.detected&&(i.driftDetected=!0,f?.recordDrift(!0,H.types))}let K={type:"token",value:b,timestamp:Date.now()};M(P,K,f,"onEvent"),yield K,ee=Date.now()}else if(p.type==="message"){let b={type:"message",value:p.value,role:p.role,timestamp:Date.now()};M(P,b,f,"onEvent"),yield b}else if(p.type==="data"){p.data&&i.dataOutputs.push(p.data);let b={type:"data",data:p.data,timestamp:Date.now()};M(P,b,f,"onEvent"),yield b}else if(p.type==="progress"){i.lastProgress=p.progress;let b={type:"progress",progress:p.progress,timestamp:Date.now()};M(P,b,f,"onEvent"),yield b}else{if(p.type==="error")throw p.error||new Error("Stream error");if(p.type==="complete")break}}if(x&&clearTimeout(x),i.resumed&&$e&&!Q&&V.length>0){let h=Ge(R,V,{minOverlap:z.minOverlap??2,maxOverlap:z.maxOverlap??500,caseSensitive:z.caseSensitive??!0,normalizeWhitespace:z.normalizeWhitespace??!1}),p;if(h.hasOverlap?p=h.deduplicatedContinuation:p=V,p.length>0){if(D.push(p),i.tokenCount++,i.content=D.join(""),I){let B={content:i.content,checkpoint:i.checkpoint,delta:p,tokenCount:i.tokenCount,completed:!1},K=I.check(B);if(K.violations.length>0&&(i.violations.push(...K.violations),f?.recordGuardrailViolations(K.violations)),K.shouldHalt)throw new w(`Fatal guardrail violation: ${K.violations[0]?.message}`,{code:"FATAL_GUARDRAIL_VIOLATION",checkpoint:i.checkpoint,tokenCount:i.tokenCount,contentLength:i.content.length,modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:!1,metadata:{violation:K.violations[0]}})}if(A){let B=A.check(i.content,p);B.detected&&(i.driftDetected=!0,f?.recordDrift(!0,B.types))}let b={type:"token",value:p,timestamp:Date.now()};M(P,b,f,"onEvent"),yield b}Q=!0}if(i.content=D.join(""),k&&ot(i.content))throw new w("Zero output detected - no meaningful content",{code:"ZERO_OUTPUT",checkpoint:i.checkpoint,tokenCount:i.tokenCount,contentLength:i.content.length,modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:!0});if(I){let h={content:i.content,checkpoint:i.checkpoint,tokenCount:i.tokenCount,completed:!0},p=I.check(h);if(p.violations.length>0&&(i.violations.push(...p.violations),f?.recordGuardrailViolations(p.violations)),p.shouldRetry&&L<De){let b=p.violations[0];X&&X(L+1,`Guardrail violation: ${b?.message}`),L++,i.modelRetryCount++;continue}if(p.shouldHalt)throw new w(`Fatal guardrail violation: ${p.violations[0]?.message}`,{code:"FATAL_GUARDRAIL_VIOLATION",checkpoint:i.checkpoint,tokenCount:i.tokenCount,contentLength:i.content.length,modelRetryCount:i.modelRetryCount,networkRetryCount:i.networkRetryCount,fallbackIndex:y,recoverable:!1,metadata:{violation:p.violations[0]}})}if(A){let h=A.check(i.content);if(h.detected&&L<De){i.driftDetected=!0,f?.recordDrift(!0,h.types),X&&X(L+1,"Drift detected"),f?.recordRetry(!1),L++,i.modelRetryCount++;continue}}O.transition(T.FINALIZING),i.completed=!0,f?.complete(),F.completions++,i.firstTokenAt&&(i.duration=Date.now()-i.firstTokenAt);let ue={type:"complete",timestamp:Date.now()};M(P,ue,f,"onEvent"),yield ue,O.transition(T.COMPLETE),le&&le(i);break}catch(E){let g=E instanceof Error?E:new Error(String(E));if(xe.push(g),I&&i.tokenCount>0){D.length>0&&(i.content=D.join(""));let x={content:i.content,checkpoint:i.checkpoint,delta:"",tokenCount:i.tokenCount,completed:!1},G=I.check(x);if(G.violations.length>0){i.violations.push(...G.violations),f?.recordGuardrailViolations(G.violations);for(let h of G.violations)U&&U(h);G.violations.some(h=>h.severity==="fatal")&&(i.checkpoint="")}!G.violations.some(ue=>ue.severity==="fatal")&&i.content.length>0&&(i.checkpoint=i.content)}if(A&&i.tokenCount>0){D.length>0&&(i.content=D.join(""));let x=A.check(i.content);x.detected&&(i.driftDetected=!0,f?.recordDrift(!0,x.types),U&&U({rule:"drift",severity:"warning",message:`Drift detected in partial stream: ${x.types.join(", ")}`,recoverable:!0}))}let $=we.categorizeError(g),v=we.shouldRetry(g);if(c.shouldRetry){let x=c.shouldRetry(g,{attempt:L,totalAttempts:L+i.networkRetryCount,category:$.category,reason:$.reason,content:i.content,tokenCount:i.tokenCount});x===!0?v={...v,shouldRetry:!0}:x===!1&&(v={...v,shouldRetry:!1})}if(c.calculateDelay&&v.shouldRetry){let x=c.calculateDelay({attempt:L,totalAttempts:L+i.networkRetryCount,category:$.category,reason:$.reason,error:g,defaultDelay:v.delay});typeof x=="number"&&(v={...v,delay:x})}let ee=J(g);if(ee&&f?.recordNetworkError(g,v.shouldRetry,v.delay),Fe){let x=v.shouldRetry,G=!v.shouldRetry&&y<_.length-1;Fe(g,x,G)}if(v.shouldRetry){v.countsTowardLimit?(L++,i.modelRetryCount++):i.networkRetryCount++,Le=!0,O.transition(T.RETRYING),F.retries++,ee&&F.networkRetryCount++,f?.recordRetry(ee),X&&X(L,v.reason),await we.recordRetry($,v);continue}if(y<_.length-1)break;let ge=g instanceof w?g.category:"internal",he={type:"error",error:g,reason:ge,timestamp:Date.now()};throw M(P,he,f,"onEvent"),yield he,await r?.executeError(g,o),O.transition(T.ERROR),F.errors++,g}}if(!i.completed)if(y<_.length-1){y++,O.transition(T.FALLBACK),F.fallbacks++;let E=`Retries exhausted for stream ${y}, falling back to stream ${y+1}`;if(f?.logEvent({type:"fallback",message:E,fromIndex:y-1,toIndex:y}),Ve&&Ve(y-1,E),fe&&i.checkpoint.length>0){R=i.checkpoint,O.transition(T.CHECKPOINT_VERIFYING);let g=_e(R,I,A);if(g.violations.length>0&&(i.violations.push(...g.violations),f?.recordGuardrailViolations(g.violations)),g.driftDetected&&(i.driftDetected=!0,f?.recordDrift(!0,g.driftTypes),U&&U({rule:"drift",severity:"warning",message:`Drift detected in checkpoint: ${g.driftTypes.join(", ")}`,recoverable:!0})),g.skipContinuation)D=[],q(i,{fallbackIndex:y});else{i.resumed=!0,i.resumePoint=R,i.resumeFrom=R.length,V="",Q=!1,pe&&pe(R,i.tokenCount),ye&&ye(R),f?.recordContinuation(!0,!0,R);let $={type:"token",value:R,timestamp:Date.now()};M(P,$,f,"onEvent"),yield $,D=[R],q(i,{checkpoint:i.checkpoint,resumed:!0,resumePoint:R,resumeFrom:R.length,fallbackIndex:y}),i.content=R,i.tokenCount=1}}else D=[],q(i,{fallbackIndex:y});continue}else{let E=new Error(`All streams exhausted (primary + ${s.length} fallbacks)`);xe.push(E);let g={type:"error",error:E,reason:"internal",timestamp:Date.now()};throw M(P,g,f,"onEvent"),yield g,await r?.executeError(E,o),O.transition(T.ERROR),F.errors++,E}break}}(),state:i,errors:xe,telemetry:f?.export(),abort:()=>Ke.abort()};if(r)try{Ce=await r.executeAfter(Ce)}catch(y){let _=y instanceof Error?y:new Error(String(y));throw await r.executeError(_,o),_}return Ce}function Bt(t){let e=0,n=0,r=0,o=0,a=!1,s=!1,l=[];for(let u=0;u<t.length;u++){let m=t[u];if(s){s=!1;continue}if(m==="\\"){s=!0;continue}if(m==='"'){a=!a;continue}a||(m==="{"&&e++,m==="}"&&n++,m==="["&&r++,m==="]"&&o++)}return a&&l.push("Unclosed string detected"),e!==n&&l.push(`Unbalanced braces: ${e} open, ${n} close`),r!==o&&l.push(`Unbalanced brackets: ${r} open, ${o} close`),{openBraces:e,closeBraces:n,openBrackets:r,closeBrackets:o,inString:a,isBalanced:e===n&&r===o&&!a,issues:l}}function ve(t){if(!t)return!1;let e=t.trim();return e.startsWith("{")||e.startsWith("[")}function Ut(t){let{content:e,completed:n}=t,r=[];if(!ve(e))return r;let o=Bt(e);if(!n)o.closeBraces>o.openBraces&&r.push({rule:"json-structure",message:`Too many closing braces: ${o.closeBraces} close, ${o.openBraces} open`,severity:"error",recoverable:!0}),o.closeBrackets>o.openBrackets&&r.push({rule:"json-structure",message:`Too many closing brackets: ${o.closeBrackets} close, ${o.openBrackets} open`,severity:"error",recoverable:!0});else if(!o.isBalanced)for(let a of o.issues)r.push({rule:"json-structure",message:a,severity:"error",recoverable:!0,suggestion:"Retry generation to get properly balanced JSON"});return r}function zt(t){let{content:e,delta:n}=t,r=[];if(!n||!ve(e))return r;let o=[{pattern:/,,+/,message:"Multiple consecutive commas"},{pattern:/\{\s*,/,message:"Comma immediately after opening brace"},{pattern:/\[\s*,/,message:"Comma immediately after opening bracket"},{pattern:/:\s*,/,message:"Comma immediately after colon"}];for(let{pattern:a,message:s}of o)a.test(e)&&r.push({rule:"json-chunks",message:`Malformed JSON: ${s}`,severity:"error",recoverable:!0});return r}function mt(t){let{content:e,completed:n}=t,r=[];if(!n||!ve(e))return r;try{JSON.parse(e.trim())}catch(o){r.push({rule:"json-parseable",message:`JSON is not parseable: ${o instanceof Error?o.message:"Unknown error"}`,severity:"error",recoverable:!0,suggestion:"Retry generation to get valid JSON"})}return r}function oe(){return{name:"json-structure",description:"Validates JSON structure and balance",streaming:!0,severity:"error",recoverable:!0,check:t=>{let e=[];return e.push(...Ut(t)),e.push(...zt(t)),t.completed&&e.push(...mt(t)),e}}}function Kt(){return{name:"json-strict",description:"Strict JSON validation including structure and parseability",streaming:!1,severity:"error",recoverable:!0,check:t=>{let e=[];if(!t.completed)return e;let{content:n}=t;if(!ve(n))return e.push({rule:"json-strict",message:"Content does not appear to be JSON (must start with { or [)",severity:"error",recoverable:!0}),e;if(e.push(...mt(t)),e.length===0)try{let r=JSON.parse(n.trim());(typeof r!="object"||r===null)&&e.push({rule:"json-strict",message:"JSON root must be an object or array",severity:"error",recoverable:!0})}catch{}return e}}}var Ht=/^(#{1,6})\s+/,jt=/^(\s*)([-*+]|\d+\.)\s+/,Wt=/^\|?[\s-:|]+\|[\s-:|]*$/,pt=/\|/g,Jt=/^(\s*)([-*+])\s+/,Zt=/^(\s*)(\d+)\.\s+/,Yt=/^\s*$/,qt=/[.!?;:\]})"`']$/,Xt=/^#{1,6}\s+/,Qt=/^[-*+]\s+/,er=/^\d+\.\s+/,tr=[/^#{1,6}\s+/m,/```/,/^\s*[-*+]\s+/m,/^\s*\d+\.\s+/m,/\*\*.*\*\*/,/\*.*\*/,/\[.*\]\(.*\)/,/^>\s+/m];function ft(t){let e=[],n=t.split(`
`),r=[],o=[],a=0,s=!1,l=0;for(let c=0;c<n.length;c++){let u=n[c];if(u.trimStart().startsWith("```"))if(s=!s,s){a++;let m=u.trim().slice(3).trim();m&&r.push(m)}else a--;if(!s){let m=u.match(Ht);m&&m[1]&&o.push(m[1].length);let C=u.match(jt);if(C&&C[1]!==void 0){let se=C[1].length,k=Math.floor(se/2)+1;l=Math.max(l,k)}}}return(s||a!==0)&&e.push(`Unbalanced code fences: ${Math.abs(a)} unclosed`),{openFences:Math.max(0,a),fenceLanguages:r,inFence:s,headers:o,listDepth:l,issues:e}}function rr(t){return t?tr.some(e=>e.test(t)):!1}function nr(t){let{content:e,completed:n}=t,r=[],o=ft(e);return!n&&o.inFence?o.openFences>5&&r.push({rule:"markdown-fences",message:`Excessive unclosed code fences: ${o.openFences}`,severity:"warning",recoverable:!0}):n&&o.openFences!==0&&r.push({rule:"markdown-fences",message:`Unclosed code fences: ${o.openFences} fence(s) not closed`,severity:"error",recoverable:!0,suggestion:"Retry generation to properly close code fences"}),r}function or(t){let{content:e,completed:n}=t,r=[];if(!n)return r;let o=e.split(`
`),a=!1,s=0;for(let l=0;l<o.length;l++){let c=o[l];if(Wt.test(c)){a=!0,s=(c.match(pt)||[]).length;continue}if(a)if(c.includes("|")){let u=(c.match(pt)||[]).length;u!==s&&r.push({rule:"markdown-tables",message:`Inconsistent table columns at line ${l+1}: expected ${s}, got ${u}`,severity:"warning",recoverable:!0})}else c.trim().length>0&&(a=!1)}return r}function ir(t){let{content:e,completed:n}=t,r=[];if(!n)return r;let o=e.split(`
`),a=null,s=-1;for(let l=0;l<o.length;l++){let c=o[l],u=c.match(Jt);if(u&&u[1]!==void 0){let C=u[1].length;a==="ordered"&&s===C&&r.push({rule:"markdown-lists",message:`Mixed list types at line ${l+1}: switching from ordered to unordered at same level`,severity:"warning",recoverable:!0}),a="unordered",s=C;continue}let m=c.match(Zt);if(m&&m[1]!==void 0){let C=m[1].length;a==="unordered"&&s===C&&r.push({rule:"markdown-lists",message:`Mixed list types at line ${l+1}: switching from unordered to ordered at same level`,severity:"warning",recoverable:!0}),a="ordered",s=C;continue}c.trim().length>0&&!Yt.test(c)&&(a=null,s=-1)}return r}function ar(t){let{content:e,completed:n}=t,r=[];if(!n)return r;let o=ft(e);o.inFence&&r.push({rule:"markdown-complete",message:"Content ends inside code fence",severity:"error",recoverable:!0,suggestion:"Retry to complete the code fence"});let s=e.trim().split(`
`),l=s[s.length-1]??"";return!o.inFence&&l.trim().length>0&&!qt.test(l)&&!Xt.test(l)&&!Qt.test(l)&&!er.test(l)&&r.push({rule:"markdown-complete",message:"Content appears to end abruptly mid-sentence",severity:"warning",recoverable:!0}),r}function me(){return{name:"markdown-structure",description:"Validates Markdown fences, blocks, and structure",streaming:!0,severity:"error",recoverable:!0,check:t=>{let e=[];return!rr(t.content)&&t.content.length>50||(e.push(...nr(t)),t.completed&&(e.push(...or(t)),e.push(...ir(t)),e.push(...ar(t)))),e}}}var yt=/\\begin\{(\w+)\}/g,gt=/\\end\{(\w+)\}/g,ht=/\\\[/g,bt=/\\\]/g,Rt=/\$\$/g,sr=[/\\begin\{/,/\\end\{/,/\\\[/,/\\\]/,/\$\$/,/\\[a-zA-Z]+\{/,/\\section/,/\\subsection/,/\\textbf/,/\\textit/,/\\frac/,/\\sum/,/\\int/];function lr(t){let e=[],n=[],r=[];yt.lastIndex=0,gt.lastIndex=0;let o=[],a=[],s;for(;(s=yt.exec(t))!==null;)o.push({env:s[1],pos:s.index});for(;(s=gt.exec(t))!==null;)a.push({env:s[1],pos:s.index});let l=[...o.map(u=>({...u,type:"begin"})),...a.map(u=>({...u,type:"end"}))].sort((u,m)=>u.pos-m.pos);for(let u of l)if(u.type==="begin")r.push(u.env);else if(r.length===0)e.push(`\\end{${u.env}} without matching \\begin{${u.env}}`);else{let m=r[r.length-1];m===u.env||e.push(`Environment mismatch: \\begin{${m}} closed with \\end{${u.env}}`),r.pop()}for(let u of r)n.push(u),e.push(`Unclosed environment: \\begin{${u}}`);let c=r.length===0&&e.length===0;return{openEnvironments:n,isBalanced:c,issues:e}}function Te(t){return t?sr.some(e=>e.test(t)):!1}function ur(t){let{content:e,completed:n}=t,r=[];if(!Te(e))return r;let o=lr(e);if(n){if(!o.isBalanced)for(let a of o.issues)r.push({rule:"latex-environments",message:a,severity:"error",recoverable:!0,suggestion:"Retry generation to properly balance LaTeX environments"})}else{let a=o.issues.filter(s=>s.includes("mismatch"));for(let s of a)r.push({rule:"latex-environments",message:s,severity:"error",recoverable:!0});o.openEnvironments.length>5&&r.push({rule:"latex-environments",message:`Excessive unclosed environments: ${o.openEnvironments.length}`,severity:"warning",recoverable:!0})}return r}function cr(t){let{content:e,completed:n}=t,r=[];if(!Te(e))return r;ht.lastIndex=0,bt.lastIndex=0,Rt.lastIndex=0;let o=(e.match(ht)||[]).length,a=(e.match(bt)||[]).length,s=(e.match(Rt)||[]).length,l=0,c=!1;for(let u=0;u<e.length;u++){if(c){c=!1;continue}if(e[u]==="\\"){c=!0;continue}e[u]==="$"&&(u+1>=e.length||e[u+1]!=="$")&&l++}return n&&(o!==a&&r.push({rule:"latex-math",message:`Unbalanced display math: ${o} \\[ and ${a} \\]`,severity:"error",recoverable:!0,suggestion:"Ensure all \\[ have matching \\]"}),s%2!==0&&r.push({rule:"latex-math",message:`Unbalanced $$ delimiters: ${s} found (should be even)`,severity:"error",recoverable:!0,suggestion:"Ensure all $$ are paired"}),l%2!==0&&r.push({rule:"latex-math",message:`Unbalanced inline math: ${l} $ found (should be even)`,severity:"warning",recoverable:!0,suggestion:"Check inline math delimiters"})),r}function dr(t){let{content:e,completed:n}=t,r=[];if(!Te(e)||!n)return r;let o=/\\[a-zA-Z]+/g,a;for(;(a=o.exec(e))!==null;){let s=e.slice(a.index+a[0].length);if(s.startsWith("{")){let l=0,c=!1;for(let u=0;u<s.length;u++)if(s[u]==="{"&&l++,s[u]==="}"&&(l--,l===0)){c=!0;break}!c&&l>0&&r.push({rule:"latex-common",message:`Unclosed braces after command ${a[0]}`,severity:"warning",recoverable:!0})}}return r}function Me(){return{name:"latex-environments",description:"Validates LaTeX environment balance and structure",streaming:!0,severity:"error",recoverable:!0,check:t=>{let e=[];return!Te(t.content)&&t.content.length>50||(e.push(...ur(t)),e.push(...cr(t)),t.completed&&e.push(...dr(t))),e}}}var ie={META_COMMENTARY:[/as an ai language model/i,/as an ai assistant/i,/i'm an ai/i,/i am an ai/i,/i don't have personal/i,/i cannot actually/i,/i apologize, but i/i,/i'm sorry, but i/i],EXCESSIVE_HEDGING:[/^sure!?\s*$/im,/^certainly!?\s*$/im,/^of course!?\s*$/im,/^absolutely!?\s*$/im],REFUSAL:[/i cannot provide/i,/i'm not able to/i,/i can't assist with/i,/i'm unable to/i,/that would be inappropriate/i],INSTRUCTION_LEAK:[/\[system\]/i,/\[user\]/i,/\[assistant\]/i,/<\|im_start\|>/i,/<\|im_end\|>/i,/###\s*instruction/i,/###\s*system/i],PLACEHOLDERS:[/\[insert .+?\]/i,/\[todo:?\]/i,/\[placeholder\]/i,/\[your .+? here\]/i,/\{\{.+?\}\}/],FORMAT_COLLAPSE:[/here is the .+?:/i,/here's the .+?:/i,/let me .+? for you/i,/i'll .+? for you/i]};function ae(t,e){let n=[];for(let r of e){let o=t.match(r);o&&n.push({pattern:r,match:o[0],index:o.index??0})}return n}function mr(t){let{content:e}=t,n=[],r=ae(e,ie.META_COMMENTARY);for(let o of r)n.push({rule:"pattern-meta-commentary",message:`Meta commentary detected: "${o.match}"`,severity:"error",position:o.index,recoverable:!0,suggestion:"Retry generation without meta commentary"});return n}function pr(t){let{content:e}=t,n=[],r=e.trim().split(`
`)[0]??"",o=ae(r,ie.EXCESSIVE_HEDGING);return o.length>0&&o[0]&&n.push({rule:"pattern-hedging",message:`Excessive hedging at start: "${o[0].match}"`,severity:"warning",position:o[0].index,recoverable:!0,suggestion:"Content should start directly without hedging"}),n}function fr(t){let{content:e}=t,n=[],r=ae(e,ie.REFUSAL);for(let o of r)n.push({rule:"pattern-refusal",message:`Refusal pattern detected: "${o.match}"`,severity:"error",position:o.index,recoverable:!1,suggestion:"Model refused to complete the task"});return n}function yr(t){let{content:e}=t,n=[],r=ae(e,ie.INSTRUCTION_LEAK);for(let o of r)n.push({rule:"pattern-instruction-leak",message:`Instruction leakage detected: "${o.match}"`,severity:"error",position:o.index,recoverable:!0,suggestion:"Retry generation without system tokens"});return n}function gr(t){let{content:e,completed:n}=t,r=[];if(!n)return r;let o=ae(e,ie.PLACEHOLDERS);for(let a of o)r.push({rule:"pattern-placeholders",message:`Placeholder detected: "${a.match}"`,severity:"error",position:a.index,recoverable:!0,suggestion:"Output contains incomplete placeholders"});return r}function hr(t){let{content:e}=t,n=[],r=e.split(`
`).slice(0,3).join(`
`),o=ae(r,ie.FORMAT_COLLAPSE);return o.length>0&&o[0]&&n.push({rule:"pattern-format-collapse",message:`Format collapse detected: "${o[0].match}"`,severity:"warning",position:o[0].index,recoverable:!0,suggestion:"Output should not mix meta-instructions with content"}),n}function br(t,e=2){let{content:n,completed:r}=t,o=[];if(!r)return o;let a=n.split(/[.!?]+/).map(l=>l.trim().toLowerCase()).filter(l=>l.length>20),s=new Map;for(let l of a)s.set(l,(s.get(l)||0)+1);for(let[l,c]of s.entries())c>e&&o.push({rule:"pattern-repetition",message:`Sentence repeated ${c} times: "${l.slice(0,50)}..."`,severity:"error",recoverable:!0,suggestion:"Content contains repeated sentences"});return o}function Rr(t){let{content:e,completed:n}=t,r=[];if(!n||e.length<100)return r;let o=e.split(/[.!?]+/).map(l=>l.trim()).filter(l=>l.length>10);if(o.length<2)return r;let a=o[0].toLowerCase(),s=o[o.length-1].toLowerCase();return a===s&&r.push({rule:"pattern-first-last-duplicate",message:"First and last sentences are identical",severity:"error",recoverable:!0,suggestion:"Retry generation - possible loop detected"}),r}function Pe(t){return{name:"pattern-detection",description:"Detects known bad patterns in model output",streaming:!1,severity:"error",recoverable:!0,check:e=>{let n=[];return n.push(...mr(e)),n.push(...pr(e)),n.push(...fr(e)),n.push(...yr(e)),n.push(...gr(e)),n.push(...hr(e)),n.push(...br(e)),n.push(...Rr(e)),n}}}var Er=/^[^\w\s]+$/,kr=/^(.)\1+$/,vr=/[a-zA-Z0-9]/;function Tr(t){return!t||t.length===0?!0:!Ee(t)}function xr(t){if(!t||t.length===0)return!0;let e=t.trim();return!!(Er.test(e)||kr.test(e)||e.length<3&&!vr.test(e))}function wr(t){let{content:e,completed:n,tokenCount:r}=t,o=[];return!n&&r<5?o:Tr(e)?(o.push({rule:"zero-output",message:"No meaningful output generated (empty or whitespace only)",severity:"error",recoverable:!1,suggestion:"Retry - likely network or model initialization issue"}),o):xr(e)?(o.push({rule:"zero-output",message:"Output contains only noise or filler characters",severity:"error",recoverable:!1,suggestion:"Retry - output is not meaningful"}),o):(n&&e.trim().length<10&&o.push({rule:"zero-output",message:`Output too short: ${e.trim().length} characters`,severity:"warning",recoverable:!1,suggestion:"Retry - output may be truncated"}),o)}function Cr(t){let{completed:e,tokenCount:n,metadata:r}=t,o=[];if(!e)return o;let a=r?.startTime,s=r?.endTime;if(a&&s){let l=s-a;l<100&&n<5&&o.push({rule:"zero-output",message:`Stream completed instantly (${l}ms) with minimal output`,severity:"error",recoverable:!1,suggestion:"Retry - possible network or transport failure"})}return o}function Y(){return{name:"zero-output",description:"Detects zero or meaningless output",streaming:!0,severity:"error",recoverable:!1,check:t=>{let e=[];return e.push(...wr(t)),e.push(...Cr(t)),e}}}var Lr=[oe(),Y()],Dr=[oe(),me(),Y(),Pe()],Or=[oe(),me(),Me(),Pe(),Y()],Nr=[oe(),Y()],Nn=[me(),Y()],Sn=[Me(),Y()];var Sr={attempts:2,maxRetries:4,backoff:"linear",baseDelay:d.baseDelay,maxDelay:d.maxDelay,retryOn:[...d.retryOn]},Ar={attempts:d.attempts,maxRetries:d.maxRetries,backoff:d.backoff,baseDelay:d.baseDelay,maxDelay:d.maxDelay,retryOn:[...d.retryOn]},Gr={attempts:d.attempts,maxRetries:d.maxRetries,backoff:"full-jitter",baseDelay:d.baseDelay,maxDelay:d.maxDelay,retryOn:[...d.retryOn]},Ir={attempts:4,maxRetries:8,backoff:"exponential",baseDelay:d.baseDelay,maxDelay:d.maxDelay,retryOn:[...d.retryOn]};export{ce as ErrorCategory,te as GuardrailEngine,w as L0Error,ne as Metrics,Se as NetworkErrorType,d as RETRY_DEFAULTS,Z as RetryManager,T as RuntimeStates,re as StateMachine,de as analyzeNetworkError,vt as checkGuardrails,lt as consumeStream,Ft as createCompleteEvent,Vt as createErrorEvent,je as createGuardrailEngine,Gt as createRetryManager,Pt as createTokenEvent,Ir as exponentialRetry,_t as getErrorCategory,st as getText,Nt as isL0Error,J as isNetworkError,It as isRetryableError,Nr as jsonOnlyGuardrails,oe as jsonRule,$t as l0,me as markdownRule,Lr as minimalGuardrails,Sr as minimalRetry,Ie as normalizeStreamEvent,Dr as recommendedGuardrails,Ar as recommendedRetry,Ne as sleep,Or as strictGuardrails,Kt as strictJsonRule,Gr as strictRetry,Dt as withTimeout,Y as zeroOutputRule};
