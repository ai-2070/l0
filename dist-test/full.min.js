var Cs=Object.defineProperty;var Rs=(t,e)=>{for(var r in e)Cs(t,r,{get:e[r],enumerable:!0})};var Tt=class{rules;config;state;constructor(e){this.rules=e.rules||[],this.config={stopOnFatal:!0,enableStreaming:!0,checkInterval:100,...e},this.state=this.createInitialState()}createInitialState(){return{violations:[],violationsByRule:new Map,hasFatalViolations:!1,hasErrorViolations:!1,violationCount:0}}check(e){let r=[],n=Date.now();for(let s of this.rules)if(!(s.streaming&&!this.config.enableStreaming&&!e.completed)&&!(!s.streaming&&!e.completed))try{let i=s.check({...e,previousViolations:this.state.violations});for(let a of i)r.push({...a,timestamp:n});if(i.length>0){let a=this.state.violationsByRule.get(s.name)||[];this.state.violationsByRule.set(s.name,[...a,...i])}if(this.config.stopOnFatal&&i.some(a=>a.severity==="fatal"))break}catch(i){r.push({rule:s.name,message:`Rule execution failed: ${i instanceof Error?i.message:"Unknown error"}`,severity:"warning",recoverable:!0,timestamp:n})}if(this.state.violations.push(...r),this.state.violationCount=this.state.violations.length,this.state.hasFatalViolations=r.some(s=>s.severity==="fatal"),this.state.hasErrorViolations=r.some(s=>s.severity==="error"),this.state.lastCheckTime=n,this.config.onViolation)for(let s of r)this.config.onViolation(s);return{passed:r.length===0,violations:r,shouldRetry:this.shouldRetry(r),shouldHalt:this.shouldHalt(r),summary:{total:r.length,fatal:r.filter(s=>s.severity==="fatal").length,errors:r.filter(s=>s.severity==="error").length,warnings:r.filter(s=>s.severity==="warning").length}}}shouldRetry(e){return e.some(r=>r.recoverable&&(r.severity==="error"||r.severity==="fatal"))}shouldHalt(e){return!!(e.some(r=>r.severity==="fatal")||e.some(r=>!r.recoverable&&r.severity==="error"))}getState(){return{...this.state}}reset(){this.state=this.createInitialState()}addRule(e){this.rules.push(e)}removeRule(e){let r=this.rules.findIndex(n=>n.name===e);return r!==-1?(this.rules.splice(r,1),!0):!1}getViolationsByRule(e){return this.state.violationsByRule.get(e)||[]}getAllViolations(){return[...this.state.violations]}hasViolations(){return this.state.violationCount>0}hasFatalViolations(){return this.state.hasFatalViolations}hasErrorViolations(){return this.state.hasErrorViolations}};function Hn(t,e){return new Tt({rules:t,...e})}function _s(t,e){return Hn(e).check(t)}var _={attempts:3,maxRetries:6,baseDelay:1e3,maxDelay:1e4,networkMaxDelay:3e4,backoff:"fixed-jitter",retryOn:["zero_output","guardrail_violation","drift","incomplete","network_error","timeout","rate_limit","server_error"]},pe={connectionDropped:1e3,fetchError:500,econnreset:1e3,econnrefused:2e3,sseAborted:500,noBytes:500,partialChunks:500,runtimeKilled:2e3,backgroundThrottle:5e3,dnsError:3e3,timeout:1e3,unknown:1e3},Jt=(a=>(a.NETWORK="network",a.TRANSIENT="transient",a.MODEL="model",a.CONTENT="content",a.PROVIDER="provider",a.FATAL="fatal",a.INTERNAL="internal",a))(Jt||{});function Yr(t,e=_.baseDelay,r=_.maxDelay){let n=e*Math.pow(2,t);return{delay:Math.min(n,r),cappedAtMax:n>r,rawDelay:n}}function Kn(t,e=_.baseDelay,r=_.maxDelay){let n=e*(t+1);return{delay:Math.min(n,r),cappedAtMax:n>r,rawDelay:n}}function Yn(t=_.baseDelay){return{delay:t,cappedAtMax:!1,rawDelay:t}}function Xn(t=_.baseDelay,e=_.maxDelay){let r=Math.random()*t*.5,n=t+r;return{delay:Math.min(Math.floor(n),e),cappedAtMax:n>e,rawDelay:n}}function Qn(t,e=_.baseDelay,r=_.maxDelay){let n=e*Math.pow(2,t),o=Math.min(n,r),s=Math.random()*o;return{delay:Math.floor(s),cappedAtMax:n>r,rawDelay:s}}function cr(t,e,r=_.baseDelay,n=_.maxDelay){switch(t){case"exponential":return Yr(e,r,n);case"linear":return Kn(e,r,n);case"fixed":return Yn(r);case"full-jitter":return Qn(e,r,n);case"fixed-jitter":return Xn(r,n);default:return Yr(e,r,n)}}function Qr(t){return new Promise(e=>setTimeout(e,t))}function eo(t,e="Timeout"){return new Promise((r,n)=>{setTimeout(()=>n(new Error(e)),t)})}async function Os(t,e,r){return Promise.race([t,eo(e,r)])}var Xr=class{startTime;endTime;pauseTime;totalPausedTime=0;start(){this.startTime=Date.now(),this.endTime=void 0,this.pauseTime=void 0,this.totalPausedTime=0}pause(){!this.startTime||this.pauseTime||(this.pauseTime=Date.now())}resume(){this.pauseTime&&(this.totalPausedTime+=Date.now()-this.pauseTime,this.pauseTime=void 0)}stop(){this.startTime&&(this.pauseTime&&this.resume(),this.endTime=Date.now())}elapsed(){if(!this.startTime)return 0;let e=this.endTime??Date.now(),r=this.pauseTime?this.totalPausedTime+(Date.now()-this.pauseTime):this.totalPausedTime;return e-this.startTime-r}reset(){this.startTime=void 0,this.endTime=void 0,this.pauseTime=void 0,this.totalPausedTime=0}isRunning(){return!!this.startTime&&!this.endTime&&!this.pauseTime}isPaused(){return!!this.pauseTime}};function As(t){switch(t){case"NETWORK_ERROR":return"network";case"INITIAL_TOKEN_TIMEOUT":case"INTER_TOKEN_TIMEOUT":return"transient";case"GUARDRAIL_VIOLATION":case"FATAL_GUARDRAIL_VIOLATION":case"DRIFT_DETECTED":case"ZERO_OUTPUT":return"content";case"INVALID_STREAM":case"ADAPTER_NOT_FOUND":case"FEATURE_NOT_ENABLED":return"internal";case"STREAM_ABORTED":case"ALL_STREAMS_EXHAUSTED":default:return"provider"}}var re=class t extends Error{code;context;timestamp;constructor(e,r){super(e),this.name="L0Error",this.code=r.code,this.context=r,this.timestamp=Date.now(),Object.setPrototypeOf(this,t.prototype)}get category(){return As(this.code)}get isRecoverable(){return this.context.recoverable===!0&&this.context.checkpoint!==void 0&&this.context.checkpoint.length>0}getCheckpoint(){return this.context.checkpoint}toDetailedString(){let e=[this.message];return this.context.tokenCount!==void 0&&e.push(`Tokens: ${this.context.tokenCount}`),this.context.modelRetryCount!==void 0&&e.push(`Retries: ${this.context.modelRetryCount}`),this.context.fallbackIndex!==void 0&&this.context.fallbackIndex>0&&e.push(`Fallback: ${this.context.fallbackIndex}`),this.context.checkpoint&&e.push(`Checkpoint: ${this.context.checkpoint.length} chars`),e.join(" | ")}toJSON(){return{name:this.name,code:this.code,category:this.category,message:this.message,timestamp:this.timestamp,recoverable:this.isRecoverable,checkpoint:this.context.checkpoint?this.context.checkpoint.length:void 0,tokenCount:this.context.tokenCount,modelRetryCount:this.context.modelRetryCount,networkRetryCount:this.context.networkRetryCount,fallbackIndex:this.context.fallbackIndex}}};function Ls(t){return t instanceof re}function Ds(t){return"code"in t&&typeof t.code=="string"}function lr(t){return Ds(t)?t.code:void 0}var en=(m=>(m.CONNECTION_DROPPED="connection_dropped",m.FETCH_ERROR="fetch_error",m.ECONNRESET="econnreset",m.ECONNREFUSED="econnrefused",m.SSE_ABORTED="sse_aborted",m.NO_BYTES="no_bytes",m.PARTIAL_CHUNKS="partial_chunks",m.RUNTIME_KILLED="runtime_killed",m.BACKGROUND_THROTTLE="background_throttle",m.DNS_ERROR="dns_error",m.SSL_ERROR="ssl_error",m.TIMEOUT="timeout",m.UNKNOWN="unknown",m))(en||{});function tn(t){let e=t.message.toLowerCase();return e.includes("connection dropped")||e.includes("connection closed")||e.includes("connection lost")||e.includes("connection reset")||e.includes("econnreset")||e.includes("pipe broken")||e.includes("broken pipe")}function rn(t){return t.name==="TypeError"&&(t.message.toLowerCase().includes("fetch")||t.message.toLowerCase().includes("failed to fetch")||t.message.toLowerCase().includes("network request failed"))}function nn(t){let e=t.message.toLowerCase();return e.includes("econnreset")||e.includes("connection reset by peer")||lr(t)==="ECONNRESET"}function on(t){let e=t.message.toLowerCase();return e.includes("econnrefused")||e.includes("connection refused")||lr(t)==="ECONNREFUSED"}function sn(t){let e=t.message.toLowerCase();return e.includes("sse")||e.includes("server-sent events")||e.includes("stream")&&e.includes("abort")||e.includes("stream aborted")||e.includes("eventstream")||t.name==="AbortError"}function an(t){let e=t.message.toLowerCase();return e.includes("no bytes")||e.includes("empty response")||e.includes("zero bytes")||e.includes("no data received")||e.includes("content-length: 0")}function dr(t){let e=t.message.toLowerCase();return e.includes("partial chunk")||e.includes("incomplete chunk")||e.includes("truncated")||e.includes("premature close")||e.includes("unexpected end of data")||e.includes("incomplete data")}function un(t){let e=t.message.toLowerCase();return e.includes("worker")&&e.includes("terminated")||e.includes("runtime")&&e.includes("killed")||e.includes("edge runtime")||e.includes("lambda timeout")||e.includes("function timeout")||e.includes("execution timeout")||e.includes("worker died")||e.includes("process exited")||e.includes("sigterm")||e.includes("sigkill")}function cn(t){let e=t.message.toLowerCase();return e.includes("background")&&e.includes("suspend")||e.includes("background throttle")||e.includes("tab suspended")||e.includes("page hidden")||e.includes("visibility hidden")||e.includes("inactive tab")||e.includes("background tab")}function ln(t){let e=t.message.toLowerCase();return e.includes("dns")||e.includes("enotfound")||e.includes("name resolution")||e.includes("host not found")||e.includes("getaddrinfo")||lr(t)==="ENOTFOUND"}function to(t){let e=t.message.toLowerCase();return e.includes("ssl")||e.includes("tls")||e.includes("certificate")||e.includes("cert")||e.includes("handshake")||e.includes("self signed")||e.includes("unable to verify")}function Ut(t){let e=t.message.toLowerCase();return t.name==="TimeoutError"||e.includes("timeout")||e.includes("timed out")||e.includes("time out")||e.includes("deadline exceeded")||e.includes("etimedout")||lr(t)==="ETIMEDOUT"}function Ge(t){return tn(t)?{type:"connection_dropped",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with exponential backoff - connection was interrupted"}:rn(t)?{type:"fetch_error",retryable:!0,countsTowardLimit:!1,suggestion:"Retry immediately - fetch() failed to initiate"}:nn(t)?{type:"econnreset",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with backoff - connection was reset by peer"}:on(t)?{type:"econnrefused",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with longer delay - server refused connection",context:{possibleCause:"Server may be down or not accepting connections"}}:sn(t)?{type:"sse_aborted",retryable:!0,countsTowardLimit:!1,suggestion:"Retry immediately - SSE stream was aborted"}:an(t)?{type:"no_bytes",retryable:!0,countsTowardLimit:!1,suggestion:"Retry immediately - server sent no data",context:{possibleCause:"Empty response or connection closed before data sent"}}:dr(t)?{type:"partial_chunks",retryable:!0,countsTowardLimit:!1,suggestion:"Retry immediately - received incomplete data",context:{possibleCause:"Connection closed mid-stream"}}:un(t)?{type:"runtime_killed",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with shorter timeout - runtime was terminated (likely timeout)",context:{possibleCause:"Edge runtime timeout or Lambda timeout - consider breaking into smaller requests"}}:cn(t)?{type:"background_throttle",retryable:!0,countsTowardLimit:!1,suggestion:"Retry when page becomes visible - mobile/browser throttling",context:{possibleCause:"Browser suspended network activity for background tab",resolution:"Wait for visibilitychange event"}}:ln(t)?{type:"dns_error",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with longer delay - DNS lookup failed",context:{possibleCause:"Network connectivity issue or invalid hostname"}}:to(t)?{type:"ssl_error",retryable:!1,countsTowardLimit:!1,suggestion:"Don't retry - SSL/TLS error (configuration issue)",context:{possibleCause:"Certificate validation failed or SSL handshake error",resolution:"Check server certificate or SSL configuration"}}:Ut(t)?{type:"timeout",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with longer timeout - request timed out"}:{type:"unknown",retryable:!0,countsTowardLimit:!1,suggestion:"Retry with caution - unknown network error"}}function Pe(t){return tn(t)||rn(t)||nn(t)||on(t)||sn(t)||an(t)||dr(t)||un(t)||cn(t)||ln(t)||Ut(t)}function Ps(t){let e=Ge(t),r=`Network error: ${e.type}`;return e.context?.possibleCause&&(r+=` (${e.context.possibleCause})`),r}function Is(t,e){if(e>0&&Pe(t))return!0;let r=t.message.toLowerCase();return r.includes("stream interrupted")||r.includes("stream closed unexpectedly")||r.includes("connection lost mid-stream")||dr(t)&&e>0}function pr(t,e,r,n=_.networkMaxDelay){let o=Ge(t),s={connection_dropped:pe.connectionDropped,fetch_error:pe.fetchError,econnreset:pe.econnreset,econnrefused:pe.econnrefused,sse_aborted:pe.sseAborted,no_bytes:pe.noBytes,partial_chunks:pe.partialChunks,runtime_killed:pe.runtimeKilled,background_throttle:pe.backgroundThrottle,dns_error:pe.dnsError,ssl_error:0,timeout:pe.timeout,unknown:pe.unknown},i=r?.[o.type]??s[o.type];return i===0?0:Math.min(i*Math.pow(2,e),n)}var Ve=class{config;state;constructor(e={}){this.config={attempts:e.attempts??_.attempts,maxRetries:e.maxRetries??_.maxRetries,baseDelay:e.baseDelay??_.baseDelay,maxDelay:e.maxDelay??_.maxDelay,backoff:e.backoff??_.backoff,retryOn:e.retryOn??[..._.retryOn],maxErrorHistory:e.maxErrorHistory},this.state=this.createInitialState()}createInitialState(){return{attempt:0,networkRetryCount:0,transientRetries:0,errorHistory:[],totalDelay:0,limitReached:!1}}categorizeError(e,r){let n=this.classifyError(e),o=this.determineCategory(n),s=o==="model",i=o!=="fatal";return{error:e,category:o,reason:r??this.inferReason(n),countsTowardLimit:s,retryable:i,timestamp:Date.now(),statusCode:n.statusCode}}classifyError(e){let r=e.message?.toLowerCase()||"",n=Pe(e),o=Ut(e),s,i=r.match(/status\s*(?:code)?\s*:?\s*(\d{3})/i);i&&i[1]&&(s=parseInt(i[1],10));let a=s===429||r.includes("rate limit"),u=s!==void 0&&s>=500&&s<600,c=s===401||s===403||r.includes("unauthorized")||r.includes("forbidden"),l=s!==void 0&&s>=400&&s<500&&s!==429;return{isNetwork:n,isRateLimit:a,isServerError:u,isTimeout:o,isAuthError:c,isClientError:l,statusCode:s}}determineCategory(e){return e.isNetwork?"network":e.isRateLimit||e.isServerError||e.isTimeout?"transient":e.isAuthError||e.isClientError&&!e.isRateLimit?"fatal":"model"}inferReason(e,r){if(e.isNetwork){if(r)switch(Ge(r).type){case"connection_dropped":case"econnreset":case"econnrefused":case"sse_aborted":case"partial_chunks":case"no_bytes":return"network_error";case"runtime_killed":case"timeout":return"timeout";default:return"network_error"}return"network_error"}return e.isTimeout?"timeout":e.isRateLimit?"rate_limit":e.isServerError?"server_error":"unknown"}shouldRetry(e,r){let n=this.categorizeError(e,r);if(n.category==="network"&&Pe(e)){let i=Ge(e);if(!i.retryable)return{shouldRetry:!1,delay:0,reason:`Fatal network error: ${i.suggestion}`,category:"fatal",countsTowardLimit:!1}}if(n.category==="fatal")return{shouldRetry:!1,delay:0,reason:"Fatal error - not retryable",category:n.category,countsTowardLimit:!1};if(n.reason&&!this.config.retryOn.includes(n.reason))return{shouldRetry:!1,delay:0,reason:`Retry reason '${n.reason}' not in retryOn list`,category:n.category,countsTowardLimit:!1};if(this.config.maxRetries!==void 0&&this.getTotalRetries()>=this.config.maxRetries)return this.state.limitReached=!0,{shouldRetry:!1,delay:0,reason:`Absolute maximum retries (${this.config.maxRetries}) reached`,category:n.category,countsTowardLimit:!1};if(n.countsTowardLimit&&this.state.attempt>=this.config.attempts)return this.state.limitReached=!0,{shouldRetry:!1,delay:0,reason:"Maximum retry attempts reached",category:n.category,countsTowardLimit:!0};let o=n.countsTowardLimit?this.state.attempt:n.category==="network"?this.state.networkRetryCount:this.state.transientRetries,s;if(n.category==="network"&&this.config.errorTypeDelays&&Pe(e)){let i=this.mapErrorTypeDelays(this.config.errorTypeDelays),a=pr(e,o,i,this.config.maxDelay);s={delay:a,cappedAtMax:a>=(this.config.maxDelay??1e4),rawDelay:a}}else s=cr(this.config.backoff,o,this.config.baseDelay,this.config.maxDelay);return{shouldRetry:!0,delay:s.delay,reason:`Retrying after ${n.category} error`,category:n.category,countsTowardLimit:n.countsTowardLimit}}async recordRetry(e,r){r.countsTowardLimit?this.state.attempt++:e.category==="network"?this.state.networkRetryCount++:e.category==="transient"&&this.state.transientRetries++,this.state.lastError=e,this.state.errorHistory.push(e);let n=this.config.maxErrorHistory;n!==void 0&&this.state.errorHistory.length>n&&(this.state.errorHistory=this.state.errorHistory.slice(-n)),this.state.totalDelay+=r.delay,r.delay>0&&await Qr(r.delay)}async execute(e,r){for(;;)try{return await e()}catch(n){let o=n instanceof Error?n:new Error(String(n)),s=this.categorizeError(o),i=this.shouldRetry(o);if(!i.shouldRetry)throw o;let a=i.countsTowardLimit?this.state.attempt:s.category==="network"?this.state.networkRetryCount:this.state.transientRetries,u;if(s.category==="network"&&this.config.errorTypeDelays&&Pe(o)){let c=this.mapErrorTypeDelays(this.config.errorTypeDelays),l=pr(o,a,c,this.config.maxDelay);u={delay:l,cappedAtMax:l>=(this.config.maxDelay??1e4),rawDelay:l}}else u=cr(this.config.backoff,a,this.config.baseDelay,this.config.maxDelay);r&&r({state:this.getState(),config:this.config,error:s,backoff:u}),await this.recordRetry(s,i)}}getState(){return{...this.state}}reset(){this.state=this.createInitialState()}hasReachedLimit(){return this.state.limitReached}getTotalRetries(){return this.state.attempt+this.state.networkRetryCount+this.state.transientRetries}getmodelRetryCount(){return this.state.attempt}mapErrorTypeDelays(e){return{connection_dropped:e.connectionDropped,fetch_error:e.fetchError,econnreset:e.econnreset,econnrefused:e.econnrefused,sse_aborted:e.sseAborted,no_bytes:e.noBytes,partial_chunks:e.partialChunks,runtime_killed:e.runtimeKilled,background_throttle:e.backgroundThrottle,dns_error:e.dnsError,timeout:e.timeout,unknown:e.unknown}}};function Ns(t){return new Ve(t)}function Ms(t){return new Ve().categorizeError(t).retryable}function $s(t){return new Ve().categorizeError(t).category}function Fs(t){return!(!t||t.length===0||t.trim().length===0||/^[\r\n\t\s]+$/.test(t))}function Ce(t){return!(!t||t.length===0||t.trim().length===0||/^[\r\n\t\s]+$/.test(t))}function js(t){return!t||!Ce(t)?0:t.trim().split(/\s+/).filter(n=>n.length>0).length}function ro(t){return!t||!Ce(t)?[]:t.trim().split(/\s+/).filter(r=>r.length>0)}function Gs(t){return t.trim().toLowerCase()}function Vs(t,e=3){if(!t||!Ce(t))return[];let r=ro(t),n=[],o=new Map;for(let s of r){let i=Gs(s),a=(o.get(i)||0)+1;o.set(i,a),a===e&&n.push(s)}return n}function zs(t){if(!t||!Ce(t))return!1;let e=t.trim(),r=/[.!?;:]$/.test(e),n=/[)\]}]$/.test(e);return!r&&!n}function Wt(t,e,r={}){if(!t||!e||t.length===0||e.length===0)return{overlapLength:0,overlapText:"",deduplicatedContinuation:e||"",hasOverlap:!1};let{minOverlap:n=2,maxOverlap:o=Math.min(500,e.length),caseSensitive:s=!0,normalizeWhitespace:i=!1}=r,a=t,u=e;s||(a=t.toLowerCase(),u=e.toLowerCase()),i&&(a=a.replace(/\s+/g," "),u=u.replace(/\s+/g," "));let c=Math.min(a.length,u.length,o);if(c<n)return{overlapLength:0,overlapText:"",deduplicatedContinuation:e,hasOverlap:!1};for(let l=c;l>=n;l--){let p=a.slice(-l),h=u.slice(0,l);if(p===h){let m=l;if(i){let g=0,T=0,b=u.slice(0,l);for(;g<b.length&&T<e.length;)if(/\s/.test(e[T]))if(b[g]===" ")for(g++,T++;T<e.length&&/\s/.test(e[T]);)T++;else T++;else g++,T++;m=T}return{overlapLength:m,overlapText:e.slice(0,m),deduplicatedContinuation:e.slice(m),hasOverlap:!0}}}return{overlapLength:0,overlapText:"",deduplicatedContinuation:e,hasOverlap:!1}}function Bs(t,e,r={}){return Wt(t,e,r).deduplicatedContinuation}function mr(t){if(!t||t.length===0||!Ce(t))return!0;let e=t.trim();return!!(e.length<3||/^[^\w\s]+$/.test(e)||/^(.)\1+$/.test(e))}function Js(t,e){return e===0||e>0&&!Ce(t)||e>10&&t.trim().length<5}function no(t,e,r){let n=e-t;return n<100&&r<5||n<50}function Us(t,e,r,n){return mr(t)?e===0?{isZeroToken:!0,reason:"No tokens received - likely network or transport failure",category:"network"}:e>0&&t.trim().length===0?{isZeroToken:!0,reason:"Tokens received but no content - possible encoding issue",category:"encoding"}:{isZeroToken:!0,reason:"Only whitespace or noise characters received",category:"transport"}:r&&n&&no(r,n,e)?{isZeroToken:!0,reason:"Stream completed suspiciously fast - possible transport failure",category:"transport"}:{isZeroToken:!1,reason:"Valid output detected",category:"none"}}function fr(t){if(!t)return{type:"error",error:new Error("Received null or undefined chunk"),timestamp:Date.now()};if(Ws(t))return t;if(t.type)switch(t.type){case"text-delta":case"content-delta":return{type:"token",value:t.textDelta||t.delta||t.content||"",timestamp:Date.now()};case"finish":case"complete":return{type:"complete",timestamp:Date.now()};case"error":return{type:"error",error:t.error||new Error(t.message||"Stream error"),timestamp:Date.now()};case"tool-call":case"function-call":return{type:"message",value:JSON.stringify(t),role:"assistant",timestamp:Date.now()};default:let r=oo(t);return r?{type:"token",value:r,timestamp:Date.now()}:{type:"error",error:new Error(`Unknown chunk type: ${t.type}`),timestamp:Date.now()}}if(t.choices&&Array.isArray(t.choices)){let r=t.choices[0];if(r?.delta?.content)return{type:"token",value:r.delta.content,timestamp:Date.now()};if(r?.finish_reason)return{type:"complete",timestamp:Date.now()}}if(t.delta?.text)return{type:"token",value:t.delta.text,timestamp:Date.now()};if(t.type==="message_stop"||t.type==="content_block_stop")return{type:"complete",timestamp:Date.now()};if(typeof t=="string")return{type:"token",value:t,timestamp:Date.now()};let e=oo(t);return e?{type:"token",value:e,timestamp:Date.now()}:{type:"error",error:new Error(`Unable to normalize chunk: ${JSON.stringify(t)}`),timestamp:Date.now()}}function Ws(t){return t&&typeof t=="object"&&"type"in t&&(t.type==="token"||t.type==="message"||t.type==="data"||t.type==="progress"||t.type==="error"||t.type==="complete")}function oo(t){if(!t||typeof t!="object")return null;let e=["text","content","delta","textDelta","token","message","data"];for(let r of e)if(t[r]&&typeof t[r]=="string")return t[r];if(t.delta&&typeof t.delta=="object"){for(let r of e)if(t.delta[r]&&typeof t.delta[r]=="string")return t.delta[r]}return null}function Zs(t){return{type:"token",value:t,timestamp:Date.now()}}function qs(t,e){return{type:"message",value:t,role:e,timestamp:Date.now()}}function Hs(){return{type:"complete",timestamp:Date.now()}}function Ks(t){return{type:"error",error:t,timestamp:Date.now()}}function Ys(t){return t.map(e=>fr(e))}function Xs(t,e){return t.filter(r=>r.type===e)}function so(t){return t.filter(e=>e.type==="token"&&e.value).map(e=>e.value)}function Qs(t){return so(t).join("")}function io(){return{content:"",checkpoint:"",tokenCount:0,modelRetryCount:0,networkRetryCount:0,fallbackIndex:0,violations:[],driftDetected:!1,completed:!1,networkErrors:[],resumed:!1,dataOutputs:[]}}function Ke(t,e={}){t.content="",t.tokenCount=0,t.violations=[],t.driftDetected=!1,t.dataOutputs=[],t.lastProgress=void 0,t.completed=!1,t.networkErrors=[],e.checkpoint!==void 0&&(t.checkpoint=e.checkpoint),e.resumed!==void 0&&(t.resumed=e.resumed),e.resumePoint!==void 0&&(t.resumePoint=e.resumePoint),e.resumeFrom!==void 0&&(t.resumeFrom=e.resumeFrom),e.modelRetryCount!==void 0&&(t.modelRetryCount=e.modelRetryCount),e.networkRetryCount!==void 0&&(t.networkRetryCount=e.networkRetryCount),e.fallbackIndex!==void 0&&(t.fallbackIndex=e.fallbackIndex)}function dn(t,e,r){let n={skipContinuation:!1,violations:[],driftDetected:!1,driftTypes:[]};if(e){let o={content:t,checkpoint:"",delta:t,tokenCount:1,completed:!0},s=e.check(o);s.violations.length>0&&(n.violations=s.violations,s.violations.some(a=>a.severity==="fatal")&&(n.skipContinuation=!0))}if(!n.skipContinuation&&r){let o=r.check(t);o.detected&&(n.driftDetected=!0,n.driftTypes=o.types)}return n}function be(t,e,r,n="callback"){if(t)try{t(e)}catch(o){r?.logEvent({type:"warning",message:`${n} threw: ${o instanceof Error?o.message:String(o)}`})}}var Q={INIT:"init",WAITING_FOR_TOKEN:"waiting_for_token",STREAMING:"streaming",CONTINUATION_MATCHING:"continuation_matching",CHECKPOINT_VERIFYING:"checkpoint_verifying",RETRYING:"retrying",FALLBACK:"fallback",FINALIZING:"finalizing",COMPLETE:"complete",ERROR:"error"},Et=class{state=Q.INIT;history=[];listeners=new Set;transition(e){this.state!==e&&(this.history.push({from:this.state,to:e,timestamp:Date.now()}),this.state=e,this.notify())}get(){return this.state}is(...e){return e.includes(this.state)}isTerminal(){return this.state===Q.COMPLETE||this.state===Q.ERROR}reset(){let e=this.state;this.state=Q.INIT,this.history=[],e!==Q.INIT&&this.notify()}getHistory(){return this.history}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){for(let e of this.listeners)try{e(this.state)}catch{}}};var wt=class{requests=0;tokens=0;retries=0;networkRetryCount=0;errors=0;violations=0;driftDetections=0;fallbacks=0;completions=0;timeouts=0;reset(){this.requests=0,this.tokens=0,this.retries=0,this.networkRetryCount=0,this.errors=0,this.violations=0,this.driftDetections=0,this.fallbacks=0,this.completions=0,this.timeouts=0}snapshot(){return{requests:this.requests,tokens:this.tokens,retries:this.retries,networkRetryCount:this.networkRetryCount,errors:this.errors,violations:this.violations,driftDetections:this.driftDetections,fallbacks:this.fallbacks,completions:this.completions,timeouts:this.timeouts}}toJSON(){return this.snapshot()}};async function ao(t){for await(let e of t.stream);return t.state.content}async function uo(t,e){for await(let r of t.stream)r.type==="token"&&r.value&&e(r.value);return t.state.content}var pn=null,mn=null,fn=null,Zt=null;function co(t){pn=t}function lo(t){mn=t}function po(t){fn=t}function mo(t){Zt=t}async function ue(t){let{signal:e,interceptors:r=[]}=t,n=null,o=t;if(r.length>0){if(!fn)throw new re('Interceptors require enableInterceptors() to be called first. Import and call: import { enableInterceptors } from "@ai2070/l0"; enableInterceptors();',{code:"FEATURE_NOT_ENABLED",recoverable:!1});n=fn(r);try{o=await n.executeBefore(t)}catch($){let xe=$ instanceof Error?$:new Error(String($));throw await n.executeError(xe,t),xe}}let{stream:s,fallbackStreams:i=[],guardrails:a=[],retry:u={},timeout:c={},signal:l,monitoring:p,detectDrift:h=!1,detectZeroTokens:m=!0,checkIntervals:g={},onStart:T,onComplete:b,onError:R,onEvent:M,onViolation:z,onRetry:W,onFallback:C,onResume:E,continueFromLastKnownGoodToken:x=!1,buildContinuationPrompt:D,deduplicateContinuation:te,deduplicationOptions:K={}}=o,se=te??x,ie=g.guardrails??5,ne=g.drift??10,Z=g.checkpoint??10,d=io(),X=[],le=new AbortController,xt=l||e||le.signal,A=null;if(p?.enabled){if(!mn)throw new re('Monitoring requires enableMonitoring() to be called first. Import and call: import { enableMonitoring } from "@ai2070/l0"; enableMonitoring();',{code:"FEATURE_NOT_ENABLED",recoverable:!1});A=mn({enabled:!0,sampleRate:p?.sampleRate??1,includeNetworkDetails:p?.includeNetworkDetails??!0,includeTimings:p?.includeTimings??!0,metadata:p?.metadata}),A.start(),A.recordContinuation(x,!1)}let j=a.length>0?new Tt({rules:a,stopOnFatal:!0,enableStreaming:!0,onViolation:z}):null,q=new Ve({attempts:u.attempts??2,maxRetries:u.maxRetries,baseDelay:u.baseDelay??1e3,maxDelay:u.maxDelay??1e4,backoff:u.backoff??"fixed-jitter",retryOn:u.retryOn??["zero_output","guardrail_violation","drift","incomplete","network_error","timeout","rate_limit","server_error"]}),G=null;if(h){if(!pn)throw new re('Drift detection requires enableDriftDetection() to be called first. Import and call: import { enableDriftDetection } from "@ai2070/l0"; enableDriftDetection();',{code:"FEATURE_NOT_ENABLED",recoverable:!1});G=pn()}let N=new Et,B=new wt;B.requests++;let He={stream:async function*(){let $=0,xe=[s,...i],de=[],U="",Ee="",bt=!1;for(;$<xe.length;){let Ss=xe[$],ae=0,Hr=!1,Kr=u.attempts??2;for(d.fallbackIndex=$;ae<=Kr;){if(N.transition(Q.INIT),T){let H=ae>0||Hr,F=$>0;T(ae+1,H,F)}try{if(ae>0||Hr)if(x&&d.checkpoint.length>0){U=d.checkpoint,N.transition(Q.CHECKPOINT_VERIFYING);let V=dn(U,j,G);if(V.violations.length>0&&(d.violations.push(...V.violations),A?.recordGuardrailViolations(V.violations)),V.driftDetected&&(d.driftDetected=!0,A?.recordDrift(!0,V.driftTypes),z&&z({rule:"drift",severity:"warning",message:`Drift detected in checkpoint: ${V.driftTypes.join(", ")}`,recoverable:!0})),V.skipContinuation){de=[],Ke(d);continue}d.resumed=!0,d.resumePoint=U,d.resumeFrom=U.length,Ee="",bt=!1,E&&E(U,d.tokenCount),D&&D(U),A?.recordContinuation(!0,!0,U);let P={type:"token",value:U,timestamp:Date.now()};be(M,P,A,"onEvent"),yield P,de=[U],d.content=U,d.tokenCount=1,Ke(d,{checkpoint:d.checkpoint,resumed:!0,resumePoint:U,resumeFrom:U.length}),d.content=U,d.tokenCount=1}else de=[],Ke(d);let H=await Ss(),F;if(o.adapter){let V;if(typeof o.adapter=="string"){if(!Zt)throw new re('String adapter names require enableAdapterRegistry() to be called first. Import and call: import { enableAdapterRegistry } from "@ai2070/l0"; enableAdapterRegistry();',{code:"FEATURE_NOT_ENABLED",recoverable:!1});if(V=Zt.getAdapter(o.adapter),!V)throw new re(`Adapter "${o.adapter}" not found. Use registerAdapter() to register it first.`,{code:"ADAPTER_NOT_FOUND",modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:!1})}else V=o.adapter;F=V.wrap(H,o.adapterOptions)}else if(H.textStream)F=H.textStream;else if(H.fullStream)F=H.fullStream;else if(Zt?.hasMatchingAdapter(H))F=Zt.detectAdapter(H).wrap(H,o.adapterOptions);else if(Symbol.asyncIterator in H)F=H;else throw new re("Invalid stream result - no iterable stream found and no adapter matched. Use explicit `adapter: myAdapter` or register an adapter with detect().",{code:"INVALID_STREAM",modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:!0});let we=Date.now();d.firstTokenAt=void 0,d.lastTokenAt=void 0;let Y=!1;N.transition(Q.WAITING_FOR_TOKEN);let kt=we,ar=5e3,ur=c.initialToken??ar,ee=null,he=!1;xt?.aborted||(ee=setTimeout(()=>{he=!0},ur));for await(let V of F){if(xt?.aborted)throw new re("Stream aborted by signal",{code:"STREAM_ABORTED",checkpoint:d.checkpoint,tokenCount:d.tokenCount,contentLength:d.content.length,modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:d.checkpoint.length>0});if(Y){let J=c.interToken??1e4,Se=Date.now()-kt;if(Se>J)throw B.timeouts++,new re("Inter-token timeout reached",{code:"INTER_TOKEN_TIMEOUT",checkpoint:d.checkpoint,tokenCount:d.tokenCount,contentLength:d.content.length,modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:d.checkpoint.length>0,metadata:{timeout:J,timeSinceLastToken:Se}})}if(ee&&!Y&&(clearTimeout(ee),ee=null,he=!1),he&&!Y)throw B.timeouts++,new re("Initial token timeout reached",{code:"INITIAL_TOKEN_TIMEOUT",checkpoint:d.checkpoint,tokenCount:0,contentLength:0,modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:!0,metadata:{timeout:c.initialToken??ar}});let P;try{P=fr(V)}catch(J){let Se=J instanceof Error?J.message:String(J);A?.logEvent({type:"warning",message:`Failed to normalize stream chunk: ${Se}`,chunk:typeof V=="object"?JSON.stringify(V):V});continue}if(P.type==="token"&&P.value){let J=P.value;if(Y||(Y=!0,d.firstTokenAt=Date.now(),N.transition(Q.STREAMING)),B.tokens++,d.resumed&&se&&U.length>0&&!bt){Ee.length===0&&N.transition(Q.CONTINUATION_MATCHING),Ee+=J;let De=Wt(U,Ee,{minOverlap:K.minOverlap??2,maxOverlap:K.maxOverlap??500,caseSensitive:K.caseSensitive??!0,normalizeWhitespace:K.normalizeWhitespace??!1}),je=K.maxOverlap??500;if(De.hasOverlap&&De.deduplicatedContinuation.length>0||Ee.length>je)if(bt=!0,N.transition(Q.STREAMING),De.hasOverlap){if(J=De.deduplicatedContinuation,J.length===0)continue}else J=Ee;else continue}if(de.push(J),d.tokenCount++,d.lastTokenAt=Date.now(),(j&&d.tokenCount%ie===0||G&&d.tokenCount%ne===0||d.tokenCount%Z===0)&&(d.content=de.join("")),A?.recordToken(d.lastTokenAt),d.tokenCount%Z===0&&(d.checkpoint=d.content),j&&d.tokenCount%ie===0){let De={content:d.content,checkpoint:d.checkpoint,delta:J,tokenCount:d.tokenCount,completed:!1},je=j.check(De);if(je.violations.length>0&&(d.violations.push(...je.violations),A?.recordGuardrailViolations(je.violations)),je.shouldHalt)throw new re(`Fatal guardrail violation: ${je.violations[0]?.message}`,{code:"FATAL_GUARDRAIL_VIOLATION",checkpoint:d.checkpoint,tokenCount:d.tokenCount,contentLength:d.content.length,modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:!1,metadata:{violation:je.violations[0]}})}if(G&&d.tokenCount%ne===0){let De=G.check(d.content,J);De.detected&&(d.driftDetected=!0,A?.recordDrift(!0,De.types))}let Le={type:"token",value:J,timestamp:Date.now()};be(M,Le,A,"onEvent"),yield Le,kt=Date.now()}else if(P.type==="message"){let J={type:"message",value:P.value,role:P.role,timestamp:Date.now()};be(M,J,A,"onEvent"),yield J}else if(P.type==="data"){P.data&&d.dataOutputs.push(P.data);let J={type:"data",data:P.data,timestamp:Date.now()};be(M,J,A,"onEvent"),yield J}else if(P.type==="progress"){d.lastProgress=P.progress;let J={type:"progress",progress:P.progress,timestamp:Date.now()};be(M,J,A,"onEvent"),yield J}else{if(P.type==="error")throw P.error||new Error("Stream error");if(P.type==="complete")break}}if(ee&&clearTimeout(ee),d.resumed&&se&&!bt&&Ee.length>0){let V=Wt(U,Ee,{minOverlap:K.minOverlap??2,maxOverlap:K.maxOverlap??500,caseSensitive:K.caseSensitive??!0,normalizeWhitespace:K.normalizeWhitespace??!1}),P;if(V.hasOverlap?P=V.deduplicatedContinuation:P=Ee,P.length>0){if(de.push(P),d.tokenCount++,d.content=de.join(""),j){let Se={content:d.content,checkpoint:d.checkpoint,delta:P,tokenCount:d.tokenCount,completed:!1},Le=j.check(Se);if(Le.violations.length>0&&(d.violations.push(...Le.violations),A?.recordGuardrailViolations(Le.violations)),Le.shouldHalt)throw new re(`Fatal guardrail violation: ${Le.violations[0]?.message}`,{code:"FATAL_GUARDRAIL_VIOLATION",checkpoint:d.checkpoint,tokenCount:d.tokenCount,contentLength:d.content.length,modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:!1,metadata:{violation:Le.violations[0]}})}if(G){let Se=G.check(d.content,P);Se.detected&&(d.driftDetected=!0,A?.recordDrift(!0,Se.types))}let J={type:"token",value:P,timestamp:Date.now()};be(M,J,A,"onEvent"),yield J}bt=!0}if(d.content=de.join(""),m&&mr(d.content))throw new re("Zero output detected - no meaningful content",{code:"ZERO_OUTPUT",checkpoint:d.checkpoint,tokenCount:d.tokenCount,contentLength:d.content.length,modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:!0});if(j){let V={content:d.content,checkpoint:d.checkpoint,tokenCount:d.tokenCount,completed:!0},P=j.check(V);if(P.violations.length>0&&(d.violations.push(...P.violations),A?.recordGuardrailViolations(P.violations)),P.shouldRetry&&ae<Kr){let J=P.violations[0];W&&W(ae+1,`Guardrail violation: ${J?.message}`),ae++,d.modelRetryCount++;continue}if(P.shouldHalt)throw new re(`Fatal guardrail violation: ${P.violations[0]?.message}`,{code:"FATAL_GUARDRAIL_VIOLATION",checkpoint:d.checkpoint,tokenCount:d.tokenCount,contentLength:d.content.length,modelRetryCount:d.modelRetryCount,networkRetryCount:d.networkRetryCount,fallbackIndex:$,recoverable:!1,metadata:{violation:P.violations[0]}})}if(G){let V=G.check(d.content);if(V.detected&&ae<Kr){d.driftDetected=!0,A?.recordDrift(!0,V.types),W&&W(ae+1,"Drift detected"),A?.recordRetry(!1),ae++,d.modelRetryCount++;continue}}N.transition(Q.FINALIZING),d.completed=!0,A?.complete(),B.completions++,d.firstTokenAt&&(d.duration=Date.now()-d.firstTokenAt);let Bt={type:"complete",timestamp:Date.now()};be(M,Bt,A,"onEvent"),yield Bt,N.transition(Q.COMPLETE),b&&b(d);break}catch(H){let F=H instanceof Error?H:new Error(String(H));if(X.push(F),j&&d.tokenCount>0){de.length>0&&(d.content=de.join(""));let ee={content:d.content,checkpoint:d.checkpoint,delta:"",tokenCount:d.tokenCount,completed:!1},he=j.check(ee);if(he.violations.length>0){d.violations.push(...he.violations),A?.recordGuardrailViolations(he.violations);for(let V of he.violations)z&&z(V);he.violations.some(V=>V.severity==="fatal")&&(d.checkpoint="")}!he.violations.some(Bt=>Bt.severity==="fatal")&&d.content.length>0&&(d.checkpoint=d.content)}if(G&&d.tokenCount>0){de.length>0&&(d.content=de.join(""));let ee=G.check(d.content);ee.detected&&(d.driftDetected=!0,A?.recordDrift(!0,ee.types),z&&z({rule:"drift",severity:"warning",message:`Drift detected in partial stream: ${ee.types.join(", ")}`,recoverable:!0}))}let we=q.categorizeError(F),Y=q.shouldRetry(F);if(u.shouldRetry){let ee=u.shouldRetry(F,{attempt:ae,totalAttempts:ae+d.networkRetryCount,category:we.category,reason:we.reason,content:d.content,tokenCount:d.tokenCount});ee===!0?Y={...Y,shouldRetry:!0}:ee===!1&&(Y={...Y,shouldRetry:!1})}if(u.calculateDelay&&Y.shouldRetry){let ee=u.calculateDelay({attempt:ae,totalAttempts:ae+d.networkRetryCount,category:we.category,reason:we.reason,error:F,defaultDelay:Y.delay});typeof ee=="number"&&(Y={...Y,delay:ee})}let kt=Pe(F);if(kt&&A?.recordNetworkError(F,Y.shouldRetry,Y.delay),R){let ee=Y.shouldRetry,he=!Y.shouldRetry&&$<xe.length-1;R(F,ee,he)}if(Y.shouldRetry){Y.countsTowardLimit?(ae++,d.modelRetryCount++):d.networkRetryCount++,Hr=!0,N.transition(Q.RETRYING),B.retries++,kt&&B.networkRetryCount++,A?.recordRetry(kt),W&&W(ae,Y.reason),await q.recordRetry(we,Y);continue}if($<xe.length-1)break;let ar=F instanceof re?F.category:"internal",ur={type:"error",error:F,reason:ar,timestamp:Date.now()};throw be(M,ur,A,"onEvent"),yield ur,await n?.executeError(F,o),N.transition(Q.ERROR),B.errors++,F}}if(!d.completed)if($<xe.length-1){$++,N.transition(Q.FALLBACK),B.fallbacks++;let H=`Retries exhausted for stream ${$}, falling back to stream ${$+1}`;if(A?.logEvent({type:"fallback",message:H,fromIndex:$-1,toIndex:$}),C&&C($-1,H),x&&d.checkpoint.length>0){U=d.checkpoint,N.transition(Q.CHECKPOINT_VERIFYING);let F=dn(U,j,G);if(F.violations.length>0&&(d.violations.push(...F.violations),A?.recordGuardrailViolations(F.violations)),F.driftDetected&&(d.driftDetected=!0,A?.recordDrift(!0,F.driftTypes),z&&z({rule:"drift",severity:"warning",message:`Drift detected in checkpoint: ${F.driftTypes.join(", ")}`,recoverable:!0})),F.skipContinuation)de=[],Ke(d,{fallbackIndex:$});else{d.resumed=!0,d.resumePoint=U,d.resumeFrom=U.length,Ee="",bt=!1,E&&E(U,d.tokenCount),D&&D(U),A?.recordContinuation(!0,!0,U);let we={type:"token",value:U,timestamp:Date.now()};be(M,we,A,"onEvent"),yield we,de=[U],Ke(d,{checkpoint:d.checkpoint,resumed:!0,resumePoint:U,resumeFrom:U.length,fallbackIndex:$}),d.content=U,d.tokenCount=1}}else de=[],Ke(d,{fallbackIndex:$});continue}else{let H=new Error(`All streams exhausted (primary + ${i.length} fallbacks)`);X.push(H);let F={type:"error",error:H,reason:"internal",timestamp:Date.now()};throw be(M,F,A,"onEvent"),yield F,await n?.executeError(H,o),N.transition(Q.ERROR),B.errors++,H}break}}(),state:d,errors:X,telemetry:A?.export(),abort:()=>le.abort()};if(n)try{He=await n.executeAfter(He)}catch($){let xe=$ instanceof Error?$:new Error(String($));throw await n.executeError(xe,o),xe}return He}var Ye=class{config;history;constructor(e={}){this.config={detectToneShift:e.detectToneShift??!0,detectMetaCommentary:e.detectMetaCommentary??!0,detectRepetition:e.detectRepetition??!0,detectEntropySpike:e.detectEntropySpike??!0,repetitionThreshold:e.repetitionThreshold??3,entropyThreshold:e.entropyThreshold??2.5,entropyWindow:e.entropyWindow??50},this.history={entropy:[],tokens:[],lastContent:""}}check(e,r){let n=[],o=0,s=[];if(r&&(this.history.tokens.push(r),this.history.tokens.length>this.config.entropyWindow&&this.history.tokens.shift()),this.config.detectMetaCommentary&&this.detectMetaCommentary(e)&&(n.push("meta_commentary"),o=Math.max(o,.9),s.push("Meta commentary detected")),this.config.detectToneShift&&this.detectToneShift(e,this.history.lastContent)&&(n.push("tone_shift"),o=Math.max(o,.7),s.push("Tone shift detected")),this.config.detectRepetition&&this.detectRepetition(e)&&(n.push("repetition"),o=Math.max(o,.8),s.push("Excessive repetition detected")),this.config.detectEntropySpike&&r){let i=this.calculateEntropy(r);this.history.entropy.push(i),this.history.entropy.length>this.config.entropyWindow&&this.history.entropy.shift(),this.detectEntropySpike()&&(n.push("entropy_spike"),o=Math.max(o,.6),s.push("Entropy spike detected"))}return this.detectFormatCollapse(e)&&(n.push("format_collapse"),o=Math.max(o,.8),s.push("Format collapse detected")),this.detectMarkdownCollapse(e,this.history.lastContent)&&(n.push("markdown_collapse"),o=Math.max(o,.7),s.push("Markdown formatting collapse detected")),this.detectExcessiveHedging(e)&&(n.push("hedging"),o=Math.max(o,.5),s.push("Excessive hedging detected")),this.history.lastContent=e,{detected:n.length>0,confidence:o,types:n,details:s.join("; ")}}detectMetaCommentary(e){let r=[/as an ai/i,/i'm an ai/i,/i am an ai/i,/i cannot actually/i,/i don't have personal/i,/i apologize, but i/i,/i'm sorry, but i/i,/let me explain/i,/to clarify/i,/in other words/i],n=e.slice(-200);return r.some(o=>o.test(n))}detectToneShift(e,r){if(!r||r.length<100)return!1;let n=e.slice(-200),o=r.slice(-200),s=/\b(therefore|thus|hence|moreover|furthermore|consequently)\b/gi,i=(n.match(s)||[]).length,a=(o.match(s)||[]).length,u=/\b(gonna|wanna|yeah|yep|nope|ok|okay)\b/gi,c=(n.match(u)||[]).length,l=(o.match(u)||[]).length,p=Math.abs(i-a)>2,h=Math.abs(c-l)>2;return p||h}detectRepetition(e){let r=e.split(/[.!?]+/).map(i=>i.trim().toLowerCase()).filter(i=>i.length>20);if(r.length<3)return!1;let n=new Map;for(let i of r)n.set(i,(n.get(i)||0)+1);for(let i of n.values())if(i>=this.config.repetitionThreshold)return!0;let o=e.toLowerCase().split(/\s+/),s=new Map;for(let i=0;i<o.length-5;i++){let a=o.slice(i,i+5).join(" ");s.set(a,(s.get(a)||0)+1)}for(let i of s.values())if(i>=this.config.repetitionThreshold)return!0;return!1}calculateEntropy(e){if(!e||e.length===0)return 0;let r=new Map;for(let s of e)r.set(s,(r.get(s)||0)+1);let n=0,o=e.length;for(let s of r.values()){let i=s/o;n-=i*Math.log2(i)}return n}detectEntropySpike(){if(this.history.entropy.length<10)return!1;let e=this.history.entropy.reduce((s,i)=>s+i,0)/this.history.entropy.length,r=this.history.entropy.reduce((s,i)=>s+Math.pow(i-e,2),0)/this.history.entropy.length,n=Math.sqrt(r);return(this.history.entropy[this.history.entropy.length-1]??0)>e+this.config.entropyThreshold*n}detectFormatCollapse(e){let r=[/here is the .+?:/i,/here's the .+?:/i,/let me .+? for you/i,/i'll .+? for you/i,/here you go/i],n=e.slice(0,100);return r.some(o=>o.test(n))}detectMarkdownCollapse(e,r){if(!r||r.length<100)return!1;let n=[/```/g,/^#{1,6}\s/gm,/\*\*.*?\*\*/g,/\[.*?\]\(.*?\)/g],o=e.slice(-200),s=r.slice(-200),i=0,a=0;for(let u of n)i+=(o.match(u)||[]).length,a+=(s.match(u)||[]).length;return a>3&&i===0}detectExcessiveHedging(e){let r=[/^sure!?\s*$/im,/^certainly!?\s*$/im,/^of course!?\s*$/im,/^absolutely!?\s*$/im],n=e.trim().split(`
`)[0]??"";return r.some(o=>o.test(n))}reset(){this.history={entropy:[],tokens:[],lastContent:""}}getHistory(){return{...this.history}}};function ei(t){return new Ye(t)}function ti(t){return new Ye().check(t)}var ze=class{config;telemetry;tokenTimestamps=[];constructor(e={}){this.config={enabled:e.enabled??!1,sampleRate:e.sampleRate??1,includeNetworkDetails:e.includeNetworkDetails??!0,includeTimings:e.includeTimings??!0,metadata:e.metadata},this.telemetry=this.createInitialTelemetry()}isEnabled(){return this.config.enabled?Math.random()<this.config.sampleRate:!1}createInitialTelemetry(){return{sessionId:this.generateSessionId(),startTime:Date.now(),metrics:{totalTokens:0,totalRetries:0,networkRetryCount:0,modelRetryCount:0},network:{errorCount:0,errorsByType:{},errors:this.config.includeNetworkDetails?[]:void 0},metadata:this.config.metadata}}generateSessionId(){return`l0_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}start(){this.isEnabled()&&(this.telemetry.startTime=Date.now())}complete(){this.isEnabled()&&(this.telemetry.endTime=Date.now(),this.telemetry.duration=this.telemetry.endTime-this.telemetry.startTime,this.config.includeTimings&&this.tokenTimestamps.length>0&&this.calculateTimingMetrics())}recordToken(e){if(!this.isEnabled())return;let r=e??Date.now();this.telemetry.metrics.totalTokens++,this.config.includeTimings&&(this.tokenTimestamps.push(r),this.telemetry.metrics.totalTokens===1&&(this.telemetry.metrics.timeToFirstToken=r-this.telemetry.startTime))}recordNetworkError(e,r,n){if(!this.isEnabled())return;let s=Ge(e).type;this.telemetry.network.errorCount++,this.telemetry.network.errorsByType[s]=(this.telemetry.network.errorsByType[s]||0)+1,this.config.includeNetworkDetails&&this.telemetry.network.errors&&this.telemetry.network.errors.push({type:s,message:e.message,timestamp:Date.now(),retried:r,delay:n})}recordRetry(e){this.isEnabled()&&(this.telemetry.metrics.totalRetries++,e?this.telemetry.metrics.networkRetryCount++:this.telemetry.metrics.modelRetryCount++)}recordGuardrailViolations(e){if(this.isEnabled()){this.telemetry.guardrails||(this.telemetry.guardrails={violationCount:0,violationsByRule:{},violationsByRuleAndSeverity:{},violationsBySeverity:{warning:0,error:0,fatal:0}});for(let r of e){this.telemetry.guardrails.violationCount++,this.telemetry.guardrails.violationsByRule[r.rule]=(this.telemetry.guardrails.violationsByRule[r.rule]||0)+1,this.telemetry.guardrails.violationsByRuleAndSeverity[r.rule]||(this.telemetry.guardrails.violationsByRuleAndSeverity[r.rule]={warning:0,error:0,fatal:0});let n=this.telemetry.guardrails.violationsByRuleAndSeverity[r.rule];n&&n[r.severity]++,this.telemetry.guardrails.violationsBySeverity[r.severity]++}}}recordDrift(e,r){this.isEnabled()&&(this.telemetry.drift={detected:e,types:r})}recordContinuation(e,r,n){this.isEnabled()&&(this.telemetry.continuation||(this.telemetry.continuation={enabled:e,used:!1,continuationCount:0}),this.telemetry.continuation.enabled=e,r&&(this.telemetry.continuation.used=!0,this.telemetry.continuation.continuationCount=(this.telemetry.continuation.continuationCount||0)+1,n?(this.telemetry.continuation.checkpointContent=n,this.telemetry.continuation.checkpointLength=n.length):(this.telemetry.continuation.checkpointContent=void 0,this.telemetry.continuation.checkpointLength=void 0)))}logEvent(e){this.isEnabled()&&(this.telemetry.metadata||(this.telemetry.metadata={}),this.telemetry.metadata.customEvents||(this.telemetry.metadata.customEvents=[]),this.telemetry.metadata.customEvents.push({...e,timestamp:Date.now()}))}calculateTimingMetrics(){if(this.tokenTimestamps.length<2)return;let e=[];for(let r=1;r<this.tokenTimestamps.length;r++)e.push(this.tokenTimestamps[r]-this.tokenTimestamps[r-1]);if(e.length>0){let r=e.reduce((n,o)=>n+o,0);this.telemetry.metrics.avgInterTokenTime=r/e.length}this.telemetry.duration&&this.telemetry.duration>0&&(this.telemetry.metrics.tokensPerSecond=this.telemetry.metrics.totalTokens/this.telemetry.duration*1e3)}getTelemetry(){if(this.isEnabled())return this.telemetry}toJSON(){return this.isEnabled()?JSON.stringify(this.telemetry,null,2):"{}"}export(){return this.getTelemetry()}getSummary(){if(this.isEnabled())return{sessionId:this.telemetry.sessionId,duration:this.telemetry.duration??0,tokens:this.telemetry.metrics.totalTokens,tokensPerSecond:this.telemetry.metrics.tokensPerSecond??0,retries:this.telemetry.metrics.totalRetries,networkErrors:this.telemetry.network.errorCount,violations:this.telemetry.guardrails?.violationCount??0}}getNetworkErrorBreakdown(){return this.isEnabled()?{...this.telemetry.network.errorsByType}:{}}hasNetworkErrors(){return this.isEnabled()?this.telemetry.network.errorCount>0:!1}hasViolations(){return this.isEnabled()?(this.telemetry.guardrails?.violationCount??0)>0:!1}getMostCommonNetworkError(){if(!this.isEnabled()||this.telemetry.network.errorCount===0)return null;let e=0,r=null;for(let[n,o]of Object.entries(this.telemetry.network.errorsByType))o>e&&(e=o,r=n);return r}reset(){this.telemetry=this.createInitialTelemetry(),this.tokenTimestamps=[]}};function ri(t){return new ze(t)}var hn=class{static toJSON(e){return JSON.stringify(e,null,2)}static toCSV(e){let r=[];r.push("sessionId,duration,tokens,tokensPerSecond,retries,networkErrors,violations");let n=e.duration??0,o=e.metrics.totalTokens,s=e.metrics.tokensPerSecond??0,i=e.metrics.totalRetries,a=e.network.errorCount,u=e.guardrails?.violationCount??0;return r.push(`${e.sessionId},${n},${o},${s.toFixed(2)},${i},${a},${u}`),r.join(`
`)}static toLogFormat(e){return{session_id:e.sessionId,timestamp:e.startTime,duration_ms:e.duration,metrics:{tokens:e.metrics.totalTokens,tokens_per_second:e.metrics.tokensPerSecond,time_to_first_token_ms:e.metrics.timeToFirstToken,avg_inter_token_time_ms:e.metrics.avgInterTokenTime,total_retries:e.metrics.totalRetries,network_retries:e.metrics.networkRetryCount,model_retries:e.metrics.modelRetryCount},network:{error_count:e.network.errorCount,errors_by_type:e.network.errorsByType},guardrails:e.guardrails?{violation_count:e.guardrails.violationCount,violations_by_severity:e.guardrails.violationsBySeverity}:null,drift:e.drift,metadata:e.metadata}}static toMetrics(e){let r=[],n=e.endTime??e.startTime,o=e.metadata?Object.fromEntries(Object.entries(e.metadata).map(([s,i])=>[s,String(i)])):void 0;return e.duration!==void 0&&r.push({name:"l0.duration",value:e.duration,timestamp:n,tags:o}),r.push({name:"l0.tokens.total",value:e.metrics.totalTokens,timestamp:n,tags:o}),e.metrics.tokensPerSecond!==void 0&&r.push({name:"l0.tokens.per_second",value:e.metrics.tokensPerSecond,timestamp:n,tags:o}),e.metrics.timeToFirstToken!==void 0&&r.push({name:"l0.time_to_first_token",value:e.metrics.timeToFirstToken,timestamp:n,tags:o}),r.push({name:"l0.retries.total",value:e.metrics.totalRetries,timestamp:n,tags:o}),r.push({name:"l0.retries.network",value:e.metrics.networkRetryCount,timestamp:n,tags:o}),r.push({name:"l0.retries.model",value:e.metrics.modelRetryCount,timestamp:n,tags:o}),r.push({name:"l0.network.errors",value:e.network.errorCount,timestamp:n,tags:o}),e.guardrails&&r.push({name:"l0.guardrails.violations",value:e.guardrails.violationCount,timestamp:n,tags:o}),r}};var St=class{interceptors;contexts=[];constructor(e=[]){this.interceptors=e}async executeBefore(e){let r=e;for(let n of this.interceptors)if(n.before){let o=Date.now(),s={name:n.name||"anonymous",phase:"before",timestamp:o};try{r=await n.before(r),s.duration=Date.now()-o,this.contexts.push(s)}catch(i){throw s.duration=Date.now()-o,this.contexts.push(s),new Error(`Interceptor "${s.name}" before hook failed: ${i instanceof Error?i.message:String(i)}`)}}return r}async executeAfter(e){let r=e;for(let n of this.interceptors)if(n.after){let o=Date.now(),s={name:n.name||"anonymous",phase:"after",timestamp:o};try{r=await n.after(r),s.duration=Date.now()-o,this.contexts.push(s)}catch(i){throw s.duration=Date.now()-o,this.contexts.push(s),new Error(`Interceptor "${s.name}" after hook failed: ${i instanceof Error?i.message:String(i)}`)}}return r}async executeError(e,r){for(let n of this.interceptors)if(n.onError){let o=Date.now(),s={name:n.name||"anonymous",phase:"error",timestamp:o};try{await n.onError(e,r),s.duration=Date.now()-o,this.contexts.push(s)}catch(i){s.duration=Date.now()-o,this.contexts.push(s),console.error(`Interceptor "${s.name}" error hook failed:`,i)}}}getContexts(){return[...this.contexts]}reset(){this.contexts=[]}};function ni(t=console){return{name:"logging",before:async e=>(t.info("L0 execution starting",{hasGuardrails:!!e.guardrails?.length,hasRetry:!!e.retry,hasMonitoring:e.monitoring?.enabled}),e),after:async e=>(t.info("L0 execution completed",{completed:e.state.completed,tokens:e.state.tokenCount,retries:e.state.modelRetryCount,networkRetryCount:e.state.networkRetryCount,violations:e.state.violations.length}),e),onError:async e=>{t.error("L0 execution failed",{error:e.message})}}}function oi(t){return{name:"metadata",before:async e=>({...e,monitoring:{...e.monitoring,enabled:e.monitoring?.enabled??!0,metadata:{...e.monitoring?.metadata,...t}}})}}function si(t){return{name:"auth",before:async e=>{let r=await t();return{...e,monitoring:{...e.monitoring,metadata:{...e.monitoring?.metadata,auth:r}}}}}}function ii(){let t=new Map;return{name:"timing",before:async e=>{let r=`session_${Date.now()}`;return t.set(r,Date.now()),{...e,monitoring:{...e.monitoring,enabled:!0,includeTimings:!0,metadata:{...e.monitoring?.metadata,sessionId:r}}}},after:async e=>{let r=e.telemetry?.sessionId;return r&&t.has(r)&&t.delete(r),e}}}function ai(t,e){return{name:"validation",after:async r=>{if(!await t(r.state.content))throw e&&e(r.state.content),new Error("Output validation failed");return r}}}function ui(t,e){let r=[];return{name:"rate-limit",before:async n=>{let o=Date.now();for(;r.length>0&&r[0]<o-e;)r.shift();if(r.length>=t){let s=r[0]??o,i=e-(o-s);throw new Error(`Rate limit exceeded. Wait ${i}ms before retrying.`)}return r.push(o),n}}}function ci(t,e){return{name:"caching",before:async r=>{let n=e(r);if(t.has(n)){let o=t.get(n);throw new gn(o)}return r},after:async r=>r}}var gn=class extends Error{constructor(r){super("Cached result available");this.result=r;this.name="CachedResultError"}};function li(t){return{name:"transform",after:async e=>{let r=await t(e.state.content);return{...e,state:{...e.state,content:r}}}}}function di(t){let e;return{name:"analytics",before:async r=>(e=Date.now(),await t("l0_started",{timestamp:e,hasGuardrails:!!r.guardrails?.length}),r),after:async r=>(await t("l0_completed",{duration:Date.now()-e,tokens:r.state.tokenCount,retries:r.state.modelRetryCount,completed:r.state.completed}),r),onError:async r=>{await t("l0_failed",{duration:Date.now()-e,error:r.message})}}}function pi(t=[]){return new St(t)}var Ie=[];function mi(t,e={}){if(t.detect||!e.silent&&typeof process<"u"&&process.env?.NODE_ENV!=="production"&&console.warn(`\u26A0\uFE0F  Adapter "${t.name}" has no detect() method.
   It will not be used for auto-detection.
   Use explicit \`adapter: myAdapter\` instead, or add a detect() method.`),Ie.some(r=>r.name===t.name))throw new Error(`Adapter "${t.name}" is already registered`);Ie.push(t)}function fi(t){let e=Ie.findIndex(r=>r.name===t);return e===-1?!1:(Ie.splice(e,1),!0)}function yn(t){return Ie.find(e=>e.name===t)}function fo(){return Ie.map(t=>t.name)}function hi(){Ie.length=0}function vn(t){let e=Ie.filter(n=>n.detect),r=e.filter(n=>n.detect(t));if(r.length===0){let n=fo(),o=e.map(a=>a.name),s=o.length>0?`[${o.join(", ")}]`:"(none)",i=n.length>o.length?` (${n.length-o.length} adapter(s) without detect() were skipped)`:"";throw new Error(`No registered adapter detected for stream. Detectable adapters: ${s}${i}. Use explicit \`adapter: myAdapter\` or register an adapter with detect().`)}if(r.length>1)throw new Error(`Multiple adapters detected for stream: [${r.map(n=>n.name).join(", ")}]. Use explicit \`adapter: myAdapter\` to disambiguate.`);return r[0]}function xn(t){return Ie.filter(n=>n.detect).filter(n=>n.detect(t)).length===1}function gi(t,e,r){let n=e;for(let o of t){if(n===null)break;n=o(n,r)}return n}function yi(t,e,r,n){return{state:t,stateMachine:e,monitor:r,signal:n,scratch:new Map}}function vi(t,e,r){if(e.delta&&e.delta.length<1e3){let n={...e,content:e.delta},o=t.check(n);if(o.violations.length>0)return o;if(e.content.length<5e3)return t.check(e)}setImmediate(()=>{try{let n=t.check(e);r(n)}catch{r({violations:[],shouldHalt:!1,shouldRetry:!1})}})}function xi(t,e,r){setImmediate(()=>{try{let n=t.check(e);r(n)}catch{r({violations:[],shouldHalt:!1,shouldRetry:!1})}})}function bi(t,e,r,n){if(r&&r.length<1e3){let o=t.check(r);if(o.detected)return o;if(e.length<1e4)return t.check(e,r)}if(e.length<1e4)return t.check(e,r);setImmediate(()=>{let o;try{o=t.check(e,r)}catch{o={detected:!1,types:[]}}n(o)})}function ki(t,e,r,n){setImmediate(()=>{let o;try{o=t.check(e,r)}catch{o={detected:!1,types:[]}}n(o)})}var Yt={};Rs(Yt,{BRAND:()=>Zi,DIRTY:()=>Xe,EMPTY_PATH:()=>Si,INVALID:()=>w,NEVER:()=>La,OK:()=>ce,ParseStatus:()=>oe,Schema:()=>L,ZodAny:()=>Ue,ZodArray:()=>Fe,ZodBigInt:()=>et,ZodBoolean:()=>tt,ZodBranded:()=>Ht,ZodCatch:()=>pt,ZodDate:()=>rt,ZodDefault:()=>dt,ZodDiscriminatedUnion:()=>yr,ZodEffects:()=>ve,ZodEnum:()=>ct,ZodError:()=>me,ZodFirstPartyTypeKind:()=>S,ZodFunction:()=>xr,ZodIntersection:()=>it,ZodIssueCode:()=>f,ZodLazy:()=>at,ZodLiteral:()=>ut,ZodMap:()=>Lt,ZodNaN:()=>Pt,ZodNativeEnum:()=>lt,ZodNever:()=>ke,ZodNull:()=>ot,ZodNullable:()=>Oe,ZodNumber:()=>Qe,ZodObject:()=>fe,ZodOptional:()=>ge,ZodParsedType:()=>v,ZodPipeline:()=>Kt,ZodPromise:()=>We,ZodReadonly:()=>mt,ZodRecord:()=>vr,ZodSchema:()=>L,ZodSet:()=>Dt,ZodString:()=>Je,ZodSymbol:()=>Ot,ZodTransformer:()=>ve,ZodTuple:()=>_e,ZodType:()=>L,ZodUndefined:()=>nt,ZodUnion:()=>st,ZodUnknown:()=>$e,ZodVoid:()=>At,addIssueToContext:()=>y,any:()=>ra,array:()=>ia,bigint:()=>Yi,boolean:()=>So,coerce:()=>Aa,custom:()=>To,date:()=>Xi,datetimeRegex:()=>bo,defaultErrorMap:()=>Ne,discriminatedUnion:()=>la,effect:()=>Ta,enum:()=>xa,function:()=>ga,getErrorMap:()=>Ct,getParsedType:()=>Re,instanceof:()=>Hi,intersection:()=>da,isAborted:()=>hr,isAsync:()=>Rt,isDirty:()=>gr,isValid:()=>Be,late:()=>qi,lazy:()=>ya,literal:()=>va,makeIssue:()=>qt,map:()=>fa,nan:()=>Ki,nativeEnum:()=>ba,never:()=>oa,null:()=>ta,nullable:()=>wa,number:()=>wo,object:()=>aa,objectUtil:()=>bn,oboolean:()=>Oa,onumber:()=>_a,optional:()=>Ea,ostring:()=>Ra,pipeline:()=>Ca,preprocess:()=>Sa,promise:()=>ka,quotelessJson:()=>Ti,record:()=>ma,set:()=>ha,setErrorMap:()=>wi,strictObject:()=>ua,string:()=>Eo,symbol:()=>Qi,transformer:()=>Ta,tuple:()=>pa,undefined:()=>ea,union:()=>ca,unknown:()=>na,util:()=>I,void:()=>sa});var I;(function(t){t.assertEqual=o=>{};function e(o){}t.assertIs=e;function r(o){throw new Error}t.assertNever=r,t.arrayToEnum=o=>{let s={};for(let i of o)s[i]=i;return s},t.getValidEnumValues=o=>{let s=t.objectKeys(o).filter(a=>typeof o[o[a]]!="number"),i={};for(let a of s)i[a]=o[a];return t.objectValues(i)},t.objectValues=o=>t.objectKeys(o).map(function(s){return o[s]}),t.objectKeys=typeof Object.keys=="function"?o=>Object.keys(o):o=>{let s=[];for(let i in o)Object.prototype.hasOwnProperty.call(o,i)&&s.push(i);return s},t.find=(o,s)=>{for(let i of o)if(s(i))return i},t.isInteger=typeof Number.isInteger=="function"?o=>Number.isInteger(o):o=>typeof o=="number"&&Number.isFinite(o)&&Math.floor(o)===o;function n(o,s=" | "){return o.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}t.joinValues=n,t.jsonStringifyReplacer=(o,s)=>typeof s=="bigint"?s.toString():s})(I||(I={}));var bn;(function(t){t.mergeShapes=(e,r)=>({...e,...r})})(bn||(bn={}));var v=I.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Re=t=>{switch(typeof t){case"undefined":return v.undefined;case"string":return v.string;case"number":return Number.isNaN(t)?v.nan:v.number;case"boolean":return v.boolean;case"function":return v.function;case"bigint":return v.bigint;case"symbol":return v.symbol;case"object":return Array.isArray(t)?v.array:t===null?v.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?v.promise:typeof Map<"u"&&t instanceof Map?v.map:typeof Set<"u"&&t instanceof Set?v.set:typeof Date<"u"&&t instanceof Date?v.date:v.object;default:return v.unknown}};var f=I.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Ti=t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:"),me=class t extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};let r=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,r):this.__proto__=r,this.name="ZodError",this.issues=e}format(e){let r=e||function(s){return s.message},n={_errors:[]},o=s=>{for(let i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(o);else if(i.code==="invalid_return_type")o(i.returnTypeError);else if(i.code==="invalid_arguments")o(i.argumentsError);else if(i.path.length===0)n._errors.push(r(i));else{let a=n,u=0;for(;u<i.path.length;){let c=i.path[u];u===i.path.length-1?(a[c]=a[c]||{_errors:[]},a[c]._errors.push(r(i))):a[c]=a[c]||{_errors:[]},a=a[c],u++}}};return o(this),n}static assert(e){if(!(e instanceof t))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,I.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=r=>r.message){let r={},n=[];for(let o of this.issues)if(o.path.length>0){let s=o.path[0];r[s]=r[s]||[],r[s].push(e(o))}else n.push(e(o));return{formErrors:n,fieldErrors:r}}get formErrors(){return this.flatten()}};me.create=t=>new me(t);var Ei=(t,e)=>{let r;switch(t.code){case f.invalid_type:t.received===v.undefined?r="Required":r=`Expected ${t.expected}, received ${t.received}`;break;case f.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(t.expected,I.jsonStringifyReplacer)}`;break;case f.unrecognized_keys:r=`Unrecognized key(s) in object: ${I.joinValues(t.keys,", ")}`;break;case f.invalid_union:r="Invalid input";break;case f.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${I.joinValues(t.options)}`;break;case f.invalid_enum_value:r=`Invalid enum value. Expected ${I.joinValues(t.options)}, received '${t.received}'`;break;case f.invalid_arguments:r="Invalid function arguments";break;case f.invalid_return_type:r="Invalid function return type";break;case f.invalid_date:r="Invalid date";break;case f.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(r=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(r=`${r} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?r=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?r=`Invalid input: must end with "${t.validation.endsWith}"`:I.assertNever(t.validation):t.validation!=="regex"?r=`Invalid ${t.validation}`:r="Invalid";break;case f.too_small:t.type==="array"?r=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?r=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?r=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="bigint"?r=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?r=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:r="Invalid input";break;case f.too_big:t.type==="array"?r=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?r=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?r=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?r=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?r=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:r="Invalid input";break;case f.custom:r="Invalid input";break;case f.invalid_intersection_types:r="Intersection results could not be merged";break;case f.not_multiple_of:r=`Number must be a multiple of ${t.multipleOf}`;break;case f.not_finite:r="Number must be finite";break;default:r=e.defaultError,I.assertNever(t)}return{message:r}},Ne=Ei;var ho=Ne;function wi(t){ho=t}function Ct(){return ho}var qt=t=>{let{data:e,path:r,errorMaps:n,issueData:o}=t,s=[...r,...o.path||[]],i={...o,path:s};if(o.message!==void 0)return{...o,path:s,message:o.message};let a="",u=n.filter(c=>!!c).slice().reverse();for(let c of u)a=c(i,{data:e,defaultError:a}).message;return{...o,path:s,message:a}},Si=[];function y(t,e){let r=Ct(),n=qt({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,r,r===Ne?void 0:Ne].filter(o=>!!o)});t.common.issues.push(n)}var oe=class t{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,r){let n=[];for(let o of r){if(o.status==="aborted")return w;o.status==="dirty"&&e.dirty(),n.push(o.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,r){let n=[];for(let o of r){let s=await o.key,i=await o.value;n.push({key:s,value:i})}return t.mergeObjectSync(e,n)}static mergeObjectSync(e,r){let n={};for(let o of r){let{key:s,value:i}=o;if(s.status==="aborted"||i.status==="aborted")return w;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value<"u"||o.alwaysSet)&&(n[s.value]=i.value)}return{status:e.value,value:n}}},w=Object.freeze({status:"aborted"}),Xe=t=>({status:"dirty",value:t}),ce=t=>({status:"valid",value:t}),hr=t=>t.status==="aborted",gr=t=>t.status==="dirty",Be=t=>t.status==="valid",Rt=t=>typeof Promise<"u"&&t instanceof Promise;var k;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e?.message})(k||(k={}));var ye=class{constructor(e,r,n,o){this._cachedPath=[],this.parent=e,this.data=r,this._path=n,this._key=o}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},go=(t,e)=>{if(Be(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let r=new me(t.common.issues);return this._error=r,this._error}}};function O(t){if(!t)return{};let{errorMap:e,invalid_type_error:r,required_error:n,description:o}=t;if(e&&(r||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:o}:{errorMap:(i,a)=>{let{message:u}=t;return i.code==="invalid_enum_value"?{message:u??a.defaultError}:typeof a.data>"u"?{message:u??n??a.defaultError}:i.code!=="invalid_type"?{message:a.defaultError}:{message:u??r??a.defaultError}},description:o}}var L=class{get description(){return this._def.description}_getType(e){return Re(e.data)}_getOrReturnCtx(e,r){return r||{common:e.parent.common,data:e.data,parsedType:Re(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new oe,ctx:{common:e.parent.common,data:e.data,parsedType:Re(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let r=this._parse(e);if(Rt(r))throw new Error("Synchronous parse encountered promise.");return r}_parseAsync(e){let r=this._parse(e);return Promise.resolve(r)}parse(e,r){let n=this.safeParse(e,r);if(n.success)return n.data;throw n.error}safeParse(e,r){let n={common:{issues:[],async:r?.async??!1,contextualErrorMap:r?.errorMap},path:r?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Re(e)},o=this._parseSync({data:e,path:n.path,parent:n});return go(n,o)}"~validate"(e){let r={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Re(e)};if(!this["~standard"].async)try{let n=this._parseSync({data:e,path:[],parent:r});return Be(n)?{value:n.value}:{issues:r.common.issues}}catch(n){n?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),r.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:r}).then(n=>Be(n)?{value:n.value}:{issues:r.common.issues})}async parseAsync(e,r){let n=await this.safeParseAsync(e,r);if(n.success)return n.data;throw n.error}async safeParseAsync(e,r){let n={common:{issues:[],contextualErrorMap:r?.errorMap,async:!0},path:r?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Re(e)},o=this._parse({data:e,path:n.path,parent:n}),s=await(Rt(o)?o:Promise.resolve(o));return go(n,s)}refine(e,r){let n=o=>typeof r=="string"||typeof r>"u"?{message:r}:typeof r=="function"?r(o):r;return this._refinement((o,s)=>{let i=e(o),a=()=>s.addIssue({code:f.custom,...n(o)});return typeof Promise<"u"&&i instanceof Promise?i.then(u=>u?!0:(a(),!1)):i?!0:(a(),!1)})}refinement(e,r){return this._refinement((n,o)=>e(n)?!0:(o.addIssue(typeof r=="function"?r(n,o):r),!1))}_refinement(e){return new ve({schema:this,typeName:S.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:r=>this["~validate"](r)}}optional(){return ge.create(this,this._def)}nullable(){return Oe.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Fe.create(this)}promise(){return We.create(this,this._def)}or(e){return st.create([this,e],this._def)}and(e){return it.create(this,e,this._def)}transform(e){return new ve({...O(this._def),schema:this,typeName:S.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let r=typeof e=="function"?e:()=>e;return new dt({...O(this._def),innerType:this,defaultValue:r,typeName:S.ZodDefault})}brand(){return new Ht({typeName:S.ZodBranded,type:this,...O(this._def)})}catch(e){let r=typeof e=="function"?e:()=>e;return new pt({...O(this._def),innerType:this,catchValue:r,typeName:S.ZodCatch})}describe(e){let r=this.constructor;return new r({...this._def,description:e})}pipe(e){return Kt.create(this,e)}readonly(){return mt.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Ci=/^c[^\s-]{8,}$/i,Ri=/^[0-9a-z]+$/,_i=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Oi=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Ai=/^[a-z0-9_-]{21}$/i,Li=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Di=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Pi=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Ii="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",kn,Ni=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Mi=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,$i=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Fi=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ji=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Gi=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,vo="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Vi=new RegExp(`^${vo}$`);function xo(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);let r=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${r}`}function zi(t){return new RegExp(`^${xo(t)}$`)}function bo(t){let e=`${vo}T${xo(t)}`,r=[];return r.push(t.local?"Z?":"Z"),t.offset&&r.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${r.join("|")})`,new RegExp(`^${e}$`)}function Bi(t,e){return!!((e==="v4"||!e)&&Ni.test(t)||(e==="v6"||!e)&&$i.test(t))}function Ji(t,e){if(!Li.test(t))return!1;try{let[r]=t.split(".");if(!r)return!1;let n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),o=JSON.parse(atob(n));return!(typeof o!="object"||o===null||"typ"in o&&o?.typ!=="JWT"||!o.alg||e&&o.alg!==e)}catch{return!1}}function Ui(t,e){return!!((e==="v4"||!e)&&Mi.test(t)||(e==="v6"||!e)&&Fi.test(t))}var Je=class t extends L{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==v.string){let s=this._getOrReturnCtx(e);return y(s,{code:f.invalid_type,expected:v.string,received:s.parsedType}),w}let n=new oe,o;for(let s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(o=this._getOrReturnCtx(e,o),y(o,{code:f.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="max")e.data.length>s.value&&(o=this._getOrReturnCtx(e,o),y(o,{code:f.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="length"){let i=e.data.length>s.value,a=e.data.length<s.value;(i||a)&&(o=this._getOrReturnCtx(e,o),i?y(o,{code:f.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):a&&y(o,{code:f.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),n.dirty())}else if(s.kind==="email")Pi.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"email",code:f.invalid_string,message:s.message}),n.dirty());else if(s.kind==="emoji")kn||(kn=new RegExp(Ii,"u")),kn.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"emoji",code:f.invalid_string,message:s.message}),n.dirty());else if(s.kind==="uuid")Oi.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"uuid",code:f.invalid_string,message:s.message}),n.dirty());else if(s.kind==="nanoid")Ai.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"nanoid",code:f.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid")Ci.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"cuid",code:f.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid2")Ri.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"cuid2",code:f.invalid_string,message:s.message}),n.dirty());else if(s.kind==="ulid")_i.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"ulid",code:f.invalid_string,message:s.message}),n.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{o=this._getOrReturnCtx(e,o),y(o,{validation:"url",code:f.invalid_string,message:s.message}),n.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"regex",code:f.invalid_string,message:s.message}),n.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(o=this._getOrReturnCtx(e,o),y(o,{code:f.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),n.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(o=this._getOrReturnCtx(e,o),y(o,{code:f.invalid_string,validation:{startsWith:s.value},message:s.message}),n.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(o=this._getOrReturnCtx(e,o),y(o,{code:f.invalid_string,validation:{endsWith:s.value},message:s.message}),n.dirty()):s.kind==="datetime"?bo(s).test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{code:f.invalid_string,validation:"datetime",message:s.message}),n.dirty()):s.kind==="date"?Vi.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{code:f.invalid_string,validation:"date",message:s.message}),n.dirty()):s.kind==="time"?zi(s).test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{code:f.invalid_string,validation:"time",message:s.message}),n.dirty()):s.kind==="duration"?Di.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"duration",code:f.invalid_string,message:s.message}),n.dirty()):s.kind==="ip"?Bi(e.data,s.version)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"ip",code:f.invalid_string,message:s.message}),n.dirty()):s.kind==="jwt"?Ji(e.data,s.alg)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"jwt",code:f.invalid_string,message:s.message}),n.dirty()):s.kind==="cidr"?Ui(e.data,s.version)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"cidr",code:f.invalid_string,message:s.message}),n.dirty()):s.kind==="base64"?ji.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"base64",code:f.invalid_string,message:s.message}),n.dirty()):s.kind==="base64url"?Gi.test(e.data)||(o=this._getOrReturnCtx(e,o),y(o,{validation:"base64url",code:f.invalid_string,message:s.message}),n.dirty()):I.assertNever(s);return{status:n.value,value:e.data}}_regex(e,r,n){return this.refinement(o=>e.test(o),{validation:r,code:f.invalid_string,...k.errToObj(n)})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...k.errToObj(e)})}url(e){return this._addCheck({kind:"url",...k.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...k.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...k.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...k.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...k.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...k.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...k.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...k.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...k.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...k.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...k.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...k.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...k.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...k.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...k.errToObj(e)})}regex(e,r){return this._addCheck({kind:"regex",regex:e,...k.errToObj(r)})}includes(e,r){return this._addCheck({kind:"includes",value:e,position:r?.position,...k.errToObj(r?.message)})}startsWith(e,r){return this._addCheck({kind:"startsWith",value:e,...k.errToObj(r)})}endsWith(e,r){return this._addCheck({kind:"endsWith",value:e,...k.errToObj(r)})}min(e,r){return this._addCheck({kind:"min",value:e,...k.errToObj(r)})}max(e,r){return this._addCheck({kind:"max",value:e,...k.errToObj(r)})}length(e,r){return this._addCheck({kind:"length",value:e,...k.errToObj(r)})}nonempty(e){return this.min(1,k.errToObj(e))}trim(){return new t({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new t({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new t({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(let r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxLength(){let e=null;for(let r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}};Je.create=t=>new Je({checks:[],typeName:S.ZodString,coerce:t?.coerce??!1,...O(t)});function Wi(t,e){let r=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,o=r>n?r:n,s=Number.parseInt(t.toFixed(o).replace(".","")),i=Number.parseInt(e.toFixed(o).replace(".",""));return s%i/10**o}var Qe=class t extends L{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==v.number){let s=this._getOrReturnCtx(e);return y(s,{code:f.invalid_type,expected:v.number,received:s.parsedType}),w}let n,o=new oe;for(let s of this._def.checks)s.kind==="int"?I.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),y(n,{code:f.invalid_type,expected:"integer",received:"float",message:s.message}),o.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(n=this._getOrReturnCtx(e,n),y(n,{code:f.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),o.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(n=this._getOrReturnCtx(e,n),y(n,{code:f.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),o.dirty()):s.kind==="multipleOf"?Wi(e.data,s.value)!==0&&(n=this._getOrReturnCtx(e,n),y(n,{code:f.not_multiple_of,multipleOf:s.value,message:s.message}),o.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),y(n,{code:f.not_finite,message:s.message}),o.dirty()):I.assertNever(s);return{status:o.value,value:e.data}}gte(e,r){return this.setLimit("min",e,!0,k.toString(r))}gt(e,r){return this.setLimit("min",e,!1,k.toString(r))}lte(e,r){return this.setLimit("max",e,!0,k.toString(r))}lt(e,r){return this.setLimit("max",e,!1,k.toString(r))}setLimit(e,r,n,o){return new t({...this._def,checks:[...this._def.checks,{kind:e,value:r,inclusive:n,message:k.toString(o)}]})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:k.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:k.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:k.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:k.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:k.toString(e)})}multipleOf(e,r){return this._addCheck({kind:"multipleOf",value:e,message:k.toString(r)})}finite(e){return this._addCheck({kind:"finite",message:k.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:k.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:k.toString(e)})}get minValue(){let e=null;for(let r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxValue(){let e=null;for(let r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&I.isInteger(e.value))}get isFinite(){let e=null,r=null;for(let n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(r===null||n.value>r)&&(r=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(r)&&Number.isFinite(e)}};Qe.create=t=>new Qe({checks:[],typeName:S.ZodNumber,coerce:t?.coerce||!1,...O(t)});var et=class t extends L{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==v.bigint)return this._getInvalidInput(e);let n,o=new oe;for(let s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(n=this._getOrReturnCtx(e,n),y(n,{code:f.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),o.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(n=this._getOrReturnCtx(e,n),y(n,{code:f.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),o.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),y(n,{code:f.not_multiple_of,multipleOf:s.value,message:s.message}),o.dirty()):I.assertNever(s);return{status:o.value,value:e.data}}_getInvalidInput(e){let r=this._getOrReturnCtx(e);return y(r,{code:f.invalid_type,expected:v.bigint,received:r.parsedType}),w}gte(e,r){return this.setLimit("min",e,!0,k.toString(r))}gt(e,r){return this.setLimit("min",e,!1,k.toString(r))}lte(e,r){return this.setLimit("max",e,!0,k.toString(r))}lt(e,r){return this.setLimit("max",e,!1,k.toString(r))}setLimit(e,r,n,o){return new t({...this._def,checks:[...this._def.checks,{kind:e,value:r,inclusive:n,message:k.toString(o)}]})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:k.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:k.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:k.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:k.toString(e)})}multipleOf(e,r){return this._addCheck({kind:"multipleOf",value:e,message:k.toString(r)})}get minValue(){let e=null;for(let r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxValue(){let e=null;for(let r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}};et.create=t=>new et({checks:[],typeName:S.ZodBigInt,coerce:t?.coerce??!1,...O(t)});var tt=class extends L{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==v.boolean){let n=this._getOrReturnCtx(e);return y(n,{code:f.invalid_type,expected:v.boolean,received:n.parsedType}),w}return ce(e.data)}};tt.create=t=>new tt({typeName:S.ZodBoolean,coerce:t?.coerce||!1,...O(t)});var rt=class t extends L{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==v.date){let s=this._getOrReturnCtx(e);return y(s,{code:f.invalid_type,expected:v.date,received:s.parsedType}),w}if(Number.isNaN(e.data.getTime())){let s=this._getOrReturnCtx(e);return y(s,{code:f.invalid_date}),w}let n=new oe,o;for(let s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(o=this._getOrReturnCtx(e,o),y(o,{code:f.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),n.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(o=this._getOrReturnCtx(e,o),y(o,{code:f.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),n.dirty()):I.assertNever(s);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}min(e,r){return this._addCheck({kind:"min",value:e.getTime(),message:k.toString(r)})}max(e,r){return this._addCheck({kind:"max",value:e.getTime(),message:k.toString(r)})}get minDate(){let e=null;for(let r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e!=null?new Date(e):null}};rt.create=t=>new rt({checks:[],coerce:t?.coerce||!1,typeName:S.ZodDate,...O(t)});var Ot=class extends L{_parse(e){if(this._getType(e)!==v.symbol){let n=this._getOrReturnCtx(e);return y(n,{code:f.invalid_type,expected:v.symbol,received:n.parsedType}),w}return ce(e.data)}};Ot.create=t=>new Ot({typeName:S.ZodSymbol,...O(t)});var nt=class extends L{_parse(e){if(this._getType(e)!==v.undefined){let n=this._getOrReturnCtx(e);return y(n,{code:f.invalid_type,expected:v.undefined,received:n.parsedType}),w}return ce(e.data)}};nt.create=t=>new nt({typeName:S.ZodUndefined,...O(t)});var ot=class extends L{_parse(e){if(this._getType(e)!==v.null){let n=this._getOrReturnCtx(e);return y(n,{code:f.invalid_type,expected:v.null,received:n.parsedType}),w}return ce(e.data)}};ot.create=t=>new ot({typeName:S.ZodNull,...O(t)});var Ue=class extends L{constructor(){super(...arguments),this._any=!0}_parse(e){return ce(e.data)}};Ue.create=t=>new Ue({typeName:S.ZodAny,...O(t)});var $e=class extends L{constructor(){super(...arguments),this._unknown=!0}_parse(e){return ce(e.data)}};$e.create=t=>new $e({typeName:S.ZodUnknown,...O(t)});var ke=class extends L{_parse(e){let r=this._getOrReturnCtx(e);return y(r,{code:f.invalid_type,expected:v.never,received:r.parsedType}),w}};ke.create=t=>new ke({typeName:S.ZodNever,...O(t)});var At=class extends L{_parse(e){if(this._getType(e)!==v.undefined){let n=this._getOrReturnCtx(e);return y(n,{code:f.invalid_type,expected:v.void,received:n.parsedType}),w}return ce(e.data)}};At.create=t=>new At({typeName:S.ZodVoid,...O(t)});var Fe=class t extends L{_parse(e){let{ctx:r,status:n}=this._processInputParams(e),o=this._def;if(r.parsedType!==v.array)return y(r,{code:f.invalid_type,expected:v.array,received:r.parsedType}),w;if(o.exactLength!==null){let i=r.data.length>o.exactLength.value,a=r.data.length<o.exactLength.value;(i||a)&&(y(r,{code:i?f.too_big:f.too_small,minimum:a?o.exactLength.value:void 0,maximum:i?o.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:o.exactLength.message}),n.dirty())}if(o.minLength!==null&&r.data.length<o.minLength.value&&(y(r,{code:f.too_small,minimum:o.minLength.value,type:"array",inclusive:!0,exact:!1,message:o.minLength.message}),n.dirty()),o.maxLength!==null&&r.data.length>o.maxLength.value&&(y(r,{code:f.too_big,maximum:o.maxLength.value,type:"array",inclusive:!0,exact:!1,message:o.maxLength.message}),n.dirty()),r.common.async)return Promise.all([...r.data].map((i,a)=>o.type._parseAsync(new ye(r,i,r.path,a)))).then(i=>oe.mergeArray(n,i));let s=[...r.data].map((i,a)=>o.type._parseSync(new ye(r,i,r.path,a)));return oe.mergeArray(n,s)}get element(){return this._def.type}min(e,r){return new t({...this._def,minLength:{value:e,message:k.toString(r)}})}max(e,r){return new t({...this._def,maxLength:{value:e,message:k.toString(r)}})}length(e,r){return new t({...this._def,exactLength:{value:e,message:k.toString(r)}})}nonempty(e){return this.min(1,e)}};Fe.create=(t,e)=>new Fe({type:t,minLength:null,maxLength:null,exactLength:null,typeName:S.ZodArray,...O(e)});function _t(t){if(t instanceof fe){let e={};for(let r in t.shape){let n=t.shape[r];e[r]=ge.create(_t(n))}return new fe({...t._def,shape:()=>e})}else return t instanceof Fe?new Fe({...t._def,type:_t(t.element)}):t instanceof ge?ge.create(_t(t.unwrap())):t instanceof Oe?Oe.create(_t(t.unwrap())):t instanceof _e?_e.create(t.items.map(e=>_t(e))):t}var fe=class t extends L{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),r=I.objectKeys(e);return this._cached={shape:e,keys:r},this._cached}_parse(e){if(this._getType(e)!==v.object){let c=this._getOrReturnCtx(e);return y(c,{code:f.invalid_type,expected:v.object,received:c.parsedType}),w}let{status:n,ctx:o}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),a=[];if(!(this._def.catchall instanceof ke&&this._def.unknownKeys==="strip"))for(let c in o.data)i.includes(c)||a.push(c);let u=[];for(let c of i){let l=s[c],p=o.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new ye(o,p,o.path,c)),alwaysSet:c in o.data})}if(this._def.catchall instanceof ke){let c=this._def.unknownKeys;if(c==="passthrough")for(let l of a)u.push({key:{status:"valid",value:l},value:{status:"valid",value:o.data[l]}});else if(c==="strict")a.length>0&&(y(o,{code:f.unrecognized_keys,keys:a}),n.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let c=this._def.catchall;for(let l of a){let p=o.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new ye(o,p,o.path,l)),alwaysSet:l in o.data})}}return o.common.async?Promise.resolve().then(async()=>{let c=[];for(let l of u){let p=await l.key,h=await l.value;c.push({key:p,value:h,alwaysSet:l.alwaysSet})}return c}).then(c=>oe.mergeObjectSync(n,c)):oe.mergeObjectSync(n,u)}get shape(){return this._def.shape()}strict(e){return k.errToObj,new t({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(r,n)=>{let o=this._def.errorMap?.(r,n).message??n.defaultError;return r.code==="unrecognized_keys"?{message:k.errToObj(e).message??o}:{message:o}}}:{}})}strip(){return new t({...this._def,unknownKeys:"strip"})}passthrough(){return new t({...this._def,unknownKeys:"passthrough"})}extend(e){return new t({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new t({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:S.ZodObject})}setKey(e,r){return this.augment({[e]:r})}catchall(e){return new t({...this._def,catchall:e})}pick(e){let r={};for(let n of I.objectKeys(e))e[n]&&this.shape[n]&&(r[n]=this.shape[n]);return new t({...this._def,shape:()=>r})}omit(e){let r={};for(let n of I.objectKeys(this.shape))e[n]||(r[n]=this.shape[n]);return new t({...this._def,shape:()=>r})}deepPartial(){return _t(this)}partial(e){let r={};for(let n of I.objectKeys(this.shape)){let o=this.shape[n];e&&!e[n]?r[n]=o:r[n]=o.optional()}return new t({...this._def,shape:()=>r})}required(e){let r={};for(let n of I.objectKeys(this.shape))if(e&&!e[n])r[n]=this.shape[n];else{let s=this.shape[n];for(;s instanceof ge;)s=s._def.innerType;r[n]=s}return new t({...this._def,shape:()=>r})}keyof(){return ko(I.objectKeys(this.shape))}};fe.create=(t,e)=>new fe({shape:()=>t,unknownKeys:"strip",catchall:ke.create(),typeName:S.ZodObject,...O(e)});fe.strictCreate=(t,e)=>new fe({shape:()=>t,unknownKeys:"strict",catchall:ke.create(),typeName:S.ZodObject,...O(e)});fe.lazycreate=(t,e)=>new fe({shape:t,unknownKeys:"strip",catchall:ke.create(),typeName:S.ZodObject,...O(e)});var st=class extends L{_parse(e){let{ctx:r}=this._processInputParams(e),n=this._def.options;function o(s){for(let a of s)if(a.result.status==="valid")return a.result;for(let a of s)if(a.result.status==="dirty")return r.common.issues.push(...a.ctx.common.issues),a.result;let i=s.map(a=>new me(a.ctx.common.issues));return y(r,{code:f.invalid_union,unionErrors:i}),w}if(r.common.async)return Promise.all(n.map(async s=>{let i={...r,common:{...r.common,issues:[]},parent:null};return{result:await s._parseAsync({data:r.data,path:r.path,parent:i}),ctx:i}})).then(o);{let s,i=[];for(let u of n){let c={...r,common:{...r.common,issues:[]},parent:null},l=u._parseSync({data:r.data,path:r.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(s)return r.common.issues.push(...s.ctx.common.issues),s.result;let a=i.map(u=>new me(u));return y(r,{code:f.invalid_union,unionErrors:a}),w}}get options(){return this._def.options}};st.create=(t,e)=>new st({options:t,typeName:S.ZodUnion,...O(e)});var Me=t=>t instanceof at?Me(t.schema):t instanceof ve?Me(t.innerType()):t instanceof ut?[t.value]:t instanceof ct?t.options:t instanceof lt?I.objectValues(t.enum):t instanceof dt?Me(t._def.innerType):t instanceof nt?[void 0]:t instanceof ot?[null]:t instanceof ge?[void 0,...Me(t.unwrap())]:t instanceof Oe?[null,...Me(t.unwrap())]:t instanceof Ht||t instanceof mt?Me(t.unwrap()):t instanceof pt?Me(t._def.innerType):[],yr=class t extends L{_parse(e){let{ctx:r}=this._processInputParams(e);if(r.parsedType!==v.object)return y(r,{code:f.invalid_type,expected:v.object,received:r.parsedType}),w;let n=this.discriminator,o=r.data[n],s=this.optionsMap.get(o);return s?r.common.async?s._parseAsync({data:r.data,path:r.path,parent:r}):s._parseSync({data:r.data,path:r.path,parent:r}):(y(r,{code:f.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),w)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,r,n){let o=new Map;for(let s of r){let i=Me(s.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let a of i){if(o.has(a))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(a)}`);o.set(a,s)}}return new t({typeName:S.ZodDiscriminatedUnion,discriminator:e,options:r,optionsMap:o,...O(n)})}};function Tn(t,e){let r=Re(t),n=Re(e);if(t===e)return{valid:!0,data:t};if(r===v.object&&n===v.object){let o=I.objectKeys(e),s=I.objectKeys(t).filter(a=>o.indexOf(a)!==-1),i={...t,...e};for(let a of s){let u=Tn(t[a],e[a]);if(!u.valid)return{valid:!1};i[a]=u.data}return{valid:!0,data:i}}else if(r===v.array&&n===v.array){if(t.length!==e.length)return{valid:!1};let o=[];for(let s=0;s<t.length;s++){let i=t[s],a=e[s],u=Tn(i,a);if(!u.valid)return{valid:!1};o.push(u.data)}return{valid:!0,data:o}}else return r===v.date&&n===v.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}var it=class extends L{_parse(e){let{status:r,ctx:n}=this._processInputParams(e),o=(s,i)=>{if(hr(s)||hr(i))return w;let a=Tn(s.value,i.value);return a.valid?((gr(s)||gr(i))&&r.dirty(),{status:r.value,value:a.data}):(y(n,{code:f.invalid_intersection_types}),w)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([s,i])=>o(s,i)):o(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}};it.create=(t,e,r)=>new it({left:t,right:e,typeName:S.ZodIntersection,...O(r)});var _e=class t extends L{_parse(e){let{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==v.array)return y(n,{code:f.invalid_type,expected:v.array,received:n.parsedType}),w;if(n.data.length<this._def.items.length)return y(n,{code:f.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),w;!this._def.rest&&n.data.length>this._def.items.length&&(y(n,{code:f.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),r.dirty());let s=[...n.data].map((i,a)=>{let u=this._def.items[a]||this._def.rest;return u?u._parse(new ye(n,i,n.path,a)):null}).filter(i=>!!i);return n.common.async?Promise.all(s).then(i=>oe.mergeArray(r,i)):oe.mergeArray(r,s)}get items(){return this._def.items}rest(e){return new t({...this._def,rest:e})}};_e.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new _e({items:t,typeName:S.ZodTuple,rest:null,...O(e)})};var vr=class t extends L{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==v.object)return y(n,{code:f.invalid_type,expected:v.object,received:n.parsedType}),w;let o=[],s=this._def.keyType,i=this._def.valueType;for(let a in n.data)o.push({key:s._parse(new ye(n,a,n.path,a)),value:i._parse(new ye(n,n.data[a],n.path,a)),alwaysSet:a in n.data});return n.common.async?oe.mergeObjectAsync(r,o):oe.mergeObjectSync(r,o)}get element(){return this._def.valueType}static create(e,r,n){return r instanceof L?new t({keyType:e,valueType:r,typeName:S.ZodRecord,...O(n)}):new t({keyType:Je.create(),valueType:e,typeName:S.ZodRecord,...O(r)})}},Lt=class extends L{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==v.map)return y(n,{code:f.invalid_type,expected:v.map,received:n.parsedType}),w;let o=this._def.keyType,s=this._def.valueType,i=[...n.data.entries()].map(([a,u],c)=>({key:o._parse(new ye(n,a,n.path,[c,"key"])),value:s._parse(new ye(n,u,n.path,[c,"value"]))}));if(n.common.async){let a=new Map;return Promise.resolve().then(async()=>{for(let u of i){let c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return w;(c.status==="dirty"||l.status==="dirty")&&r.dirty(),a.set(c.value,l.value)}return{status:r.value,value:a}})}else{let a=new Map;for(let u of i){let c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return w;(c.status==="dirty"||l.status==="dirty")&&r.dirty(),a.set(c.value,l.value)}return{status:r.value,value:a}}}};Lt.create=(t,e,r)=>new Lt({valueType:e,keyType:t,typeName:S.ZodMap,...O(r)});var Dt=class t extends L{_parse(e){let{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==v.set)return y(n,{code:f.invalid_type,expected:v.set,received:n.parsedType}),w;let o=this._def;o.minSize!==null&&n.data.size<o.minSize.value&&(y(n,{code:f.too_small,minimum:o.minSize.value,type:"set",inclusive:!0,exact:!1,message:o.minSize.message}),r.dirty()),o.maxSize!==null&&n.data.size>o.maxSize.value&&(y(n,{code:f.too_big,maximum:o.maxSize.value,type:"set",inclusive:!0,exact:!1,message:o.maxSize.message}),r.dirty());let s=this._def.valueType;function i(u){let c=new Set;for(let l of u){if(l.status==="aborted")return w;l.status==="dirty"&&r.dirty(),c.add(l.value)}return{status:r.value,value:c}}let a=[...n.data.values()].map((u,c)=>s._parse(new ye(n,u,n.path,c)));return n.common.async?Promise.all(a).then(u=>i(u)):i(a)}min(e,r){return new t({...this._def,minSize:{value:e,message:k.toString(r)}})}max(e,r){return new t({...this._def,maxSize:{value:e,message:k.toString(r)}})}size(e,r){return this.min(e,r).max(e,r)}nonempty(e){return this.min(1,e)}};Dt.create=(t,e)=>new Dt({valueType:t,minSize:null,maxSize:null,typeName:S.ZodSet,...O(e)});var xr=class t extends L{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:r}=this._processInputParams(e);if(r.parsedType!==v.function)return y(r,{code:f.invalid_type,expected:v.function,received:r.parsedType}),w;function n(a,u){return qt({data:a,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,Ct(),Ne].filter(c=>!!c),issueData:{code:f.invalid_arguments,argumentsError:u}})}function o(a,u){return qt({data:a,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,Ct(),Ne].filter(c=>!!c),issueData:{code:f.invalid_return_type,returnTypeError:u}})}let s={errorMap:r.common.contextualErrorMap},i=r.data;if(this._def.returns instanceof We){let a=this;return ce(async function(...u){let c=new me([]),l=await a._def.args.parseAsync(u,s).catch(m=>{throw c.addIssue(n(u,m)),c}),p=await Reflect.apply(i,this,l);return await a._def.returns._def.type.parseAsync(p,s).catch(m=>{throw c.addIssue(o(p,m)),c})})}else{let a=this;return ce(function(...u){let c=a._def.args.safeParse(u,s);if(!c.success)throw new me([n(u,c.error)]);let l=Reflect.apply(i,this,c.data),p=a._def.returns.safeParse(l,s);if(!p.success)throw new me([o(l,p.error)]);return p.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new t({...this._def,args:_e.create(e).rest($e.create())})}returns(e){return new t({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,r,n){return new t({args:e||_e.create([]).rest($e.create()),returns:r||$e.create(),typeName:S.ZodFunction,...O(n)})}},at=class extends L{get schema(){return this._def.getter()}_parse(e){let{ctx:r}=this._processInputParams(e);return this._def.getter()._parse({data:r.data,path:r.path,parent:r})}};at.create=(t,e)=>new at({getter:t,typeName:S.ZodLazy,...O(e)});var ut=class extends L{_parse(e){if(e.data!==this._def.value){let r=this._getOrReturnCtx(e);return y(r,{received:r.data,code:f.invalid_literal,expected:this._def.value}),w}return{status:"valid",value:e.data}}get value(){return this._def.value}};ut.create=(t,e)=>new ut({value:t,typeName:S.ZodLiteral,...O(e)});function ko(t,e){return new ct({values:t,typeName:S.ZodEnum,...O(e)})}var ct=class t extends L{_parse(e){if(typeof e.data!="string"){let r=this._getOrReturnCtx(e),n=this._def.values;return y(r,{expected:I.joinValues(n),received:r.parsedType,code:f.invalid_type}),w}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){let r=this._getOrReturnCtx(e),n=this._def.values;return y(r,{received:r.data,code:f.invalid_enum_value,options:n}),w}return ce(e.data)}get options(){return this._def.values}get enum(){let e={};for(let r of this._def.values)e[r]=r;return e}get Values(){let e={};for(let r of this._def.values)e[r]=r;return e}get Enum(){let e={};for(let r of this._def.values)e[r]=r;return e}extract(e,r=this._def){return t.create(e,{...this._def,...r})}exclude(e,r=this._def){return t.create(this.options.filter(n=>!e.includes(n)),{...this._def,...r})}};ct.create=ko;var lt=class extends L{_parse(e){let r=I.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==v.string&&n.parsedType!==v.number){let o=I.objectValues(r);return y(n,{expected:I.joinValues(o),received:n.parsedType,code:f.invalid_type}),w}if(this._cache||(this._cache=new Set(I.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let o=I.objectValues(r);return y(n,{received:n.data,code:f.invalid_enum_value,options:o}),w}return ce(e.data)}get enum(){return this._def.values}};lt.create=(t,e)=>new lt({values:t,typeName:S.ZodNativeEnum,...O(e)});var We=class extends L{unwrap(){return this._def.type}_parse(e){let{ctx:r}=this._processInputParams(e);if(r.parsedType!==v.promise&&r.common.async===!1)return y(r,{code:f.invalid_type,expected:v.promise,received:r.parsedType}),w;let n=r.parsedType===v.promise?r.data:Promise.resolve(r.data);return ce(n.then(o=>this._def.type.parseAsync(o,{path:r.path,errorMap:r.common.contextualErrorMap})))}};We.create=(t,e)=>new We({type:t,typeName:S.ZodPromise,...O(e)});var ve=class extends L{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===S.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:r,ctx:n}=this._processInputParams(e),o=this._def.effect||null,s={addIssue:i=>{y(n,i),i.fatal?r.abort():r.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),o.type==="preprocess"){let i=o.transform(n.data,s);if(n.common.async)return Promise.resolve(i).then(async a=>{if(r.value==="aborted")return w;let u=await this._def.schema._parseAsync({data:a,path:n.path,parent:n});return u.status==="aborted"?w:u.status==="dirty"?Xe(u.value):r.value==="dirty"?Xe(u.value):u});{if(r.value==="aborted")return w;let a=this._def.schema._parseSync({data:i,path:n.path,parent:n});return a.status==="aborted"?w:a.status==="dirty"?Xe(a.value):r.value==="dirty"?Xe(a.value):a}}if(o.type==="refinement"){let i=a=>{let u=o.refinement(a,s);if(n.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return a};if(n.common.async===!1){let a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return a.status==="aborted"?w:(a.status==="dirty"&&r.dirty(),i(a.value),{status:r.value,value:a.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>a.status==="aborted"?w:(a.status==="dirty"&&r.dirty(),i(a.value).then(()=>({status:r.value,value:a.value}))))}if(o.type==="transform")if(n.common.async===!1){let i=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Be(i))return w;let a=o.transform(i.value,s);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:r.value,value:a}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(i=>Be(i)?Promise.resolve(o.transform(i.value,s)).then(a=>({status:r.value,value:a})):w);I.assertNever(o)}};ve.create=(t,e,r)=>new ve({schema:t,typeName:S.ZodEffects,effect:e,...O(r)});ve.createWithPreprocess=(t,e,r)=>new ve({schema:e,effect:{type:"preprocess",transform:t},typeName:S.ZodEffects,...O(r)});var ge=class extends L{_parse(e){return this._getType(e)===v.undefined?ce(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};ge.create=(t,e)=>new ge({innerType:t,typeName:S.ZodOptional,...O(e)});var Oe=class extends L{_parse(e){return this._getType(e)===v.null?ce(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Oe.create=(t,e)=>new Oe({innerType:t,typeName:S.ZodNullable,...O(e)});var dt=class extends L{_parse(e){let{ctx:r}=this._processInputParams(e),n=r.data;return r.parsedType===v.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:r.path,parent:r})}removeDefault(){return this._def.innerType}};dt.create=(t,e)=>new dt({innerType:t,typeName:S.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...O(e)});var pt=class extends L{_parse(e){let{ctx:r}=this._processInputParams(e),n={...r,common:{...r.common,issues:[]}},o=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Rt(o)?o.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new me(n.common.issues)},input:n.data})})):{status:"valid",value:o.status==="valid"?o.value:this._def.catchValue({get error(){return new me(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}};pt.create=(t,e)=>new pt({innerType:t,typeName:S.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...O(e)});var Pt=class extends L{_parse(e){if(this._getType(e)!==v.nan){let n=this._getOrReturnCtx(e);return y(n,{code:f.invalid_type,expected:v.nan,received:n.parsedType}),w}return{status:"valid",value:e.data}}};Pt.create=t=>new Pt({typeName:S.ZodNaN,...O(t)});var Zi=Symbol("zod_brand"),Ht=class extends L{_parse(e){let{ctx:r}=this._processInputParams(e),n=r.data;return this._def.type._parse({data:n,path:r.path,parent:r})}unwrap(){return this._def.type}},Kt=class t extends L{_parse(e){let{status:r,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{let s=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?w:s.status==="dirty"?(r.dirty(),Xe(s.value)):this._def.out._parseAsync({data:s.value,path:n.path,parent:n})})();{let o=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?w:o.status==="dirty"?(r.dirty(),{status:"dirty",value:o.value}):this._def.out._parseSync({data:o.value,path:n.path,parent:n})}}static create(e,r){return new t({in:e,out:r,typeName:S.ZodPipeline})}},mt=class extends L{_parse(e){let r=this._def.innerType._parse(e),n=o=>(Be(o)&&(o.value=Object.freeze(o.value)),o);return Rt(r)?r.then(o=>n(o)):n(r)}unwrap(){return this._def.innerType}};mt.create=(t,e)=>new mt({innerType:t,typeName:S.ZodReadonly,...O(e)});function yo(t,e){let r=typeof t=="function"?t(e):typeof t=="string"?{message:t}:t;return typeof r=="string"?{message:r}:r}function To(t,e={},r){return t?Ue.create().superRefine((n,o)=>{let s=t(n);if(s instanceof Promise)return s.then(i=>{if(!i){let a=yo(e,n),u=a.fatal??r??!0;o.addIssue({code:"custom",...a,fatal:u})}});if(!s){let i=yo(e,n),a=i.fatal??r??!0;o.addIssue({code:"custom",...i,fatal:a})}}):Ue.create()}var qi={object:fe.lazycreate},S;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(S||(S={}));var Hi=(t,e={message:`Input not instance of ${t.name}`})=>To(r=>r instanceof t,e),Eo=Je.create,wo=Qe.create,Ki=Pt.create,Yi=et.create,So=tt.create,Xi=rt.create,Qi=Ot.create,ea=nt.create,ta=ot.create,ra=Ue.create,na=$e.create,oa=ke.create,sa=At.create,ia=Fe.create,aa=fe.create,ua=fe.strictCreate,ca=st.create,la=yr.create,da=it.create,pa=_e.create,ma=vr.create,fa=Lt.create,ha=Dt.create,ga=xr.create,ya=at.create,va=ut.create,xa=ct.create,ba=lt.create,ka=We.create,Ta=ve.create,Ea=ge.create,wa=Oe.create,Sa=ve.createWithPreprocess,Ca=Kt.create,Ra=()=>Eo().optional(),_a=()=>wo().optional(),Oa=()=>So().optional(),Aa={string:(t=>Je.create({...t,coerce:!0})),number:(t=>Qe.create({...t,coerce:!0})),boolean:(t=>tt.create({...t,coerce:!0})),bigint:(t=>et.create({...t,coerce:!0})),date:(t=>rt.create({...t,coerce:!0}))};var La=w;function Ae(t,e={}){let{structural:r=!0,stripFormatting:n=!0}=e,o=t,s=[];try{if(n){let{text:u,applied:c}=Da(o);o=u,s.push(...c)}if(r){let{text:u,applied:c}=Pa(o);o=u,s.push(...c)}let{text:i,applied:a}=Ia(o);return o=i,s.push(...a),JSON.parse(o),{corrected:o,success:!0,corrections:s}}catch(i){return{corrected:o,success:!1,corrections:s,error:i instanceof Error?i:new Error(String(i))}}}function Da(t){let e=t,r=[],n=/^```(?:json)?\s*\n?([\s\S]*?)\n?```\s*$/;if(n.test(e))e=e.replace(n,"$1"),r.push("strip_markdown_fence");else{let i=/```(?:json)?\s*\n([\s\S]*?)\n[ \t]*```(?:\s*$|\n)/,a=e.match(i);a&&a[1]&&(e=a[1],r.push("strip_markdown_fence"))}e.trim().startsWith("json")&&(e=e.trim().replace(/^json\s*/i,""),r.push("strip_json_prefix"));let o=[/^Here's the JSON:?\s*/i,/^Here is the JSON:?\s*/i,/^The JSON is:?\s*/i,/^Sure,? here's the JSON:?\s*/i,/^Certainly[,!]? here's the JSON:?\s*/i,/^Output:?\s*/i,/^Result:?\s*/i,/^Response:?\s*/i,/^As an AI[^{]*/i,/^I can help[^{]*/i];for(let i of o)if(i.test(e)){e=e.replace(i,""),r.push("remove_prefix_text");break}let s=[/[\]}]\s*\n\n.*$/s,/[\]}]\s*I hope this helps.*$/is,/[\]}]\s*Let me know if.*$/is,/[\]}]\s*This JSON.*$/is];for(let i of s)if(i.test(e)){let a=e.lastIndexOf("}"),u=e.lastIndexOf("]"),c=Math.max(a,u);if(c!==-1){e=e.substring(0,c+1),r.push("remove_suffix_text");break}}return/\/\*[\s\S]*?\*\/|\/\/.*$/gm.test(e)&&(e=e.replace(/\/\*[\s\S]*?\*\//g,"").replace(/\/\/.*$/gm,""),r.push("remove_comments")),e=e.trim(),{text:e,applied:r}}function Pa(t){let e=t,r=[],n=(e.match(/{/g)||[]).length,o=(e.match(/}/g)||[]).length,s=(e.match(/\[/g)||[]).length,i=(e.match(/\]/g)||[]).length;if(n>o){let u=n-o;e+="}".repeat(u),r.push("close_brace")}if(s>i){let u=s-i;e+="]".repeat(u),r.push("close_bracket")}let a=/,(\s*[}\]])/g;return a.test(e)&&(e=e.replace(a,"$1"),r.push("remove_trailing_comma")),e.trim().endsWith(",")&&(e=e.trim().slice(0,-1),r.push("remove_trailing_comma")),{text:e,applied:r}}function Ia(t){let e=t,r=[];try{JSON.parse(e)}catch(n){n instanceof Error&&(n.message.includes("control character")||n.message.includes("Bad control character"))&&(e=e.replace(/"([^"\\]*(?:\\.[^"\\]*)*)"/g,(o,s)=>`"${s.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")}"`),r.push("escape_control_chars"))}return{text:e,applied:r}}function Na(t){let e=!1,r=!1;for(let n=0;n<t.length;n++){let o=t[n];if(r){r=!1;continue}if(o==="\\"){r=!0;continue}if(o==='"'){e=!e;continue}if(!e){if(o==="{")return{startIndex:n,openChar:"{",closeChar:"}"};if(o==="[")return{startIndex:n,openChar:"[",closeChar:"]"}}}return null}function Xt(t){let e=Na(t);if(!e)return t;let{startIndex:r,openChar:n,closeChar:o}=e,s=0,i=!1,a=!1;for(let l=r;l<t.length;l++){let p=t[l];if(a){a=!1;continue}if(p==="\\"){a=!0;continue}if(p==='"'){i=!i;continue}if(!i){if(p===n)s++;else if(p===o&&(s--,s===0))return t.substring(r,l+1)}}let u=t.match(/\{[\s\S]*\}/);if(u)return u[0];let c=t.match(/\[[\s\S]*\]/);return c?c[0]:t}function En(t){try{return JSON.parse(t),!0}catch{return!1}}function wn(t){let e=t.message.toLowerCase();return e.includes("unexpected end")?"Incomplete JSON - missing closing braces or brackets":e.includes("unexpected token")?"Invalid JSON syntax - unexpected character":e.includes("control character")?"Invalid control characters in string values":e.includes("trailing comma")?"Trailing commas not allowed in JSON":e.includes("expected property name")?"Invalid property name - must be quoted":t.message}function Ma(t){let e=Ae(t,{structural:!0,stripFormatting:!0});if(e.success)return e.corrected;let r=Xt(t);if(r!==t){let s=Ae(r,{structural:!0,stripFormatting:!0});if(s.success)return s.corrected}let n=t.trim();n=n.replace(/'([^']*?)'/g,'"$1"');let o=Ae(n,{structural:!0,stripFormatting:!0});if(o.success)return o.corrected;throw new Error(`Unable to repair JSON: ${wn(o.error)}`)}function $a(t,e={}){try{return{data:JSON.parse(t),corrected:!1,corrections:[]}}catch{let r=Ae(t,e);if(r.success)return{data:JSON.parse(r.corrected),corrected:!0,corrections:r.corrections};throw new Error(`Failed to parse JSON: ${wn(r.error)}`)}}async function It(t){let{schema:e,stream:r,fallbackStreams:n=[],retry:o={},autoCorrect:s=!0,strictMode:i=!1,timeout:a,signal:u,monitoring:c,detectZeroTokens:l,onValidationError:p,onAutoCorrect:h,onRetry:m}=t,g=0,T=0,b=0,R=[],M=[],z="",W="",C=[],E=!1,x=[],D=0,te=0,K=new AbortController,ie={stream:async()=>r(),fallbackStreams:n,retry:{attempts:o.attempts??2,backoff:o.backoff??"fixed-jitter",baseDelay:o.baseDelay??1e3,maxDelay:o.maxDelay??5e3,retryOn:[...o.retryOn||[],"guardrail_violation","incomplete"],errorTypeDelays:o.errorTypeDelays},timeout:a,signal:u||K.signal,detectZeroTokens:l??!1,monitoring:{enabled:c?.enabled??!1,sampleRate:c?.sampleRate??1,metadata:{...c?.metadata||{},structured:!0,schemaName:e.description||"unknown"}},guardrails:[{name:"json-structure",check:d=>d.completed&&!En(d.content)?[{rule:"json-structure",message:"Output is not valid JSON",severity:"error",recoverable:!0}]:[]}],onRetry:(d,X)=>{m&&m(d,X)}},ne=o.attempts??2,Z=0;for(;Z<=ne;)try{let d=await ue(ie);z="";for await(let j of d.stream)j.type==="token"&&j.value?z+=j.value:j.type==="error"&&x.push(j.error||new Error("Unknown error"));if(!z||z.trim().length===0)throw new Error("No output received from model");if(D=Date.now(),g++,W=z,C=[],s){let j=Ae(W,{structural:!0,stripFormatting:!0,schemaBased:!1,strict:i});if(j.corrections.length>0&&(E=!0,W=j.corrected,C=j.corrections,b++,R.push(...j.corrections),h)){let q={original:z,corrected:W,corrections:j.corrections,success:j.success};h(q)}}let X;try{X=JSON.parse(W)}catch(j){let q=j instanceof Error?j:new Error(String(j));x.push(q);let G=Xt(W);if(G!==W)try{X=JSON.parse(G),W=G,E=!0,C.includes("extract_json")||(C.push("extract_json"),R.push("extract_json")),b++}catch{let N=Ae(G,{structural:!0,stripFormatting:!0});if(N.success)X=JSON.parse(N.corrected),W=N.corrected,E=!0,C.push(...N.corrections),b++,R.push(...N.corrections);else throw new Error(`Invalid JSON after auto-correction: ${q.message}`)}else if(s){let N=Xt(z);if(N!==z){let B=Ae(N,{structural:!0,stripFormatting:!0});if(B.success)try{X=JSON.parse(B.corrected),W=B.corrected,E=!0,C.push("extract_json",...B.corrections),b++,R.push("extract_json",...B.corrections)}catch{throw new Error(`Invalid JSON after auto-correction: ${q.message}`)}else throw new Error(`Invalid JSON after auto-correction: ${q.message}`)}else throw new Error(`Invalid JSON after auto-correction: ${q.message}`)}else{let N=Ae(W,{structural:!0,stripFormatting:!0});if(N.success)X=JSON.parse(N.corrected),W=N.corrected,E=!0,C.push(...N.corrections),b++,R.push(...N.corrections);else throw new Error(`Invalid JSON: ${q.message}`)}}let le=e.safeParse(X);if(!le.success){if(T++,M.push(le.error),p&&p(le.error,Z),Z<ne){Z++,m&&m(Z,`Schema validation failed: ${le.error.errors[0]?.message}`);continue}throw new Error(`Schema validation failed after ${g} attempts: ${JSON.stringify(le.error.errors)}`)}te=Date.now();let xt={...d.state,validationFailures:T,autoCorrections:b,validationErrors:M},A;return d.telemetry&&(A={...d.telemetry,structured:{schemaName:e.description||"unknown",validationAttempts:g,validationFailures:T,autoCorrections:b,correctionTypes:Array.from(new Set(R)),validationSuccess:!0,validationTime:te-D}}),{data:le.data,raw:z,corrected:E,corrections:C,state:xt,telemetry:A,errors:x,abort:()=>K.abort()}}catch(d){let X=d instanceof Error?d:new Error(String(d));if(x.push(X),Z<ne){Z++,m&&m(Z,X.message);continue}throw new Error(`Structured output failed after ${Z+1} attempts: ${X.message}`)}throw new Error("Unexpected: exhausted retry loop without result")}async function Fa(t,e){let r=Yt.object(t);return It({...e,schema:r})}async function ja(t,e){let r=Yt.array(t);return It({...e,schema:r})}async function Ga(t){let e=new AbortController,r=It({...t,signal:e.signal});return{stream:(await ue({stream:t.stream,fallbackStreams:t.fallbackStreams,retry:t.retry,timeout:t.timeout,signal:e.signal,monitoring:t.monitoring,onRetry:t.onRetry})).stream,result:r,abort:()=>e.abort()}}var Va={autoCorrect:!1,strictMode:!1,retry:{attempts:1,backoff:"fixed",baseDelay:500}},za={autoCorrect:!0,strictMode:!1,retry:{attempts:2,backoff:"fixed-jitter",baseDelay:1e3,maxDelay:5e3}},Ba={autoCorrect:!0,strictMode:!0,retry:{attempts:3,backoff:"fixed-jitter",baseDelay:1e3,maxDelay:1e4}};function Cn(t,e){let{strategy:r}=e;switch(r){case"token":return Sn(t,e);case"char":return br(t,e);case"paragraph":return Co(t,e);case"sentence":return Ro(t,e);default:return Sn(t,e)}}function Sn(t,e){let{size:r,overlap:n,estimateTokens:o,preserveParagraphs:s}=e,i=[],a=0;for(;a<t.length;){let u=a,c=0;for(;u<t.length&&c<r;)u++,u%4===0&&c++;if(s&&u<t.length){let m=t.indexOf(`

`,u),g=t.lastIndexOf(`

`,u);m!==-1&&m-u<100?u=m+2:g>a&&u-g<100&&(u=g+2)}let l=t.slice(a,u).trim();l.length>0&&i.push({index:i.length,content:l,startPos:a,endPos:u,tokenCount:o(l),charCount:l.length,isFirst:i.length===0,isLast:u>=t.length,totalChunks:0,metadata:e.metadata});let p=Math.floor(n*4);a=u-p;let h=i[i.length-1];h&&a<=h.startPos&&(a=u)}return i.forEach(u=>{u.totalChunks=i.length,u.isLast=u.index===i.length-1}),i}function br(t,e){let{size:r,overlap:n,estimateTokens:o,preserveParagraphs:s}=e,i=[],a=0;for(;a<t.length;){let u=Math.min(a+r,t.length);if(s&&u<t.length){let p=t.indexOf(`

`,u),h=t.lastIndexOf(`

`,u);p!==-1&&p-u<100?u=p+2:h>a&&u-h<100&&(u=h+2)}let c=t.slice(a,u).trim();c.length>0&&i.push({index:i.length,content:c,startPos:a,endPos:u,tokenCount:o(c),charCount:c.length,isFirst:i.length===0,isLast:u>=t.length,totalChunks:0,metadata:e.metadata}),a=u-n;let l=i[i.length-1];l&&a<=l.startPos&&(a=u)}return i.forEach(u=>{u.totalChunks=i.length,u.isLast=u.index===i.length-1}),i}function Co(t,e){let{size:r,overlap:n,estimateTokens:o}=e,s=t.split(/\n\n+/).filter(l=>l.trim().length>0),i=[],a=[],u=0,c=0;for(let l=0;l<s.length;l++){let p=s[l].trim(),h=o(p);if(h>r){if(a.length>0){let g=a.join(`

`);i.push(Nt(g,c,t,i.length,o,e.metadata)),a=[],u=0}br(p,{...e,size:r,overlap:0}).forEach(g=>{i.push({...g,index:i.length,startPos:t.indexOf(g.content,c)})}),c=t.indexOf(p,c)+p.length;continue}if(u+h>r&&a.length>0){let m=a.join(`

`);i.push(Nt(m,c,t,i.length,o,e.metadata));let g=[],T=0;for(let b=a.length-1;b>=0;b--){let R=a[b],M=o(R);if(T+M<=n)g.unshift(R),T+=M;else break}a=g,u=T,c=t.indexOf(a[0]||p,c)}a.push(p),u+=h}if(a.length>0){let l=a.join(`

`);i.push(Nt(l,c,t,i.length,o,e.metadata))}return i.forEach(l=>{l.totalChunks=i.length,l.isFirst=l.index===0,l.isLast=l.index===i.length-1}),i}function Ro(t,e){let{size:r,overlap:n,estimateTokens:o}=e,s=_o(t),i=[],a=[],u=0,c=0;for(let l of s){let p=o(l);if(p>r){if(a.length>0){let m=a.join(" ");i.push(Nt(m,c,t,i.length,o,e.metadata)),a=[],u=0}br(l,{...e,size:r,overlap:0}).forEach(m=>{i.push({...m,index:i.length,startPos:t.indexOf(m.content,c)})}),c=t.indexOf(l,c)+l.length;continue}if(u+p>r&&a.length>0){let h=a.join(" ");i.push(Nt(h,c,t,i.length,o,e.metadata));let m=[],g=0;for(let T=a.length-1;T>=0;T--){let b=a[T],R=o(b);if(g+R<=n)m.unshift(b),g+=R;else break}a=m,u=g,c=t.indexOf(a[0]||l,c)}a.push(l),u+=p}if(a.length>0){let l=a.join(" ");i.push(Nt(l,c,t,i.length,o,e.metadata))}return i.forEach(l=>{l.totalChunks=i.length,l.isFirst=l.index===0,l.isLast=l.index===i.length-1}),i}function _o(t){let e=[],r=/[.!?]+[\s\n]+(?=[A-Z])|[.!?]+$/g,n=0,o;for(;(o=r.exec(t))!==null;){let s=t.slice(n,o.index+o[0].length).trim();s.length>0&&e.push(s),n=o.index+o[0].length}if(n<t.length){let s=t.slice(n).trim();s.length>0&&e.push(s)}return e}function Nt(t,e,r,n,o,s){let i=r.indexOf(t,e);return{index:n,content:t,startPos:i!==-1?i:e,endPos:i!==-1?i+t.length:e+t.length,tokenCount:o(t),charCount:t.length,isFirst:n===0,isLast:!1,totalChunks:0,metadata:s}}function Rn(t){let e=t.length,r=t.split(/\s+/).length,n=Math.ceil(e/4),o=Math.ceil(r*1.3);return Math.ceil((n+o)/2)}function Oo(t,e){if(t.endPos<=e.startPos||e.endPos<=t.startPos)return null;let r=Math.max(t.startPos,e.startPos),n=Math.min(t.endPos,e.endPos),o=t.content.slice(-(t.endPos-r)),s=e.content.slice(0,n-e.startPos);return o.length<=s.length?o:s}function _n(t,e=!1){if(t.length===0)return"";if(t.length===1)return t[0].content;if(e)return t.map(n=>n.content).join(`

`);let r=[t[0].content];for(let n=1;n<t.length;n++){let o=t[n-1],s=t[n],i=Oo(o,s);if(i){let a=s.content.indexOf(i);a!==-1?r.push(s.content.slice(a+i.length)):r.push(s.content)}else r.push(s.content)}return r.join("")}var Ja={size:2e3,overlap:200,strategy:"token",estimateTokens:Rn,preserveParagraphs:!0,preserveSentences:!1,metadata:{}},kr=class{document;options;chunks;_currentIndex=0;constructor(e,r={}){if(this.document=e,this.options={...Ja,...r},this.chunks=Cn(e,this.options),this.chunks.length===0)throw new Error("Document resulted in zero chunks")}get totalChunks(){return this.chunks.length}get currentIndex(){return this._currentIndex}get(e){return e<0||e>=this.chunks.length?null:this.chunks[e]??null}current(){return this.get(this._currentIndex)}next(){return this._currentIndex<this.chunks.length-1?(this._currentIndex++,this.current()):null}prev(){return this._currentIndex>0?(this._currentIndex--,this.current()):null}jump(e){return e<0||e>=this.chunks.length?null:(this._currentIndex=e,this.current())}reset(){return this._currentIndex=0,this.current()}getAllChunks(){return[...this.chunks]}getRange(e,r){let n=Math.max(0,e),o=Math.min(this.chunks.length,r);return this.chunks.slice(n,o)}hasNext(){return this._currentIndex<this.chunks.length-1}hasPrev(){return this._currentIndex>0}async processAll(e){return this.processParallel(e)}async processSequential(e){let r=[];for(let n of this.chunks){let o=Date.now();try{let s=e(n),i=await ue(s);for await(let a of i.stream);r.push({chunk:n,result:i,status:"success",duration:Date.now()-o})}catch(s){r.push({chunk:n,result:void 0,status:"error",error:s instanceof Error?s:new Error(String(s)),duration:Date.now()-o})}}return r}async processParallel(e,r={}){let{concurrency:n=5}=r,o=new Array(this.chunks.length),s=[...this.chunks],i=0,a=0;return new Promise((u,c)=>{let l=()=>{for(;i<n&&s.length>0;){let p=s.shift(),h=a++;i++;let m=Date.now();(async()=>{try{let g=e(p),T=await ue(g);for await(let b of T.stream);o[h]={chunk:p,result:T,status:"success",duration:Date.now()-m}}catch(g){o[h]={chunk:p,result:void 0,status:"error",error:g instanceof Error?g:new Error(String(g)),duration:Date.now()-m}}finally{i--,s.length>0?l():i===0&&u(o)}})()}};l()})}getStats(){let e=this.document.length,r=this.options.estimateTokens(this.document),n=this.chunks.reduce((s,i)=>s+i.charCount,0)/this.chunks.length,o=this.chunks.reduce((s,i)=>s+i.tokenCount,0)/this.chunks.length;return{totalChunks:this.chunks.length,totalChars:e,totalTokens:r,avgChunkSize:Math.round(n),avgChunkTokens:Math.round(o),overlapSize:this.options.overlap,strategy:this.options.strategy}}getContext(e,r={}){let{before:n=0,after:o=0}=r,s=Math.max(0,e-n),i=Math.min(this.chunks.length,e+o+1),a=this.chunks.slice(s,i);return _n(a,!1)}findChunks(e,r=!1){let n=r?e:e.toLowerCase();return this.chunks.filter(o=>(r?o.content:o.content.toLowerCase()).includes(n))}getChunksInRange(e,r){return this.chunks.filter(n=>n.startPos>=e&&n.startPos<r||n.endPos>e&&n.endPos<=r||n.startPos<=e&&n.endPos>=r)}};function Ao(t,e){return new kr(t,e)}async function Ua(t,e,r){return Ao(t,r).processAll(e)}async function Wa(t){let{window:e,chunkIndex:r=0,contextRestoration:n,...o}=t;if(!e)throw new Error("Window is required");if(!e.get(r))throw new Error(`Invalid chunk index: ${r}`);let{enabled:i=!0,strategy:a="adjacent",maxAttempts:u=_.attempts,onRestore:c}=n||{},l=r,p=0;for(;p<=u;)try{let h=await ue(o);if(h.state.driftDetected&&i&&p<u){let m=null;switch(a){case"adjacent":e.hasNext()?m=l+1:l>0&&(m=l-1);break;case"overlap":e.hasNext()&&(m=l+1);break;case"full":e.hasNext()?m=l+1:l>0&&(m=l-1);break}if(m!==null){l=m,p++,c&&c(r,m);continue}}return h}catch(h){if(p>=u)throw h;p++}throw new Error("Context restoration failed after max attempts")}function Za(t,e=`

`){return t.filter(r=>r.status==="success"&&r.result?.state?.content).map(r=>r.result.state.content).join(e)}function qa(t){let e=t.length,r=t.filter(a=>a.status==="success").length,n=t.filter(a=>a.status==="error").length,o=e>0?r/e*100:0,s=t.reduce((a,u)=>a+u.duration,0),i=e>0?s/e:0;return{total:e,successful:r,failed:n,successRate:o,avgDuration:Math.round(i),totalDuration:s}}var Ha={name:"small",size:1e3,overlap:100,strategy:"token"},Ka={name:"medium",size:2e3,overlap:200,strategy:"token"},Ya={name:"large",size:4e3,overlap:400,strategy:"token"},Xa={name:"paragraph",size:2e3,overlap:200,strategy:"paragraph"},Qa={name:"sentence",size:1500,overlap:150,strategy:"sentence"};function eu(t){let e=0,r=0,n=0,o=0,s=!1,i=!1,a=[];for(let c=0;c<t.length;c++){let l=t[c];if(i){i=!1;continue}if(l==="\\"){i=!0;continue}if(l==='"'){s=!s;continue}s||(l==="{"&&e++,l==="}"&&r++,l==="["&&n++,l==="]"&&o++)}return s&&a.push("Unclosed string detected"),e!==r&&a.push(`Unbalanced braces: ${e} open, ${r} close`),n!==o&&a.push(`Unbalanced brackets: ${n} open, ${o} close`),{openBraces:e,closeBraces:r,openBrackets:n,closeBrackets:o,inString:s,isBalanced:e===r&&n===o&&!s,issues:a}}function Tr(t){if(!t)return!1;let e=t.trim();return e.startsWith("{")||e.startsWith("[")}function tu(t){let{content:e,completed:r}=t,n=[];if(!Tr(e))return n;let o=eu(e);if(!r)o.closeBraces>o.openBraces&&n.push({rule:"json-structure",message:`Too many closing braces: ${o.closeBraces} close, ${o.openBraces} open`,severity:"error",recoverable:!0}),o.closeBrackets>o.openBrackets&&n.push({rule:"json-structure",message:`Too many closing brackets: ${o.closeBrackets} close, ${o.openBrackets} open`,severity:"error",recoverable:!0});else if(!o.isBalanced)for(let s of o.issues)n.push({rule:"json-structure",message:s,severity:"error",recoverable:!0,suggestion:"Retry generation to get properly balanced JSON"});return n}function ru(t){let{content:e,delta:r}=t,n=[];if(!r||!Tr(e))return n;let o=[{pattern:/,,+/,message:"Multiple consecutive commas"},{pattern:/\{\s*,/,message:"Comma immediately after opening brace"},{pattern:/\[\s*,/,message:"Comma immediately after opening bracket"},{pattern:/:\s*,/,message:"Comma immediately after colon"}];for(let{pattern:s,message:i}of o)s.test(e)&&n.push({rule:"json-chunks",message:`Malformed JSON: ${i}`,severity:"error",recoverable:!0});return n}function Lo(t){let{content:e,completed:r}=t,n=[];if(!r||!Tr(e))return n;try{JSON.parse(e.trim())}catch(o){n.push({rule:"json-parseable",message:`JSON is not parseable: ${o instanceof Error?o.message:"Unknown error"}`,severity:"error",recoverable:!0,suggestion:"Retry generation to get valid JSON"})}return n}function Mt(){return{name:"json-structure",description:"Validates JSON structure and balance",streaming:!0,severity:"error",recoverable:!0,check:t=>{let e=[];return e.push(...tu(t)),e.push(...ru(t)),t.completed&&e.push(...Lo(t)),e}}}function nu(){return{name:"json-strict",description:"Strict JSON validation including structure and parseability",streaming:!1,severity:"error",recoverable:!0,check:t=>{let e=[];if(!t.completed)return e;let{content:r}=t;if(!Tr(r))return e.push({rule:"json-strict",message:"Content does not appear to be JSON (must start with { or [)",severity:"error",recoverable:!0}),e;if(e.push(...Lo(t)),e.length===0)try{let n=JSON.parse(r.trim());(typeof n!="object"||n===null)&&e.push({rule:"json-strict",message:"JSON root must be an object or array",severity:"error",recoverable:!0})}catch{}return e}}}var ou=/^(#{1,6})\s+/,su=/^(\s*)([-*+]|\d+\.)\s+/,iu=/^\|?[\s-:|]+\|[\s-:|]*$/,Do=/\|/g,au=/^(\s*)([-*+])\s+/,uu=/^(\s*)(\d+)\.\s+/,cu=/^\s*$/,lu=/[.!?;:\]})"`']$/,du=/^#{1,6}\s+/,pu=/^[-*+]\s+/,mu=/^\d+\.\s+/,fu=[/^#{1,6}\s+/m,/```/,/^\s*[-*+]\s+/m,/^\s*\d+\.\s+/m,/\*\*.*\*\*/,/\*.*\*/,/\[.*\]\(.*\)/,/^>\s+/m];function Po(t){let e=[],r=t.split(`
`),n=[],o=[],s=0,i=!1,a=0;for(let u=0;u<r.length;u++){let c=r[u];if(c.trimStart().startsWith("```"))if(i=!i,i){s++;let l=c.trim().slice(3).trim();l&&n.push(l)}else s--;if(!i){let l=c.match(ou);l&&l[1]&&o.push(l[1].length);let p=c.match(su);if(p&&p[1]!==void 0){let h=p[1].length,m=Math.floor(h/2)+1;a=Math.max(a,m)}}}return(i||s!==0)&&e.push(`Unbalanced code fences: ${Math.abs(s)} unclosed`),{openFences:Math.max(0,s),fenceLanguages:n,inFence:i,headers:o,listDepth:a,issues:e}}function hu(t){return t?fu.some(e=>e.test(t)):!1}function gu(t){let{content:e,completed:r}=t,n=[],o=Po(e);return!r&&o.inFence?o.openFences>5&&n.push({rule:"markdown-fences",message:`Excessive unclosed code fences: ${o.openFences}`,severity:"warning",recoverable:!0}):r&&o.openFences!==0&&n.push({rule:"markdown-fences",message:`Unclosed code fences: ${o.openFences} fence(s) not closed`,severity:"error",recoverable:!0,suggestion:"Retry generation to properly close code fences"}),n}function yu(t){let{content:e,completed:r}=t,n=[];if(!r)return n;let o=e.split(`
`),s=!1,i=0;for(let a=0;a<o.length;a++){let u=o[a];if(iu.test(u)){s=!0,i=(u.match(Do)||[]).length;continue}if(s)if(u.includes("|")){let c=(u.match(Do)||[]).length;c!==i&&n.push({rule:"markdown-tables",message:`Inconsistent table columns at line ${a+1}: expected ${i}, got ${c}`,severity:"warning",recoverable:!0})}else u.trim().length>0&&(s=!1)}return n}function vu(t){let{content:e,completed:r}=t,n=[];if(!r)return n;let o=e.split(`
`),s=null,i=-1;for(let a=0;a<o.length;a++){let u=o[a],c=u.match(au);if(c&&c[1]!==void 0){let p=c[1].length;s==="ordered"&&i===p&&n.push({rule:"markdown-lists",message:`Mixed list types at line ${a+1}: switching from ordered to unordered at same level`,severity:"warning",recoverable:!0}),s="unordered",i=p;continue}let l=u.match(uu);if(l&&l[1]!==void 0){let p=l[1].length;s==="unordered"&&i===p&&n.push({rule:"markdown-lists",message:`Mixed list types at line ${a+1}: switching from unordered to ordered at same level`,severity:"warning",recoverable:!0}),s="ordered",i=p;continue}u.trim().length>0&&!cu.test(u)&&(s=null,i=-1)}return n}function xu(t){let{content:e,completed:r}=t,n=[];if(!r)return n;let o=Po(e);o.inFence&&n.push({rule:"markdown-complete",message:"Content ends inside code fence",severity:"error",recoverable:!0,suggestion:"Retry to complete the code fence"});let i=e.trim().split(`
`),a=i[i.length-1]??"";return!o.inFence&&a.trim().length>0&&!lu.test(a)&&!du.test(a)&&!pu.test(a)&&!mu.test(a)&&n.push({rule:"markdown-complete",message:"Content appears to end abruptly mid-sentence",severity:"warning",recoverable:!0}),n}function Qt(){return{name:"markdown-structure",description:"Validates Markdown fences, blocks, and structure",streaming:!0,severity:"error",recoverable:!0,check:t=>{let e=[];return!hu(t.content)&&t.content.length>50||(e.push(...gu(t)),t.completed&&(e.push(...yu(t)),e.push(...vu(t)),e.push(...xu(t)))),e}}}var Io=/\\begin\{(\w+)\}/g,No=/\\end\{(\w+)\}/g,Mo=/\\\[/g,$o=/\\\]/g,Fo=/\$\$/g,bu=[/\\begin\{/,/\\end\{/,/\\\[/,/\\\]/,/\$\$/,/\\[a-zA-Z]+\{/,/\\section/,/\\subsection/,/\\textbf/,/\\textit/,/\\frac/,/\\sum/,/\\int/];function ku(t){let e=[],r=[],n=[];Io.lastIndex=0,No.lastIndex=0;let o=[],s=[],i;for(;(i=Io.exec(t))!==null;)o.push({env:i[1],pos:i.index});for(;(i=No.exec(t))!==null;)s.push({env:i[1],pos:i.index});let a=[...o.map(c=>({...c,type:"begin"})),...s.map(c=>({...c,type:"end"}))].sort((c,l)=>c.pos-l.pos);for(let c of a)if(c.type==="begin")n.push(c.env);else if(n.length===0)e.push(`\\end{${c.env}} without matching \\begin{${c.env}}`);else{let l=n[n.length-1];l===c.env||e.push(`Environment mismatch: \\begin{${l}} closed with \\end{${c.env}}`),n.pop()}for(let c of n)r.push(c),e.push(`Unclosed environment: \\begin{${c}}`);let u=n.length===0&&e.length===0;return{openEnvironments:r,isBalanced:u,issues:e}}function Er(t){return t?bu.some(e=>e.test(t)):!1}function Tu(t){let{content:e,completed:r}=t,n=[];if(!Er(e))return n;let o=ku(e);if(r){if(!o.isBalanced)for(let s of o.issues)n.push({rule:"latex-environments",message:s,severity:"error",recoverable:!0,suggestion:"Retry generation to properly balance LaTeX environments"})}else{let s=o.issues.filter(i=>i.includes("mismatch"));for(let i of s)n.push({rule:"latex-environments",message:i,severity:"error",recoverable:!0});o.openEnvironments.length>5&&n.push({rule:"latex-environments",message:`Excessive unclosed environments: ${o.openEnvironments.length}`,severity:"warning",recoverable:!0})}return n}function Eu(t){let{content:e,completed:r}=t,n=[];if(!Er(e))return n;Mo.lastIndex=0,$o.lastIndex=0,Fo.lastIndex=0;let o=(e.match(Mo)||[]).length,s=(e.match($o)||[]).length,i=(e.match(Fo)||[]).length,a=0,u=!1;for(let c=0;c<e.length;c++){if(u){u=!1;continue}if(e[c]==="\\"){u=!0;continue}e[c]==="$"&&(c+1>=e.length||e[c+1]!=="$")&&a++}return r&&(o!==s&&n.push({rule:"latex-math",message:`Unbalanced display math: ${o} \\[ and ${s} \\]`,severity:"error",recoverable:!0,suggestion:"Ensure all \\[ have matching \\]"}),i%2!==0&&n.push({rule:"latex-math",message:`Unbalanced $$ delimiters: ${i} found (should be even)`,severity:"error",recoverable:!0,suggestion:"Ensure all $$ are paired"}),a%2!==0&&n.push({rule:"latex-math",message:`Unbalanced inline math: ${a} $ found (should be even)`,severity:"warning",recoverable:!0,suggestion:"Check inline math delimiters"})),n}function wu(t){let{content:e,completed:r}=t,n=[];if(!Er(e)||!r)return n;let o=/\\[a-zA-Z]+/g,s;for(;(s=o.exec(e))!==null;){let i=e.slice(s.index+s[0].length);if(i.startsWith("{")){let a=0,u=!1;for(let c=0;c<i.length;c++)if(i[c]==="{"&&a++,i[c]==="}"&&(a--,a===0)){u=!0;break}!u&&a>0&&n.push({rule:"latex-common",message:`Unclosed braces after command ${s[0]}`,severity:"warning",recoverable:!0})}}return n}function wr(){return{name:"latex-environments",description:"Validates LaTeX environment balance and structure",streaming:!0,severity:"error",recoverable:!0,check:t=>{let e=[];return!Er(t.content)&&t.content.length>50||(e.push(...Tu(t)),e.push(...Eu(t)),t.completed&&e.push(...wu(t))),e}}}var $t={META_COMMENTARY:[/as an ai language model/i,/as an ai assistant/i,/i'm an ai/i,/i am an ai/i,/i don't have personal/i,/i cannot actually/i,/i apologize, but i/i,/i'm sorry, but i/i],EXCESSIVE_HEDGING:[/^sure!?\s*$/im,/^certainly!?\s*$/im,/^of course!?\s*$/im,/^absolutely!?\s*$/im],REFUSAL:[/i cannot provide/i,/i'm not able to/i,/i can't assist with/i,/i'm unable to/i,/that would be inappropriate/i],INSTRUCTION_LEAK:[/\[system\]/i,/\[user\]/i,/\[assistant\]/i,/<\|im_start\|>/i,/<\|im_end\|>/i,/###\s*instruction/i,/###\s*system/i],PLACEHOLDERS:[/\[insert .+?\]/i,/\[todo:?\]/i,/\[placeholder\]/i,/\[your .+? here\]/i,/\{\{.+?\}\}/],FORMAT_COLLAPSE:[/here is the .+?:/i,/here's the .+?:/i,/let me .+? for you/i,/i'll .+? for you/i]};function ft(t,e){let r=[];for(let n of e){let o=t.match(n);o&&r.push({pattern:n,match:o[0],index:o.index??0})}return r}function Su(t){let{content:e}=t,r=[],n=ft(e,$t.META_COMMENTARY);for(let o of n)r.push({rule:"pattern-meta-commentary",message:`Meta commentary detected: "${o.match}"`,severity:"error",position:o.index,recoverable:!0,suggestion:"Retry generation without meta commentary"});return r}function Cu(t){let{content:e}=t,r=[],n=e.trim().split(`
`)[0]??"",o=ft(n,$t.EXCESSIVE_HEDGING);return o.length>0&&o[0]&&r.push({rule:"pattern-hedging",message:`Excessive hedging at start: "${o[0].match}"`,severity:"warning",position:o[0].index,recoverable:!0,suggestion:"Content should start directly without hedging"}),r}function Ru(t){let{content:e}=t,r=[],n=ft(e,$t.REFUSAL);for(let o of n)r.push({rule:"pattern-refusal",message:`Refusal pattern detected: "${o.match}"`,severity:"error",position:o.index,recoverable:!1,suggestion:"Model refused to complete the task"});return r}function _u(t){let{content:e}=t,r=[],n=ft(e,$t.INSTRUCTION_LEAK);for(let o of n)r.push({rule:"pattern-instruction-leak",message:`Instruction leakage detected: "${o.match}"`,severity:"error",position:o.index,recoverable:!0,suggestion:"Retry generation without system tokens"});return r}function Ou(t){let{content:e,completed:r}=t,n=[];if(!r)return n;let o=ft(e,$t.PLACEHOLDERS);for(let s of o)n.push({rule:"pattern-placeholders",message:`Placeholder detected: "${s.match}"`,severity:"error",position:s.index,recoverable:!0,suggestion:"Output contains incomplete placeholders"});return n}function Au(t){let{content:e}=t,r=[],n=e.split(`
`).slice(0,3).join(`
`),o=ft(n,$t.FORMAT_COLLAPSE);return o.length>0&&o[0]&&r.push({rule:"pattern-format-collapse",message:`Format collapse detected: "${o[0].match}"`,severity:"warning",position:o[0].index,recoverable:!0,suggestion:"Output should not mix meta-instructions with content"}),r}function Lu(t,e=2){let{content:r,completed:n}=t,o=[];if(!n)return o;let s=r.split(/[.!?]+/).map(a=>a.trim().toLowerCase()).filter(a=>a.length>20),i=new Map;for(let a of s)i.set(a,(i.get(a)||0)+1);for(let[a,u]of i.entries())u>e&&o.push({rule:"pattern-repetition",message:`Sentence repeated ${u} times: "${a.slice(0,50)}..."`,severity:"error",recoverable:!0,suggestion:"Content contains repeated sentences"});return o}function Du(t){let{content:e,completed:r}=t,n=[];if(!r||e.length<100)return n;let o=e.split(/[.!?]+/).map(a=>a.trim()).filter(a=>a.length>10);if(o.length<2)return n;let s=o[0].toLowerCase(),i=o[o.length-1].toLowerCase();return s===i&&n.push({rule:"pattern-first-last-duplicate",message:"First and last sentences are identical",severity:"error",recoverable:!0,suggestion:"Retry generation - possible loop detected"}),n}function Sr(t){return{name:"pattern-detection",description:"Detects known bad patterns in model output",streaming:!1,severity:"error",recoverable:!0,check:e=>{let r=[];return r.push(...Su(e)),r.push(...Cu(e)),r.push(...Ru(e)),r.push(..._u(e)),r.push(...Ou(e)),r.push(...Au(e)),r.push(...Lu(e)),r.push(...Du(e)),r}}}function Pu(t,e="Custom pattern detected",r="error"){return{name:"pattern-custom",description:"Custom pattern matching",streaming:!1,severity:r,recoverable:r!=="fatal",check:n=>{let o=[],s=ft(n.content,t);for(let i of s)o.push({rule:"pattern-custom",message:`${e}: "${i.match}"`,severity:r,position:i.index,recoverable:r!=="fatal"});return o}}}var Iu=/^[^\w\s]+$/,Nu=/^(.)\1+$/,Mu=/[a-zA-Z0-9]/;function $u(t){return!t||t.length===0?!0:!Ce(t)}function Fu(t){if(!t||t.length===0)return!0;let e=t.trim();return!!(Iu.test(e)||Nu.test(e)||e.length<3&&!Mu.test(e))}function ju(t){let{content:e,completed:r,tokenCount:n}=t,o=[];return!r&&n<5?o:$u(e)?(o.push({rule:"zero-output",message:"No meaningful output generated (empty or whitespace only)",severity:"error",recoverable:!1,suggestion:"Retry - likely network or model initialization issue"}),o):Fu(e)?(o.push({rule:"zero-output",message:"Output contains only noise or filler characters",severity:"error",recoverable:!1,suggestion:"Retry - output is not meaningful"}),o):(r&&e.trim().length<10&&o.push({rule:"zero-output",message:`Output too short: ${e.trim().length} characters`,severity:"warning",recoverable:!1,suggestion:"Retry - output may be truncated"}),o)}function Gu(t){let{completed:e,tokenCount:r,metadata:n}=t,o=[];if(!e)return o;let s=n?.startTime,i=n?.endTime;if(s&&i){let a=i-s;a<100&&r<5&&o.push({rule:"zero-output",message:`Stream completed instantly (${a}ms) with minimal output`,severity:"error",recoverable:!1,suggestion:"Retry - possible network or transport failure"})}return o}function Ze(){return{name:"zero-output",description:"Detects zero or meaningless output",streaming:!0,severity:"error",recoverable:!1,check:t=>{let e=[];return e.push(...ju(t)),e.push(...Gu(t)),e}}}var Vu=[Mt(),Ze()],zu=[Mt(),Qt(),Ze(),Sr()],Bu=[Mt(),Qt(),wr(),Sr(),Ze()],Ju=[Mt(),Ze()],Uu=[Qt(),Ze()],Wu=[wr(),Ze()];var Zu={attempts:2,maxRetries:4,backoff:"linear",baseDelay:_.baseDelay,maxDelay:_.maxDelay,retryOn:[..._.retryOn]},qu={attempts:_.attempts,maxRetries:_.maxRetries,backoff:_.backoff,baseDelay:_.baseDelay,maxDelay:_.maxDelay,retryOn:[..._.retryOn]},Hu={attempts:_.attempts,maxRetries:_.maxRetries,backoff:"full-jitter",baseDelay:_.baseDelay,maxDelay:_.maxDelay,retryOn:[..._.retryOn]},Ku={attempts:4,maxRetries:8,backoff:"exponential",baseDelay:_.baseDelay,maxDelay:_.maxDelay,retryOn:[..._.retryOn]};var Cr=class{registry;prefix;requestsTotal;tokensTotal;retriesTotal;networkErrorsTotal;guardrailViolationsTotal;driftDetectedTotal;tokensPerSecond;activeStreams;requestDuration;timeToFirstToken;constructor(e){this.prefix=e.prefix??"l0",this.registry=e.registry??new e.client.Registry,e.defaultLabels&&this.registry.setDefaultLabels(e.defaultLabels);let r=e.buckets?.duration??[.1,.25,.5,1,2.5,5,10,30,60,120],n=e.buckets?.ttft??[.05,.1,.25,.5,1,2.5,5,10];this.requestsTotal=new e.client.Counter({name:`${this.prefix}_requests_total`,help:"Total number of L0 requests",labelNames:["status"],registers:[this.registry]}),this.tokensTotal=new e.client.Counter({name:`${this.prefix}_tokens_total`,help:"Total tokens generated",labelNames:["model"],registers:[this.registry]}),this.retriesTotal=new e.client.Counter({name:`${this.prefix}_retries_total`,help:"Total retry attempts",labelNames:["type"],registers:[this.registry]}),this.networkErrorsTotal=new e.client.Counter({name:`${this.prefix}_network_errors_total`,help:"Total network errors",labelNames:["error_type"],registers:[this.registry]}),this.guardrailViolationsTotal=new e.client.Counter({name:`${this.prefix}_guardrail_violations_total`,help:"Total guardrail violations",labelNames:["rule","severity"],registers:[this.registry]}),this.driftDetectedTotal=new e.client.Counter({name:`${this.prefix}_drift_detected_total`,help:"Total drift detection events",labelNames:["type"],registers:[this.registry]}),this.tokensPerSecond=new e.client.Gauge({name:`${this.prefix}_tokens_per_second`,help:"Current tokens per second rate",labelNames:["model"],registers:[this.registry]}),this.activeStreams=new e.client.Gauge({name:`${this.prefix}_active_streams`,help:"Number of active streams",labelNames:["model"],registers:[this.registry]}),this.requestDuration=new e.client.Histogram({name:`${this.prefix}_request_duration_seconds`,help:"L0 request duration in seconds",labelNames:["status"],buckets:r,registers:[this.registry]}),this.timeToFirstToken=new e.client.Histogram({name:`${this.prefix}_time_to_first_token_seconds`,help:"Time to first token in seconds",labelNames:["model"],buckets:n,registers:[this.registry]})}record(e,r){let n=r?.model??"unknown",o=e.metrics.totalTokens>0?"success":"empty";if(this.requestsTotal.inc({status:o}),e.duration!==void 0&&this.requestDuration.observe({status:o},e.duration/1e3),e.metrics.totalTokens>0&&this.tokensTotal.inc({model:n},e.metrics.totalTokens),e.metrics.tokensPerSecond!==void 0&&this.tokensPerSecond.set({model:n},e.metrics.tokensPerSecond),e.metrics.timeToFirstToken!==void 0&&this.timeToFirstToken.observe({model:n},e.metrics.timeToFirstToken/1e3),e.metrics.networkRetryCount>0&&this.retriesTotal.inc({type:"network"},e.metrics.networkRetryCount),e.metrics.modelRetryCount>0&&this.retriesTotal.inc({type:"model"},e.metrics.modelRetryCount),e.network.errorCount>0)for(let[s,i]of Object.entries(e.network.errorsByType))this.networkErrorsTotal.inc({error_type:s},i);if(e.guardrails&&e.guardrails.violationCount>0)if(e.guardrails.violationsByRuleAndSeverity)for(let[s,i]of Object.entries(e.guardrails.violationsByRuleAndSeverity))for(let[a,u]of Object.entries(i))u>0&&this.guardrailViolationsTotal.inc({rule:s,severity:a},u);else for(let[s,i]of Object.entries(e.guardrails.violationsByRule))this.guardrailViolationsTotal.inc({rule:s,severity:"unknown"},i);if(e.drift?.detected)for(let s of e.drift.types)this.driftDetectedTotal.inc({type:s})}recordFromMonitor(e,r){let n=e.getTelemetry();n&&this.record(n,r)}incActiveStreams(e="unknown"){this.activeStreams.inc({model:e})}decActiveStreams(e="unknown"){this.activeStreams.dec({model:e})}getRegistry(){return this.registry}async getMetrics(){return this.registry.metrics()}getContentType(){return this.registry.contentType}clear(){this.registry.clear()}};function Yu(t){return new Cr(t)}function Xu(t){return async(e,r)=>{r.set("Content-Type",t.getContentType()),r.send(await t.getMetrics())}}var er=class{metrics=new Map;prefix;defaultLabels;constructor(e={}){this.prefix=e.prefix??"l0",this.defaultLabels=e.defaultLabels??{}}getLabelKey(e){return!e||Object.keys(e).length===0?"":Object.entries(e).sort(([n],[o])=>n.localeCompare(o)).map(([n,o])=>`${n}=${o}`).join(",")}register(e){let r=e.name,n={...this.defaultLabels,...e.labels},o=this.getLabelKey(n),s=this.metrics.get(r)||[],i=s.findIndex(a=>this.getLabelKey(a.labels)===o);if(i>=0){let a=s[i];e.type==="counter"?a.value+=e.value:e.type==="gauge"?a.value=e.value:e.type==="histogram"&&(a.observations||(a.observations=[]),a.observations.push(e.value))}else{let a={...e,labels:n};e.type==="histogram"&&(a.observations=[e.value]),s.push(a)}this.metrics.set(r,s)}incCounter(e,r,n=1,o){this.register({name:`${this.prefix}_${e}`,help:r,type:"counter",value:n,labels:o})}setGauge(e,r,n,o){this.register({name:`${this.prefix}_${e}`,help:r,type:"gauge",value:n,labels:o})}observeHistogram(e,r,n,o,s){this.register({name:`${this.prefix}_${e}`,help:r,type:"histogram",value:n,labels:o,buckets:s??[.005,.01,.025,.05,.1,.25,.5,1,2.5,5,10]})}recordTelemetry(e,r){let n={...r};if(e.duration!==void 0&&this.observeHistogram("request_duration_seconds","L0 request duration in seconds",e.duration/1e3,n,[.1,.25,.5,1,2.5,5,10,30,60]),this.incCounter("tokens_total","Total tokens generated",e.metrics.totalTokens,n),e.metrics.tokensPerSecond!==void 0&&this.setGauge("tokens_per_second","Tokens generated per second",e.metrics.tokensPerSecond,n),e.metrics.timeToFirstToken!==void 0&&this.observeHistogram("time_to_first_token_seconds","Time to first token in seconds",e.metrics.timeToFirstToken/1e3,n,[.05,.1,.25,.5,1,2.5,5,10]),e.metrics.totalRetries>0&&(this.incCounter("retries_total","Total retry attempts",e.metrics.totalRetries,n),this.incCounter("retries_network_total","Network-related retry attempts",e.metrics.networkRetryCount,{...n,retry_type:"network"}),this.incCounter("retries_model_total","Model-related retry attempts",e.metrics.modelRetryCount,{...n,retry_type:"model"})),e.network.errorCount>0){this.incCounter("network_errors_total","Total network errors",e.network.errorCount,n);for(let[o,s]of Object.entries(e.network.errorsByType))this.incCounter("network_errors_by_type_total","Network errors by type",s,{...n,error_type:o})}if(e.guardrails&&e.guardrails.violationCount>0){this.incCounter("guardrail_violations_total","Total guardrail violations",e.guardrails.violationCount,n);for(let[o,s]of Object.entries(e.guardrails.violationsBySeverity))s>0&&this.incCounter("guardrail_violations_by_severity_total","Guardrail violations by severity",s,{...n,severity:o});for(let[o,s]of Object.entries(e.guardrails.violationsByRule))this.incCounter("guardrail_violations_by_rule_total","Guardrail violations by rule",s,{...n,rule:o})}e.drift?.detected&&this.incCounter("drift_detected_total","Drift detection events",1,n),this.incCounter("requests_total","Total L0 requests",1,n)}recordFromMonitor(e,r){let n=e.getTelemetry();n&&this.recordTelemetry(n,r)}expose(){let e=[],r=new Set;for(let[n,o]of this.metrics.entries()){if(o.length===0)continue;let s=o[0];r.has(n)||(e.push(`# HELP ${n} ${s.help}`),e.push(`# TYPE ${n} ${s.type}`),r.add(n));for(let i of o){let a=this.formatLabels(i.labels);if(i.type==="histogram"&&i.observations){let u=i.observations,c=i.buckets??[.005,.01,.025,.05,.1,.25,.5,1,2.5,5,10],l=u.reduce((m,g)=>m+g,0),p=u.length;for(let m of c){let g=u.filter(b=>b<=m).length,T=a?a.replace("}",`,le="${m}"}`):`{le="${m}"}`;e.push(`${n}_bucket${T} ${g}`)}let h=a?a.replace("}",',le="+Inf"}'):'{le="+Inf"}';e.push(`${n}_bucket${h} ${p}`),e.push(`${n}_sum${a} ${l}`),e.push(`${n}_count${a} ${p}`)}else i.type==="histogram"?(e.push(`${n}_bucket${a?a.replace("}",',le="+Inf"}'):'{le="+Inf"}'} 1`),e.push(`${n}_sum${a} ${i.value}`),e.push(`${n}_count${a} 1`)):e.push(`${n}${a} ${i.value}`)}}return e.join(`
`)}formatLabels(e){return!e||Object.keys(e).length===0?"":`{${Object.entries(e).map(([n,o])=>`${n}="${this.escapeLabel(o)}"`).join(",")}}`}escapeLabel(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n")}clear(){this.metrics.clear()}toJSON(){return Object.fromEntries(this.metrics.entries())}},Rr=class{registry;constructor(e={}){this.registry=new er(e)}record(e,r){this.registry.recordTelemetry(e,r)}recordFromMonitor(e,r){this.registry.recordFromMonitor(e,r)}expose(){return this.registry.expose()}clear(){this.registry.clear()}getRegistry(){return this.registry}};function Qu(t){return new er(t)}function ec(t){return new Rr(t)}function tc(t){return(e,r)=>{r.set("Content-Type","text/plain; version=0.0.4; charset=utf-8"),r.send(t.expose())}}var rc={duration:[.1,.25,.5,1,2.5,5,10,30,60,120],ttft:[.05,.1,.25,.5,1,2.5,5,10],tokens:[10,50,100,250,500,1e3,2500,5e3,1e4],retries:[0,1,2,3,5,10]},nc={requestsTotal:"l0_requests_total",requestDuration:"l0_request_duration_seconds",tokensTotal:"l0_tokens_total",tokensPerSecond:"l0_tokens_per_second",timeToFirstToken:"l0_time_to_first_token_seconds",retriesTotal:"l0_retries_total",networkErrorsTotal:"l0_network_errors_total",guardrailViolationsTotal:"l0_guardrail_violations_total",driftDetectedTotal:"l0_drift_detected_total"};var _r=class{sentry;config;constructor(e){if(this.sentry=e.sentry,this.config={captureNetworkErrors:e.captureNetworkErrors??!0,captureGuardrailViolations:e.captureGuardrailViolations??!0,minGuardrailSeverity:e.minGuardrailSeverity??"error",breadcrumbsForTokens:e.breadcrumbsForTokens??!1,enableTracing:e.enableTracing??!0,tags:e.tags,environment:e.environment},this.config.tags)for(let[r,n]of Object.entries(this.config.tags))this.sentry.setTag(r,n);this.config.environment&&this.sentry.setTag("environment",this.config.environment)}startExecution(e="l0.execution",r){if(this.sentry.addBreadcrumb({type:"info",category:"l0",message:"L0 execution started",data:r,level:"info",timestamp:Date.now()/1e3}),this.config.enableTracing&&this.sentry.startSpan){let n;return this.sentry.startSpan({name:e,op:"l0.execution",attributes:r},o=>{n=()=>o?.end()}),n}}startStream(){this.sentry.addBreadcrumb({type:"info",category:"l0.stream",message:"Stream started",level:"info",timestamp:Date.now()/1e3})}recordToken(e){this.config.breadcrumbsForTokens&&this.sentry.addBreadcrumb({type:"debug",category:"l0.token",message:e?`Token: ${e.slice(0,50)}`:"Token received",level:"debug",timestamp:Date.now()/1e3})}recordFirstToken(e){this.sentry.addBreadcrumb({type:"info",category:"l0.stream",message:"First token received",data:{ttft_ms:e},level:"info",timestamp:Date.now()/1e3})}recordNetworkError(e,r,n){this.sentry.addBreadcrumb({type:"error",category:"l0.network",message:`Network error: ${r}`,data:{error_type:r,message:e.message,retried:n},level:"error",timestamp:Date.now()/1e3}),this.config.captureNetworkErrors&&!n&&this.sentry.captureException(e,{tags:{error_type:r,component:"l0.network"},extra:{retried:n}})}recordRetry(e,r,n){this.sentry.addBreadcrumb({type:"info",category:"l0.retry",message:`Retry attempt ${e}`,data:{attempt:e,reason:r,is_network_error:n},level:"warning",timestamp:Date.now()/1e3})}recordGuardrailViolations(e){for(let r of e)this.sentry.addBreadcrumb({type:"error",category:"l0.guardrail",message:`Guardrail violation: ${r.rule}`,data:{rule:r.rule,severity:r.severity,message:r.message,recoverable:r.recoverable},level:this.mapSeverity(r.severity),timestamp:Date.now()/1e3}),this.config.captureGuardrailViolations&&this.shouldCapture(r.severity)&&this.sentry.captureMessage(`Guardrail violation: ${r.message}`,this.mapSeverity(r.severity))}recordDrift(e,r){e&&this.sentry.addBreadcrumb({type:"error",category:"l0.drift",message:`Drift detected: ${r.join(", ")}`,data:{types:r},level:"warning",timestamp:Date.now()/1e3})}completeStream(e){this.sentry.addBreadcrumb({type:"info",category:"l0.stream",message:"Stream completed",data:{token_count:e},level:"info",timestamp:Date.now()/1e3})}completeExecution(e){this.sentry.setContext("l0_telemetry",{session_id:e.sessionId,duration_ms:e.duration,tokens:e.metrics.totalTokens,tokens_per_second:e.metrics.tokensPerSecond,ttft_ms:e.metrics.timeToFirstToken,retries:e.metrics.totalRetries,network_errors:e.network.errorCount,guardrail_violations:e.guardrails?.violationCount??0}),this.sentry.addBreadcrumb({type:"info",category:"l0",message:"L0 execution completed",data:{duration_ms:e.duration,tokens:e.metrics.totalTokens,retries:e.metrics.totalRetries},level:"info",timestamp:Date.now()/1e3})}recordFailure(e,r){r&&this.sentry.setContext("l0_telemetry",{session_id:r.sessionId,duration_ms:r.duration,tokens:r.metrics.totalTokens,retries:r.metrics.totalRetries,network_errors:r.network.errorCount}),this.sentry.captureException(e,{tags:{component:"l0"},extra:{telemetry:r?{session_id:r.sessionId,duration_ms:r.duration,tokens:r.metrics.totalTokens}:void 0}})}recordFromMonitor(e){let r=e.getTelemetry();r&&this.completeExecution(r)}mapSeverity(e){switch(e){case"fatal":return"fatal";case"error":return"error";case"warning":return"warning";default:return"info"}}shouldCapture(e){let r=["warning","error","fatal"],n=r.indexOf(this.config.minGuardrailSeverity);return r.indexOf(e)>=n}};function On(t){return new _r(t)}function oc(t){let e=On(t),r;return{name:"sentry",before:async n=>(r=e.startExecution("l0.execution",n.monitoring?.metadata),n),after:async n=>(n.telemetry&&e.completeExecution(n.telemetry),r?.(),n),onError:async(n,o)=>{e.recordFailure(n),r?.()}}}async function sc(t,e){let r=On(t);r.startExecution();try{let n=await e();return n.telemetry&&r.completeExecution(n.telemetry),n}catch(n){throw r.recordFailure(n instanceof Error?n:new Error(String(n))),n}}var ht;(function(t){t[t.INTERNAL=0]="INTERNAL",t[t.SERVER=1]="SERVER",t[t.CLIENT=2]="CLIENT",t[t.PRODUCER=3]="PRODUCER",t[t.CONSUMER=4]="CONSUMER"})(ht||(ht={}));var gt;(function(t){t[t.UNSET=0]="UNSET",t[t.OK=1]="OK",t[t.ERROR=2]="ERROR"})(gt||(gt={}));var Te={LLM_SYSTEM:"gen_ai.system",LLM_REQUEST_MODEL:"gen_ai.request.model",LLM_RESPONSE_MODEL:"gen_ai.response.model",LLM_REQUEST_MAX_TOKENS:"gen_ai.request.max_tokens",LLM_REQUEST_TEMPERATURE:"gen_ai.request.temperature",LLM_REQUEST_TOP_P:"gen_ai.request.top_p",LLM_RESPONSE_FINISH_REASON:"gen_ai.response.finish_reasons",LLM_USAGE_INPUT_TOKENS:"gen_ai.usage.input_tokens",LLM_USAGE_OUTPUT_TOKENS:"gen_ai.usage.output_tokens",L0_SESSION_ID:"l0.session_id",L0_STREAM_COMPLETED:"l0.stream.completed",L0_FALLBACK_INDEX:"l0.fallback.index",L0_RETRY_COUNT:"l0.retry.count",L0_NETWORK_ERROR_COUNT:"l0.network.error_count",L0_GUARDRAIL_VIOLATION_COUNT:"l0.guardrail.violation_count",L0_DRIFT_DETECTED:"l0.drift.detected",L0_TIME_TO_FIRST_TOKEN:"l0.time_to_first_token_ms",L0_TOKENS_PER_SECOND:"l0.tokens_per_second"},tr=class{tracer;meter;config;requestCounter;tokenCounter;retryCounter;errorCounter;durationHistogram;ttftHistogram;activeStreamsGauge;activeStreams=0;constructor(e){this.tracer=e.tracer,this.meter=e.meter,this.config={serviceName:e.serviceName??"l0",traceTokens:e.traceTokens??!1,recordTokenContent:e.recordTokenContent??!1,recordGuardrailViolations:e.recordGuardrailViolations??!0,defaultAttributes:e.defaultAttributes},this.meter&&this.initializeMetrics()}initializeMetrics(){this.meter&&(this.requestCounter=this.meter.createCounter("l0.requests",{description:"Total number of L0 stream requests",unit:"1"}),this.tokenCounter=this.meter.createCounter("l0.tokens",{description:"Total number of tokens processed",unit:"1"}),this.retryCounter=this.meter.createCounter("l0.retries",{description:"Total number of retry attempts",unit:"1"}),this.errorCounter=this.meter.createCounter("l0.errors",{description:"Total number of errors",unit:"1"}),this.durationHistogram=this.meter.createHistogram("l0.duration",{description:"Stream duration in milliseconds",unit:"ms"}),this.ttftHistogram=this.meter.createHistogram("l0.time_to_first_token",{description:"Time to first token in milliseconds",unit:"ms"}),this.activeStreamsGauge=this.meter.createUpDownCounter("l0.active_streams",{description:"Number of currently active streams",unit:"1"}))}async traceStream(e,r,n){if(!this.tracer)return r(jo());let o={...this.config.defaultAttributes,...n},s=this.tracer.startSpan(`${this.config.serviceName}.${e}`,{kind:ht.CLIENT,attributes:o});this.activeStreams++,this.activeStreamsGauge?.add(1);try{let i=await r(s);return s.setStatus({code:gt.OK}),i}catch(i){throw s.setStatus({code:gt.ERROR,message:i instanceof Error?i.message:String(i)}),i instanceof Error&&s.recordException(i),this.errorCounter?.add(1,{type:"stream_error"}),i}finally{this.activeStreams--,this.activeStreamsGauge?.add(-1),s.end()}}recordTelemetry(e,r){let n={[Te.L0_SESSION_ID]:e.sessionId};if(this.requestCounter?.add(1,{status:"completed"}),e.metrics.totalTokens>0&&this.tokenCounter?.add(e.metrics.totalTokens,n),e.metrics.totalRetries>0&&this.retryCounter?.add(e.metrics.totalRetries,{...n,type:"total"}),e.metrics.networkRetryCount>0&&this.retryCounter?.add(e.metrics.networkRetryCount,{...n,type:"network"}),e.metrics.modelRetryCount>0&&this.retryCounter?.add(e.metrics.modelRetryCount,{...n,type:"model"}),e.network.errorCount>0){let o=e.network.errorsByType;if(o&&Object.keys(o).length>0)for(let[s,i]of Object.entries(o))i>0&&this.errorCounter?.add(i,{...n,type:"network",error_type:s});else this.errorCounter?.add(e.network.errorCount,{...n,type:"network"})}if(e.guardrails?.violationCount&&e.guardrails.violationCount>0){let o=e.guardrails.violationsByRuleAndSeverity;if(o&&Object.keys(o).length>0)for(let[s,i]of Object.entries(o))for(let[a,u]of Object.entries(i))u>0&&this.errorCounter?.add(u,{...n,type:"guardrail_violation",rule:s,severity:a});else this.errorCounter?.add(e.guardrails.violationCount,{...n,type:"guardrail_violation"})}e.drift?.detected&&this.errorCounter?.add(1,{...n,type:"drift"}),e.duration&&this.durationHistogram?.record(e.duration,n),e.metrics.timeToFirstToken&&this.ttftHistogram?.record(e.metrics.timeToFirstToken,n),r?.isRecording()&&(r.setAttributes({[Te.L0_SESSION_ID]:e.sessionId,[Te.LLM_USAGE_OUTPUT_TOKENS]:e.metrics.totalTokens,[Te.L0_RETRY_COUNT]:e.metrics.totalRetries,[Te.L0_NETWORK_ERROR_COUNT]:e.network.errorCount}),e.guardrails?.violationCount&&r.setAttribute(Te.L0_GUARDRAIL_VIOLATION_COUNT,e.guardrails.violationCount),e.drift?.detected&&r.setAttribute(Te.L0_DRIFT_DETECTED,!0),e.metrics.timeToFirstToken&&r.setAttribute(Te.L0_TIME_TO_FIRST_TOKEN,e.metrics.timeToFirstToken),e.metrics.tokensPerSecond&&r.setAttribute(Te.L0_TOKENS_PER_SECOND,e.metrics.tokensPerSecond),e.duration&&r.setAttribute("duration_ms",e.duration))}recordToken(e,r){if(this.config.traceTokens&&e?.isRecording()){let n={};this.config.recordTokenContent&&r&&(n["token.content"]=r),e.addEvent("token",n)}}recordRetry(e,r,n){n?.isRecording()&&n.addEvent("retry",{"retry.reason":e,"retry.attempt":r})}recordNetworkError(e,r,n){n?.isRecording()&&n.addEvent("network_error",{"error.type":r,"error.message":e.message})}recordGuardrailViolation(e,r){this.config.recordGuardrailViolations&&r?.isRecording()&&r.addEvent("guardrail_violation",{"guardrail.rule":e.rule,"guardrail.severity":e.severity,"guardrail.message":e.message})}recordDrift(e,r,n){n?.isRecording()&&(n.setAttribute(Te.L0_DRIFT_DETECTED,!0),n.addEvent("drift_detected",{"drift.type":e,"drift.confidence":r}))}createSpan(e,r){return this.tracer?this.tracer.startSpan(`${this.config.serviceName}.${e}`,{kind:ht.INTERNAL,attributes:{...this.config.defaultAttributes,...r}}):jo()}connectMonitor(e){let r=e.complete.bind(e);e.complete=()=>{r();let n=e.getTelemetry();n&&this.recordTelemetry(n)}}getActiveStreams(){return this.activeStreams}};function ic(t){return new tr(t)}function jo(){return{spanContext:()=>({traceId:"",spanId:"",traceFlags:0}),setAttribute:function(){return this},setAttributes:function(){return this},addEvent:function(){return this},addLink:function(){return this},addLinks:function(){return this},setStatus:function(){return this},updateName:function(){return this},recordException:function(){},end:function(){},isRecording:function(){return!1}}}function ac(t){let e=new tr(t);return{name:"opentelemetry",onStart:r=>{r.span=e.createSpan("stream")},onToken:(r,n)=>{e.recordToken(n.span,r)},onRetry:(r,n,o)=>{e.recordRetry(r,n,o.span)},onError:(r,n,o)=>{e.recordNetworkError(r,n,o.span)},onViolation:(r,n)=>{e.recordGuardrailViolation(r,n.span)},onComplete:(r,n)=>{e.recordTelemetry(r,n.span),n.span?.end()}}}async function Ar(t,e={}){let{concurrency:r=5,failFast:n=!1,sharedRetry:o,sharedMonitoring:s,onProgress:i,onComplete:a,onError:u}=e,c=Date.now(),l=new Array(t.length).fill(null),p=new Array(t.length).fill(null),h=0,m=0,g=0,b=t.map(E=>({...E,retry:E.retry||o,monitoring:E.monitoring||s})).map((E,x)=>({op:E,index:x})),R=[],M=async E=>{try{let x=await ue(E.op);for await(let D of x.stream);l[E.index]=x,m++,a&&a(x,E.index)}catch(x){let D=x instanceof Error?x:new Error(String(x));if(p[E.index]=D,g++,u&&u(D,E.index),n)throw D}finally{h++,i&&i(h,t.length)}};try{for(let E of b){let x=M(E).then(()=>{R.splice(R.indexOf(x),1)});R.push(x),R.length>=r&&await Promise.race(R)}await Promise.all(R)}catch{n&&await Promise.allSettled(R)}let z=Date.now()-c,W=g===0,C=Go(l.filter(E=>E!==null));return{results:l,errors:p,successCount:m,failureCount:g,duration:z,allSucceeded:W,aggregatedTelemetry:C}}async function uc(t,e={}){return Ar(t,{...e,concurrency:t.length})}async function cc(t,e={}){return Ar(t,{...e,concurrency:1})}async function lc(t,e,r={}){let n=[],o=[],s=0,i=0,a=0,u=[];for(let l=0;l<t.length;l+=e)u.push(t.slice(l,l+e));for(let l=0;l<u.length;l++){let p=u[l],h=await Ar(p,{...r,concurrency:e,onProgress:r.onProgress?(m,g)=>{let T=l*e+m;r.onProgress(T,t.length)}:void 0});if(n.push(...h.results),o.push(...h.errors),s+=h.successCount,i+=h.failureCount,a+=h.duration,r.failFast&&!h.allSucceeded)break}let c=Go(n.filter(l=>l!==null));return{results:n,errors:o,successCount:s,failureCount:i,duration:a,allSucceeded:i===0,aggregatedTelemetry:c}}async function dc(t,e={}){let{sharedRetry:r,sharedMonitoring:n}=e,o=t.map(()=>new AbortController),i=t.map((a,u)=>({...a,retry:a.retry||r,monitoring:a.monitoring||n,signal:o[u].signal})).map(async(a,u)=>{let c=await ue(a);for await(let l of c.stream);return{result:c,index:u}});try{let{result:a,index:u}=await Promise.any(i);return o.forEach(c=>c.abort()),{...a,winnerIndex:u}}catch(a){throw o.forEach(u=>u.abort()),a instanceof AggregateError?a.errors[0]||new Error("All operations failed"):a}}function Go(t){if(t.length===0)return{totalTokens:0,totalDuration:0,totalRetries:0,totalNetworkErrors:0,totalViolations:0,avgTokensPerSecond:0,avgTimeToFirstToken:0};let e=0,r=0,n=0,o=0,s=0,i=0,a=0,u=0,c=0;for(let l of t)l.telemetry&&(e+=l.telemetry.metrics.totalTokens,r+=l.telemetry.duration||0,n+=l.telemetry.metrics.totalRetries,o+=l.telemetry.network.errorCount,s+=l.telemetry.guardrails?.violationCount||0,l.telemetry.metrics.tokensPerSecond!==void 0&&(i+=l.telemetry.metrics.tokensPerSecond,c++),l.telemetry.metrics.timeToFirstToken!==void 0&&(a+=l.telemetry.metrics.timeToFirstToken,u++));return{totalTokens:e,totalDuration:r,totalRetries:n,totalNetworkErrors:o,totalViolations:s,avgTokensPerSecond:c>0?i/c:0,avgTimeToFirstToken:u>0?a/u:0}}var Or=class{constructor(e,r={}){this.concurrency=e;this.options=r}queue=[];activeWorkers=0;async execute(e){return new Promise((r,n)=>{this.queue.push({op:e,resolve:r,reject:n}),this.processQueue()})}async processQueue(){if(this.activeWorkers>=this.concurrency||this.queue.length===0)return;let e=this.queue.shift();if(e){this.activeWorkers++;try{let r={...e.op,retry:e.op.retry||this.options.sharedRetry,monitoring:e.op.monitoring||this.options.sharedMonitoring},n=await ue(r);for await(let o of n.stream);e.resolve(n)}catch(r){e.reject(r instanceof Error?r:new Error(String(r)))}finally{this.activeWorkers--,this.processQueue()}}}async drain(){for(;this.queue.length>0||this.activeWorkers>0;)await new Promise(e=>setTimeout(e,10))}getQueueLength(){return this.queue.length}getActiveWorkers(){return this.activeWorkers}};function pc(t,e={}){return new Or(t,e)}function jt(t,e,r={}){let{caseSensitive:n=!0,normalizeWhitespace:o=!0,algorithm:s="levenshtein"}=r,i=t,a=e;if(n||(i=i.toLowerCase(),a=a.toLowerCase()),o&&(i=i.replace(/\s+/g," ").trim(),a=a.replace(/\s+/g," ").trim()),i===a)return 1;switch(s){case"levenshtein":return An(i,a);case"jaro-winkler":return Bo(i,a);case"cosine":return Jo(i,a);default:return An(i,a)}}function An(t,e){if(t===e)return 1;if(t.length===0||e.length===0)return 0;let r=zo(t,e),n=Math.max(t.length,e.length);return 1-r/n}function zo(t,e){let r=[];for(let n=0;n<=e.length;n++)r[n]=[n];for(let n=0;n<=t.length;n++)r[0][n]=n;for(let n=1;n<=e.length;n++)for(let o=1;o<=t.length;o++)e.charAt(n-1)===t.charAt(o-1)?r[n][o]=r[n-1][o-1]:r[n][o]=Math.min(r[n-1][o-1]+1,r[n][o-1]+1,r[n-1][o]+1);return r[e.length][t.length]}function Bo(t,e){if(t===e)return 1;if(t.length===0||e.length===0)return 0;let r=mc(t,e),n=fc(t,e,4);return r+n*.1*(1-r)}function mc(t,e){let r=Math.floor(Math.max(t.length,e.length)/2)-1,n=new Array(t.length).fill(!1),o=new Array(e.length).fill(!1),s=0,i=0;for(let u=0;u<t.length;u++){let c=Math.max(0,u-r),l=Math.min(u+r+1,e.length);for(let p=c;p<l;p++)if(!(o[p]||t[u]!==e[p])){n[u]=!0,o[p]=!0,s++;break}}if(s===0)return 0;let a=0;for(let u=0;u<t.length;u++)if(n[u]){for(;!o[a];)a++;t[u]!==e[a]&&i++,a++}return(s/t.length+s/e.length+(s-i/2)/s)/3}function fc(t,e,r){let n=0,o=Math.min(t.length,e.length,r);for(let s=0;s<o&&t[s]===e[s];s++)n++;return n}function Jo(t,e){let r=Vo(t),n=Vo(e),o=Object.keys(r).reduce((a,u)=>a+(r[u]||0)*(n[u]||0),0),s=Math.sqrt(Object.values(r).reduce((a,u)=>a+u*u,0)),i=Math.sqrt(Object.values(n).reduce((a,u)=>a+u*u,0));return s===0||i===0?0:o/(s*i)}function Vo(t){let e=t.toLowerCase().split(/\s+/),r={};for(let n of e)r[n]=(r[n]||0)+1;return r}function Uo(t,e,r=.001){return Math.abs(t-e)<=r}function Wo(t,e,r,n=""){let o=[];if(r.ignoreArrayOrder){let s=new Set(t.map(a=>JSON.stringify(a))),i=new Set(e.map(a=>JSON.stringify(a)));for(let a of s)i.has(a)||o.push({path:`${n}[]`,expected:JSON.parse(a),actual:void 0,type:"missing",severity:r.style==="strict"?"error":"warning",message:"Item missing in actual array"});for(let a of i)s.has(a)||o.push({path:`${n}[]`,expected:void 0,actual:JSON.parse(a),type:"extra",severity:r.ignoreExtraFields?"info":"warning",message:"Extra item in actual array"})}else{let s=Math.max(t.length,e.length);for(let i=0;i<s;i++){let a=`${n}[${i}]`;if(i>=t.length)o.push({path:a,expected:void 0,actual:e[i],type:"extra",severity:r.ignoreExtraFields?"info":"warning",message:`Extra item at index ${i}`});else if(i>=e.length)o.push({path:a,expected:t[i],actual:void 0,type:"missing",severity:"error",message:`Missing item at index ${i}`});else{let u=Dn(t[i],e[i],r,a);o.push(...u)}}}return o}function Zo(t,e,r,n=""){let o=[],s=Object.keys(t),i=Object.keys(e),a=new Set([...s,...i]);for(let u of a){let c=n?`${n}.${u}`:u,l=u in t,p=u in e;if(r.customComparisons?.[c]){let h=r.customComparisons[c](t[u],e[u]);typeof h=="boolean"&&!h?o.push({path:c,expected:t[u],actual:e[u],type:"different",severity:"error",message:`Custom comparison failed for ${c}`}):typeof h=="number"&&h<.8&&o.push({path:c,expected:t[u],actual:e[u],type:"different",severity:"warning",message:`Custom comparison score too low: ${h.toFixed(2)}`,similarity:h});continue}if(!l&&p)r.ignoreExtraFields||o.push({path:c,expected:void 0,actual:e[u],type:"extra",severity:r.style==="strict"?"error":"info",message:`Extra field: ${u}`});else if(l&&!p)o.push({path:c,expected:t[u],actual:void 0,type:"missing",severity:"error",message:`Missing field: ${u}`});else{let h=Dn(t[u],e[u],r,c);o.push(...h)}}return o}function Dn(t,e,r,n=""){if(t===e)return[];let o=Lr(t),s=Lr(e);if(o!==s)return[{path:n,expected:t,actual:e,type:"type-mismatch",severity:"error",message:`Type mismatch: expected ${o}, got ${s}`}];switch(o){case"null":case"undefined":return t===e?[]:[{path:n,expected:t,actual:e,type:"different",severity:"error",message:`Expected ${t}, got ${e}`}];case"number":return Uo(t,e,r.numericTolerance)?[]:[{path:n,expected:t,actual:e,type:"different",severity:"error",message:`Numbers differ: ${t} vs ${e}`}];case"string":if(t===e)return[];let i=jt(t,e,{caseSensitive:!0,normalizeWhitespace:!0,algorithm:"levenshtein"});return r.style==="lenient"&&i>=.8?[{path:n,expected:t,actual:e,type:"different",severity:"warning",message:`Strings differ but similar (${(i*100).toFixed(0)}%)`,similarity:i}]:[{path:n,expected:t,actual:e,type:"different",severity:"error",message:"Strings differ",similarity:i}];case"boolean":return[{path:n,expected:t,actual:e,type:"different",severity:"error",message:`Boolean mismatch: ${t} vs ${e}`}];case"array":return Wo(t,e,r,n);case"object":return Zo(t,e,r,n);default:return[{path:n,expected:t,actual:e,type:"different",severity:"error",message:"Values differ"}]}}function Lr(t){return t===null?"null":t===void 0?"undefined":Array.isArray(t)?"array":typeof t}function Ft(t,e){if(t===e)return!0;if(t===null||e===null||t===void 0||e===void 0)return!1;let r=typeof t;if(r!==typeof e||r!=="object")return!1;let o=Array.isArray(t),s=Array.isArray(e);if(o!==s)return!1;if(o){if(t.length!==e.length)return!1;for(let u=0;u<t.length;u++)if(!Ft(t[u],e[u]))return!1;return!0}let i=Object.keys(t),a=Object.keys(e);if(i.length!==a.length)return!1;for(let u of i)if(!(u in e)||!Ft(t[u],e[u]))return!1;return!0}function hc(t,e){if(e===0)return 1;let r={error:1,warning:.5,info:.1},n=t.reduce((s,i)=>s+r[i.severity],0);return Math.max(0,1-n/e)}function Ln(t){let e=Lr(t);return e==="object"?Object.keys(t).reduce((r,n)=>r+1+Ln(t[n]),0):e==="array"?t.reduce((r,n)=>r+Ln(n),0):1}function Pn(t){let e=t.length,r=Array(e).fill(0).map(()=>Array(e).fill(0));for(let n=0;n<e;n++){r[n][n]=1;for(let o=n+1;o<e;o++){let s=Pr(t[n],t[o]);r[n][o]=s,r[o][n]=s}}return r}function Pr(t,e){return t.data&&e.data?Dr(t.data,e.data):jt(t.text,e.text,{caseSensitive:!1,normalizeWhitespace:!0,algorithm:"levenshtein"})}function Dr(t,e){if(t===e)return 1;if(t==null)return e==null?1:0;if(e==null)return 0;let r=typeof t;if(r!==typeof e)return 0;if(r!=="object"){if(r==="string")return t===e?1:jt(t,e,{caseSensitive:!1,normalizeWhitespace:!0});if(r==="number"){if(t===e)return 1;let p=Math.max(Math.abs(t),Math.abs(e));return p===0?1:1-Math.abs(t-e)/p}return t===e?1:0}let o=Array.isArray(t),s=Array.isArray(e);if(o!==s)return 0;if(o){let p=t.length,h=e.length,m=Math.max(p,h);if(m===0||p===h&&Ft(t,e))return 1;let g=0,T=Math.min(p,h);for(let b=0;b<T;b++)g+=Dr(t[b],e[b]);return g/m}let i=Object.keys(t),a=Object.keys(e);if(i.length===a.length&&Ft(t,e))return 1;let u=new Set([...i,...a]),c=u.size;if(c===0)return 1;let l=0;for(let p of u)p in t&&p in e&&(l+=Dr(t[p],e[p]));return l/c}function In(t,e=.8){let r=[];if(t[0]?.data){let n=yc(t,e);r.push(...n)}else{let n=gc(t,e);r.push(...n)}return r}function gc(t,e){let r=[],n=[],o=new Set;for(let s=0;s<t.length;s++){if(o.has(s))continue;let i=[s];o.add(s);for(let a=s+1;a<t.length;a++){if(o.has(a))continue;Pr(t[s],t[a])>=e&&(i.push(a),o.add(a))}i.length>1&&n.push(i)}for(let s of n){let i=t[s[0]].text,a=s.length===t.length?"exact":"similar";r.push({content:i,count:s.length,ratio:s.length/t.length,indices:s,type:a})}return r}function yc(t,e){let r=[],n=new Set;for(let o of t)o.data&&rr(o.data).forEach(s=>n.add(s));for(let o of n){let s=t.map(p=>Nr(p.data,o)).filter(p=>p!==void 0);if(s.length===0)continue;let i=new Map;s.forEach((p,h)=>{let m=JSON.stringify(p);i.has(m)||i.set(m,[]),i.get(m).push(h)});let a=0,u,c=[];for(let[p,h]of i)h.length>a&&(a=h.length,u=JSON.parse(p),c=h);let l=a/t.length;l>=e&&r.push({content:u,path:o,count:a,ratio:l,indices:c,type:l===1?"exact":"structural"})}return r}function Nn(t,e=.8){let r=[];if(t[0]?.data){let n=xc(t,e);r.push(...n)}else{let n=vc(t,e);r.push(...n)}return r}function vc(t,e){let r=[],n=new Map;if(t.forEach((o,s)=>{let i=o.text.trim(),a=!1;for(let[u,c]of n)if(jt(i,u)>=e){c.push(s),a=!0;break}a||n.set(i,[s])}),n.size>1){let o=Array.from(n.entries()).map(([i,a])=>({value:i,count:a.length,indices:a})),s=qo(o,t.length);r.push({values:o,severity:s})}return r}function xc(t,e){let r=[],n=new Set;for(let o of t)o.data&&rr(o.data).forEach(s=>n.add(s));for(let o of n){let s=t.map(a=>({value:Nr(a.data,o),index:t.indexOf(a)})),i=new Map;if(s.forEach(({value:a,index:u})=>{if(a===void 0)return;let c=JSON.stringify(a);i.has(c)||i.set(c,[]),i.get(c).push(u)}),i.size>1){let a=Array.from(i.entries()).map(([p,h])=>({value:JSON.parse(p),count:h.length,indices:h}));if(Math.max(...a.map(p=>p.count))/t.length>=e)continue;let l=qo(a,t.length);r.push({path:o,values:a,severity:l})}}return r}function qo(t,e){let n=Math.max(...t.map(o=>o.count))/e;return n>=.8?"minor":n>=.6?"moderate":n>=.4?"major":"critical"}function Ir(t){let e={},r=new Set;for(let i of t)i.data&&rr(i.data).forEach(a=>r.add(a));for(let i of r){let a=t.map((T,b)=>({value:Nr(T.data,i),index:b})).filter(T=>T.value!==void 0);if(a.length===0)continue;let u={},c=[];a.forEach(({value:T})=>{let b=JSON.stringify(T);u[b]=(u[b]||0)+1,c.push(T)});let l=0,p;for(let[T,b]of Object.entries(u))b>l&&(l=b,p=JSON.parse(T));let h=l/t.length,m=l===t.length,g=h;e[i]={path:i,value:p,agreement:h,votes:u,values:c,unanimous:m,confidence:g}}let n=Object.keys(e).filter(i=>e[i].unanimous),o=Object.keys(e).filter(i=>!e[i].unanimous),s=Object.values(e).reduce((i,a)=>i+a.agreement,0)/Object.keys(e).length;return{fields:e,overallAgreement:s,agreedFields:n,disagreedFields:o}}function rr(t,e=""){let r=[];if(t&&typeof t=="object"&&!Array.isArray(t))for(let n of Object.keys(t)){let o=e?`${e}.${n}`:n;r.push(o);let s=t[n];s&&typeof s=="object"&&!Array.isArray(s)&&r.push(...rr(s,o))}return r}function Nr(t,e){if(!t)return;let r=e.split("."),n=t;for(let o of r)if(n&&typeof n=="object"&&o in n)n=n[o];else return;return n}function Gt(t,e){if(t.length===0)throw new Error("No outputs to resolve");let r=e||t.map(s=>s.weight??1);if(t[0].data){let s=Ir(t),i={};for(let[a,u]of Object.entries(s.fields))Ho(i,a,u.value);return{...t[0],index:t[0].index??0,data:i,text:JSON.stringify(i)}}let n=0,o=-1;for(let s=0;s<t.length;s++){let i=0;for(let a=0;a<t.length;a++)if(s!==a){let u=Pr(t[s],t[a]);i+=u*(r[a]??1)}i>o&&(o=i,n=s)}return t[n]}function Mr(t,e){if(t.length===0)throw new Error("No outputs to resolve");let r=e||t.map(s=>s.weight??1),n=0,o=r[0]??1;for(let s=1;s<t.length;s++)(r[s]??1)>o&&(o=r[s]??1,n=s);return t[n]}function Mn(t){if(t.length===0)throw new Error("No outputs to resolve");if(t.length===1)return t[0];if(t[0].data){let n={},o=new Set;t.forEach(s=>{s.data&&rr(s.data).forEach(i=>o.add(i))});for(let s of o){let i=t.map(a=>Nr(a.data,s)).filter(a=>a!==void 0);i.length>0&&Ho(n,s,i[0])}return{...t[0],index:t[0].index??0,data:n,text:JSON.stringify(n)}}let r=Array.from(new Set(t.map(n=>n.text.trim()))).join(`

`);return{...t[0],index:t[0].index??0,text:r}}function Ho(t,e,r){let n=e.split("."),o=t;for(let s=0;s<n.length-1;s++){let i=n[s];i in o||(o[i]={}),o=o[i]}o[n[n.length-1]]=r}function $n(t,e,r){return t.length===0?!1:Math.max(...t.map(o=>o.count/e))>=r}async function bc(t){let{streams:e,schema:r,strategy:n="majority",threshold:o=.8,resolveConflicts:s="vote",weights:i,minimumAgreement:a=.6,timeout:u,signal:c,detectZeroTokens:l=!0,monitoring:p,onComplete:h,onConsensus:m,metadata:g}=t;if(e.length<2)throw new Error("Consensus requires at least 2 streams");let T=Date.now(),b=[],R=i||e.map(()=>1),M=e.map(async(q,G)=>{let N=Date.now();try{if(r){let B=await It({schema:r,stream:q,monitoring:p,detectZeroTokens:l}),zt=B.raw||JSON.stringify(B.data);return{index:G,text:zt,data:B.data,l0Result:void 0,structuredResult:B,status:"success",duration:Date.now()-N,weight:R[G]??1}}else{let B=await ue({stream:q,monitoring:p,signal:c,detectZeroTokens:l}),zt="";for await(let He of B.stream)He.type==="token"&&He.value&&(zt+=He.value);return{index:G,text:zt||B.state.content,data:void 0,l0Result:B,status:"success",duration:Date.now()-N,weight:R[G]??1}}}catch(B){return{index:G,text:"",data:void 0,l0Result:void 0,status:"error",error:B instanceof Error?B:new Error(String(B)),duration:Date.now()-N,weight:R[G]??1}}}),z=u?new Promise((q,G)=>setTimeout(()=>G(new Error("Consensus timeout")),u)):null,W=z?await Promise.race([Promise.all(M),z]):await Promise.all(M);b.push(...W),h&&await h(b);let C=b.filter(q=>q.status==="success");if(C.length===0)throw new Error("All consensus streams failed");let E=Pn(C),x=0,D=0,te=1,K=0;for(let q=0;q<E.length;q++)for(let G=q+1;G<E.length;G++){let N=E[q]?.[G]??0;x+=N,D++,te=Math.min(te,N),K=Math.max(K,N)}let se=D>0?x/D:1,ie=In(C,o),ne=Nn(C,o);if(!$n(ie,C.length,a)&&s==="fail")throw new Error(`Consensus failed: agreement ratio ${ie[0]?.ratio||0} below minimum ${a}`);let Z;switch(n){case"majority":Z=Gt(C,R);break;case"unanimous":if(se<.95){if(s==="fail")throw new Error("Unanimous consensus failed: outputs differ");Z=Gt(C,R)}else Z=C[0];break;case"weighted":if(!i)throw new Error("Weighted strategy requires weights to be provided");Z=Gt(C,i);break;case"best":Z=Mr(C,R);break;default:Z=Gt(C,R)}if(ne.length>0&&s!=="vote")switch(s){case"merge":Z=Mn(C);break;case"best":Z=Mr(C,R);break;case"fail":throw new Error(`Consensus failed: ${ne.length} disagreements found`)}ne.forEach(q=>{q.resolution=s,q.resolutionConfidence=se});let d=r?Ir(C):void 0,X=kc(C,ie,ne,se,n),le=Tc(C),xt={totalOutputs:b.length,successfulOutputs:C.length,failedOutputs:b.length-C.length,identicalOutputs:le,similarityMatrix:E,averageSimilarity:se,minSimilarity:te,maxSimilarity:K,totalAgreements:ie.length,totalDisagreements:ne.length,strategy:n,conflictResolution:s,duration:Date.now()-T},A=C.length===b.length?"success":C.length>0?"partial":"failed",j={consensus:r?Z.data:Z.text,confidence:X,outputs:b,agreements:ie,disagreements:ne,analysis:xt,type:r?"structured":"text",fieldConsensus:d,status:A,metadata:g};return m&&await m(j),j}function kc(t,e,r,n,o){if(t.length===1)return 1;let s=n;if(e.length>0){let i=Math.max(...e.map(a=>a.ratio));s=(s+i)/2}if(r.length>0){let a=r.filter(u=>u.severity==="major"||u.severity==="critical").length*.1;s=Math.max(0,s-a)}return o==="unanimous"&&n>.95&&(s=Math.min(1,s+.1)),Math.max(0,Math.min(1,s))}function Tc(t){if(t.length===0)return 0;let e=t[0].text;return t.filter(r=>r.text===e).length}function Ec(t,e=.8){if(t.length<2)return!0;let r=new Map;return t.forEach(s=>{r.set(s,(r.get(s)||0)+1)}),Math.max(...Array.from(r.values()))/t.length>=e}function wc(t){if(t.length===0)throw new Error("No outputs to get consensus from");let e=new Map;t.forEach(o=>{let s=JSON.stringify(o),i=e.get(s);i?i.count++:e.set(s,{value:o,count:1})});let r=0,n=t[0];for(let{value:o,count:s}of e.values())s>r&&(r=s,n=o);return n}function Sc(t,e=.8,r=0){return!(t.confidence<e||t.disagreements.filter(o=>o.severity==="major"||o.severity==="critical").length>r)}var Cc={strategy:"unanimous",threshold:1,resolveConflicts:"fail",minimumAgreement:1},Rc={strategy:"majority",threshold:.8,resolveConflicts:"vote",minimumAgreement:.6},_c={strategy:"majority",threshold:.7,resolveConflicts:"merge",minimumAgreement:.5},Oc={strategy:"best",threshold:.8,resolveConflicts:"best",minimumAgreement:.5};async function Ko(t,e,r={}){let{name:n,stopOnError:o=!0,timeout:s,signal:i,monitoring:a,onStart:u,onComplete:c,onError:l,onProgress:p,metadata:h={}}=r,m=Date.now(),g=[],T=e,b=e,R,M="success",z,W=s?new Promise((E,x)=>{z=setTimeout(()=>x(new Error(`Pipeline timeout after ${s}ms`)),s)}):null;try{u&&await u(e);for(let E=0;E<t.length;E++){let x=t[E],D=Date.now();if(i?.aborted)throw new Error("Pipeline aborted");let te={stepIndex:E,totalSteps:t.length,previousResults:g,metadata:h,signal:i};if(p&&await p(E,t.length),x.condition&&!await x.condition(T,te)){g.push({stepName:x.name,stepIndex:E,input:T,output:T,l0Result:void 0,status:"skipped",duration:Date.now()-D,startTime:D,endTime:Date.now()});continue}try{let K=await x.fn(T,te),se=async()=>{let d=await ue({...K,signal:i,monitoring:a}),X="";for await(let le of d.stream)le.type==="token"&&le.value&&(X+=le.value);return{...d,state:{...d.state,content:X||d.state.content}}},ie=W?await Promise.race([se(),W]):await se(),ne=x.transform?await x.transform(ie,te):ie.state.content,Z={stepName:x.name,stepIndex:E,input:T,output:ne,l0Result:ie,status:"success",duration:Date.now()-D,startTime:D,endTime:Date.now()};g.push(Z),x.onComplete&&await x.onComplete(Z,te),T=ne,b=ne}catch(K){let se=K instanceof Error?K:new Error(String(K)),ie={stepName:x.name,stepIndex:E,input:T,output:void 0,l0Result:void 0,status:"error",error:se,duration:Date.now()-D,startTime:D,endTime:Date.now()};if(g.push(ie),x.onError&&await x.onError(se,te),l&&await l(se,E),o){R=se,M="error";break}else M="partial"}}}catch(E){R=E instanceof Error?E:new Error(String(E)),M="error"}finally{z&&clearTimeout(z)}let C={name:n,output:b,steps:g,status:M,error:R,duration:Date.now()-m,startTime:m,endTime:Date.now(),metadata:h};return c&&await c(C),C}function Fn(t,e={}){let r=[...t],n={...e},o={name:e.name,steps:r,options:n,async run(s){return Ko(r,s,n)},addStep(s){return r.push(s),o},removeStep(s){let i=r.findIndex(a=>a.name===s);return i!==-1&&r.splice(i,1),o},getStep(s){return r.find(i=>i.name===s)},clone(){return Fn(r.map(s=>({...s})),{...n})}};return o}function Ac(t,e,r){return{name:t,fn:n=>({stream:()=>r(e(n))})}}function Lc(...t){let e=[];for(let r of t)e.push(...r.steps);return Fn(e,{name:t.map(r=>r.name).join(" -> ")})}async function Dc(t,e,r){let n=await Promise.all(t.map(o=>o.run(e)));return r(n)}function Pc(t,e,r,n){let o=new WeakMap;return{name:t,fn:async(s,i)=>{let u=await e(s,i)?r:n;return o.set(i,u),u.fn(s,i)},transform:async(s,i)=>{let a=o.get(i)??r;return a.transform?a.transform(s,i):s.state.content}}}var Ic={stopOnError:!0,monitoring:{enabled:!1}},Nc={stopOnError:!1,monitoring:{enabled:!0}},Mc={stopOnError:!1,timeout:3e5,monitoring:{enabled:!0}};function yt(t){return t&&t.replace(/\r\n/g,`
`).replace(/\r/g,`
`)}function Yo(t,e={}){if(!t)return t;let{collapseSpaces:r=!1,trimLines:n=!1,removeEmptyLines:o=!1}=e,s=t;return s=yt(s),r&&(s=s.replace(/ {2,}/g," ")),n&&(s=s.split(`
`).map(i=>i.trim()).join(`
`)),o&&(s=s.split(`
`).filter(i=>i.trim().length>0).join(`
`)),s}function Xo(t,e="spaces",r=2){if(!t)return t;let n=yt(t).split(`
`);return e==="spaces"?n.map(o=>o.replace(/\t/g," ".repeat(r))).join(`
`):n.map(o=>{let s=o,i=o.match(/^ +/);if(i){let a=i[0].length,u=Math.floor(a/r),c=a%r;s="	".repeat(u)+" ".repeat(c)+o.slice(a)}return s}).join(`
`)}function $r(t){if(!t)return t;let e=yt(t).split(`
`),r=1/0;for(let n of e){if(n.trim().length===0)continue;let o=n.match(/^[ \t]*/)?.[0].length??0;r=Math.min(r,o)}return r===1/0||r===0?t:e.map(n=>n.trim().length===0?n:n.slice(r)).join(`
`)}function $c(t,e=2){if(!t)return t;let r=typeof e=="number"?" ".repeat(e):e;return yt(t).split(`
`).map(o=>o.trim().length>0?r+o:o).join(`
`)}function Qo(t){if(!t)return t;let e=yt(t).split(`
`);for(;e.length>0&&e[0].trim().length===0;)e.shift();for(;e.length>0&&e[e.length-1].trim().length===0;)e.pop();return e.join(`
`).trim()}function es(t,e={}){if(!t)return t;let{newlines:r=!0,whitespace:n=!1,indentation:o=!1,spacesPerTab:s=2,dedent:i=!1,trim:a=!1}=e,u=t;return r&&(u=yt(u)),n&&(u=Yo(u,{collapseSpaces:!0,trimLines:!1,removeEmptyLines:!1})),o&&(u=Xo(u,o,s)),i&&(u=$r(u)),a&&(u=Qo(u)),u}function qe(t){return t&&es(t,{newlines:!0,whitespace:!0,trim:!0})}function Fr(t,e={}){if(!t||t.trim().length===0)return"";let{label:r="Context",dedent:n=!0,normalize:o=!0,delimiter:s="xml",customDelimiterStart:i,customDelimiterEnd:a}=e,u=t;if(o&&(u=qe(u)),n&&(u=$r(u)),i&&a)return`${i}
${u}
${a}`;switch(s){case"xml":return ts(u,r);case"markdown":return Fc(u,r);case"brackets":return jc(u,r);case"none":return u;default:return ts(u,r)}}function ts(t,e){let r=e.toLowerCase().replace(/\s+/g,"_");return`<${r}>
${t}
</${r}>`}function Fc(t,e){return`# ${e}

${t}`}function jc(t,e){let r="=".repeat(Math.max(20,e.length+10));return`[${e.toUpperCase()}]
${r}
${t}
${r}`}function Gc(t,e={}){return t.filter(n=>n.content&&n.content.trim().length>0).map(n=>Fr(n.content,{...e,label:n.label||e.label})).join(`

`)}function Vc(t,e,r={}){if(!t||t.trim().length===0)return"";let n="";if(e&&Object.keys(e).length>0){let o=Object.entries(e).filter(([s,i])=>i&&i.trim().length>0).map(([s,i])=>`${s}: ${i}`);o.length>0&&(n+=o.join(`
`)+`

`)}return n+=t,Fr(n,{label:e?.title||"Document",...r})}function zc(t,e={}){return Fr(t,{label:"Instructions",delimiter:"xml",...e})}function Bc(t,e="xml"){if(!t)return t;switch(e){case"xml":return t.replace(/</g,"&lt;").replace(/>/g,"&gt;");case"markdown":return t.replace(/^(#{1,6})\s/gm,"\\$1 ");case"brackets":return t.replace(/\[/g,"\\[").replace(/\]/g,"\\]");default:return t}}function Jc(t,e="xml"){if(!t)return t;switch(e){case"xml":return t.replace(/&lt;/g,"<").replace(/&gt;/g,">");case"markdown":return t.replace(/\\(#{1,6})\s/g,"$1 ");case"brackets":return t.replace(/\\\[/g,"[").replace(/\\\]/g,"]");default:return t}}function Uc(t,e={}){if(typeof t=="string")return qc(t,e);if(!t||t.length===0)return"";let{maxEntries:r,includeTimestamps:n=!1,includeMetadata:o=!1,style:s="conversational",normalize:i=!0}=e,a=r?t.slice(-r):t;switch(s){case"conversational":return rs(a,n,o,i);case"structured":return Wc(a,n,o,i);case"compact":return Zc(a,i);default:return rs(a,n,o,i)}}function rs(t,e,r,n){let o=[];for(let s of t){let i=n?qe(s.content):s.content,u=`${Hc(s.role)}: ${i}`;if(e&&s.timestamp&&(u=`[${new Date(s.timestamp).toISOString()}] ${u}`),r&&s.metadata){let c=Object.entries(s.metadata).map(([l,p])=>`${l}=${p}`).join(", ");c&&(u+=` (${c})`)}o.push(u)}return o.join(`

`)}function Wc(t,e,r,n){let o=["<conversation_history>"];for(let s of t){let i=n?qe(s.content):s.content,a=`role="${s.role}"`;if(e&&s.timestamp&&(a+=` timestamp="${s.timestamp}"`),r&&s.metadata){let u=JSON.stringify(s.metadata);a+=` metadata='${u}'`}o.push(`  <message ${a}>`),o.push(`    ${i}`),o.push("  </message>")}return o.push("</conversation_history>"),o.join(`
`)}function Zc(t,e){return t.map(r=>{let n=e?qe(r.content):r.content;return`${(r.role[0]??"U").toUpperCase()}: ${n}`}).join(`
`)}function qc(t,e){let{normalize:r=!0}=e;return r?qe(t):t}function Hc(t){switch(t){case"user":return"User";case"assistant":return"Assistant";case"system":return"System";default:return t.charAt(0).toUpperCase()+t.slice(1)}}function Kc(t,e,r){return{role:t,content:e,timestamp:Date.now(),metadata:r}}function Yc(...t){return t.flat().sort((e,r)=>{let n=e.timestamp||0,o=r.timestamp||0;return n-o})}function Xc(t,e){return t.filter(r=>r.role===e)}function Qc(t,e){return t.slice(-e)}function el(t){return t.reduce((e,r)=>e+r.content.length,0)}function tl(t,e){let r=[],n=0;for(let o=t.length-1;o>=0;o--){let s=t[o],i=s.content.length;if(n+i<=e)r.unshift(s),n+=i;else break}return r}function ns(t={}){let{includeInstructions:e=!0,strict:r=!0,schema:n,example:o}=t,s=[];return e&&(r?(s.push("Respond with valid JSON only. Do not include any text before or after the JSON object."),s.push("Do not wrap the JSON in markdown code blocks or backticks."),s.push("Start your response with { and end with }.")):s.push("Respond with valid JSON.")),n&&(s.push(""),s.push("Expected JSON schema:"),s.push(n)),o&&(s.push(""),s.push("Example output:"),s.push(o)),s.join(`
`)}function os(t,e={}){let{strict:r=!0,schema:n,example:o}=e,s=[];switch(t){case"json":return ns({includeInstructions:!0,strict:r,schema:n,example:o});case"yaml":r?(s.push("Respond with valid YAML only."),s.push("Do not include any text before or after the YAML.")):s.push("Respond with valid YAML.");break;case"xml":r?(s.push("Respond with valid XML only."),s.push("Start with an XML declaration or root element."),s.push("Do not include any text before or after the XML.")):s.push("Respond with valid XML.");break;case"markdown":s.push("Respond with well-formatted Markdown."),r&&s.push("Use proper Markdown syntax for all formatting.");break;case"plain":s.push("Respond with plain text only."),r&&s.push("Do not use any formatting, markdown, or special characters.");break}return n&&(s.push(""),s.push(`Expected ${t.toUpperCase()} schema:`),s.push(n)),o&&(s.push(""),s.push("Example output:"),s.push(o)),s.join(`
`)}function ss(t){let e=[];return t.maxLength&&e.push(`Keep your response under ${t.maxLength} characters.`),t.minLength&&e.push(`Provide at least ${t.minLength} characters in your response.`),t.noCodeBlocks&&e.push("Do not use code blocks or backticks."),t.noMarkdown&&e.push("Do not use Markdown formatting."),t.language&&e.push(`Respond in ${t.language}.`),t.tone&&e.push(`Use a ${t.tone} tone.`),e.join(`
`)}function rl(t){return`<output_format>
${t}
</output_format>`}function nl(t,e={}){let{wrap:r=!0,constraints:n}=e,o=[];o.push(os(t,e)),n&&(o.push(""),o.push(ss(n)));let s=o.join(`
`);return r?rl(s):s}function ol(t){if(!t)return null;let e=t.match(/```(?:json)?\s*\n?([\s\S]*?)\n?```/);if(e&&e[1])return e[1].trim();let r=t.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);return r&&r[1]?r[1].trim():null}function sl(t){if(!t)return t;let e=t.trim(),r=[/^here is the .+?:?\s*/i,/^here's the .+?:?\s*/i,/^sure,?\s*/i,/^certainly,?\s*/i,/^of course,?\s*/i];for(let n of r)e=e.replace(n,"");return e=e.replace(/^```(?:\w+)?\s*\n?/,""),e=e.replace(/\n?```\s*$/,""),e.trim()}function as(t,e={}){let{style:r="json-schema",includeExamples:n=!1,includeTypes:o=!0}=e;switch(r){case"json-schema":return jn(t,o);case"typescript":return il(t);case"natural":return al(t,n);case"xml":return ul(t);default:return jn(t,o)}}function jn(t,e=!0){let r={},n=[];for(let s of t.parameters){let i={description:s.description||""};e&&(i.type=s.type),s.enum&&(i.enum=s.enum),s.default!==void 0&&(i.default=s.default),r[s.name]=i,s.required&&n.push(s.name)}let o={name:t.name,description:t.description,parameters:{type:"object",properties:r,required:n.length>0?n:void 0}};return JSON.stringify(o,null,2)}function il(t){let e=t.parameters.map(n=>{let o=n.required?"":"?",s=n.type==="integer"?"number":n.type;return`${n.name}${o}: ${s}`}).join(", "),r=`/**
 * ${t.description}
`;for(let n of t.parameters)r+=` * @param ${n.name}`,n.description&&(r+=` - ${n.description}`),r+=`
`;return r+=` */
function ${t.name}(${e}): void;`,r}function al(t,e){let r=[];r.push(`Tool: ${t.name}`),r.push(`Description: ${t.description}`),r.push(""),r.push("Parameters:");for(let n of t.parameters){let o=n.required?"(required)":"(optional)",s=`  - ${n.name} ${o}: ${n.type}`;n.description&&(s+=` - ${n.description}`),n.enum&&(s+=` [Options: ${n.enum.join(", ")}]`),n.default!==void 0&&(s+=` [Default: ${n.default}]`),r.push(s)}if(e){r.push(""),r.push("Example usage:");let n=t.parameters.filter(o=>o.required).map(o=>{let s=o.enum?`"${o.enum[0]}"`:ml(o.type);return`"${o.name}": ${s}`}).join(", ");r.push(`  ${t.name}({ ${n} })`)}return r.join(`
`)}function ul(t){let e=[];e.push(`<tool name="${t.name}">`),e.push(`  <description>${is(t.description)}</description>`),e.push("  <parameters>");for(let r of t.parameters){let n=[`name="${r.name}"`,`type="${r.type}"`,r.required?'required="true"':'required="false"'];r.default!==void 0&&n.push(`default="${r.default}"`),e.push(`    <parameter ${n.join(" ")}>`),r.description&&e.push(`      <description>${is(r.description)}</description>`),r.enum&&e.push(`      <enum>${r.enum.join(", ")}</enum>`),e.push("    </parameter>")}return e.push("  </parameters>"),e.push("</tool>"),e.join(`
`)}function cl(t,e={}){let{style:r="json-schema"}=e;return r==="json-schema"?JSON.stringify(t.map(n=>JSON.parse(jn(n,!0))),null,2):t.map(n=>as(n,e)).join(`

`+"=".repeat(50)+`

`)}function ll(t,e,r){return{name:t,description:e,parameters:r}}function dl(t,e,r,n=!1){return{name:t,type:e,description:r,required:n}}function pl(t){let e=[];if((!t.name||t.name.trim().length===0)&&e.push("Tool name is required"),/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(t.name)||e.push("Tool name must be a valid identifier"),(!t.description||t.description.trim().length===0)&&e.push("Tool description is required"),!t.parameters||!Array.isArray(t.parameters))e.push("Tool parameters must be an array");else for(let r=0;r<t.parameters.length;r++){let n=t.parameters[r];(!n.name||n.name.trim().length===0)&&e.push(`Parameter ${r} is missing a name`),/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(n.name)||e.push(`Parameter ${n.name} must be a valid identifier`),n.type||e.push(`Parameter ${n.name} is missing a type`),["string","number","integer","boolean","array","object"].includes(n.type)||e.push(`Parameter ${n.name} has invalid type: ${n.type}`)}return e}function ml(t){switch(t){case"string":return'"example"';case"number":case"integer":return"42";case"boolean":return"true";case"array":return"[]";case"object":return"{}";default:return'""'}}function is(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function fl(t,e=!1){return JSON.stringify(t,null,e?2:0)}function hl(t){let e=[/\{\s*"name"\s*:\s*"([^"]+)"\s*,\s*"arguments"\s*:\s*(\{[^}]*\})\s*\}/,/([a-zA-Z_][a-zA-Z0-9_]*)\s*\(\s*(\{[^}]*\})\s*\)/];for(let r of e){let n=t.match(r);if(n&&n[1]&&n[2])try{let o=n[1],s=JSON.parse(n[2]);return{name:o,arguments:s}}catch{continue}}return null}function gl(t){return t&&t.trim()}function yl(t){return t&&t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/'/g,"\\'").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")}function vl(t){if(!t)return t;let e="\0BACKSLASH\0";return t.replace(/\\\\/g,e).replace(/\\t/g,"	").replace(/\\r/g,"\r").replace(/\\n/g,`
`).replace(/\\'/g,"'").replace(/\\"/g,'"').replace(new RegExp(e,"g"),"\\")}function xl(t){if(!t)return t;let e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>"']/g,r=>e[r]||r)}function bl(t){if(!t)return t;let e={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#x27;":"'"};return t.replace(/&(?:amp|lt|gt|quot|#39|#x27);/g,r=>e[r]||r)}function kl(t){return t&&t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Tl(t){return t&&t.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"")}function El(t,e,r="..."){if(!t||t.length<=e)return t;let n=e-r.length;return t.slice(0,n)+r}function wl(t,e,r="..."){if(!t||t.length<=e)return t;let n=e-r.length,o=t.slice(0,n),s=o.lastIndexOf(" ");return s>0?o.slice(0,s)+r:o+r}function Sl(t,e){if(!t)return t;let r=t.split(/\s+/),n=[],o="";for(let s of r)o.length+s.length+1<=e?o+=(o?" ":"")+s:(o&&n.push(o),o=s);return o&&n.push(o),n.join(`
`)}function Cl(t,e,r=" ",n="left"){if(t||(t=""),t.length>=e)return t;let o=e-t.length;switch(n){case"right":return r.repeat(o)+t;case"center":{let s=Math.floor(o/2),i=o-s;return r.repeat(s)+t+r.repeat(i)}case"left":default:return t+r.repeat(o)}}function Rl(t){return t&&t.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,"")}function nr(t){if(!t||t.trim().length===0)return t;let e=t.trim();return e=us(e),e=cs(e),e=ls(e),e=_l(e),e}function us(t){if(!t)return t;let e=0,r=0,n=!1,o=!1;for(let s=0;s<t.length;s++){let i=t[s];if(o){o=!1;continue}if(i==="\\"){o=!0;continue}if(i==='"'){n=!n;continue}n||(i==="{"&&e++,i==="}"&&r++)}if(e>r)return t+"}".repeat(e-r);if(r>e){let s=t,i=r-e;for(let a=s.length-1;a>=0&&i>0;a--)s[a]==="}"&&(s=s.slice(0,a)+s.slice(a+1),i--);return s}return t}function cs(t){if(!t)return t;let e=0,r=0,n=!1,o=!1;for(let s=0;s<t.length;s++){let i=t[s];if(o){o=!1;continue}if(i==="\\"){o=!0;continue}if(i==='"'){n=!n;continue}n||(i==="["&&e++,i==="]"&&r++)}if(e>r)return t+"]".repeat(e-r);if(r>e){let s=t,i=r-e;for(let a=s.length-1;a>=0&&i>0;a--)s[a]==="]"&&(s=s.slice(0,a)+s.slice(a+1),i--);return s}return t}function ls(t){return t&&t.replace(/,(\s*})/g,"$1").replace(/,(\s*])/g,"$1")}function _l(t){if(!t)return t;let e=0,r=!1;for(let n=0;n<t.length;n++){let o=t[n];if(r){r=!1;continue}if(o==="\\"){r=!0;continue}o==='"'&&e++}return e%2!==0?t+'"':t}function Ol(t){if(!t)return t;let e=/```/g,r=t.match(e);return r&&r.length%2!==0?t+"\n```":t}function Al(t){if(!t)return t;let e=/\\begin\{(\w+)\}/g,r=/\\end\{(\w+)\}/g,n=Array.from(t.matchAll(e)),o=Array.from(t.matchAll(r)),s=[];for(let a of n)s.push(a[1]);for(let a of o){let u=a[1],c=s.lastIndexOf(u);c!==-1&&s.splice(c,1)}let i=t;for(let a of s.reverse())i+=`
\\end{${a}}`;return i}function Ll(t){if(!t)return t;let e=t.trim();return!e.startsWith("{")&&!e.startsWith("[")&&(e="{"+e),e=nr(e),e}function Gn(t){if(!t||t.trim().length===0)return!1;try{return JSON.parse(t),!0}catch{return!1}}function Dl(t){if(!t)return null;try{return JSON.parse(t)}catch{let e=nr(t);try{return JSON.parse(e)}catch{return null}}}function Pl(t){if(!t)return null;let e=t.indexOf("{"),r=t.indexOf("["),n=-1;if(e!==-1&&r!==-1?n=Math.min(e,r):e!==-1?n=e:r!==-1&&(n=r),n===-1)return null;let o=t[n],s=o==="{"?"}":"]",i=0,a=!1,u=!1;for(let c=n;c<t.length;c++){let l=t[c];if(u){u=!1;continue}if(l==="\\"){u=!0;continue}if(l==='"'){a=!a;continue}if(!a&&(l===o&&i++,l===s&&(i--,i===0)))return t.slice(n,c+1)}return nr(t.slice(n))}function Il(t,e){return JSON.stringify({[t]:e})}function Nl(t,e="content"){if(!t)return"{}";if(Gn(t))return t;let r=nr(t);return Gn(r)?r:Il(e,t)}async function*Ml(t,e){try{for await(let r of t){let n=e(r);n!=null&&(yield{type:"token",value:n,timestamp:Date.now()})}yield{type:"complete",timestamp:Date.now()}}catch(r){yield{type:"error",error:r instanceof Error?r:new Error(String(r)),timestamp:Date.now()}}}async function*$l(t,e){try{for await(let r of t){let n=e.extractText(r);if(n!=null){yield{type:"token",value:n,timestamp:Date.now()};continue}if(e.extractMessage){let o=e.extractMessage(r);o!=null&&(yield{type:"message",value:o.value,role:o.role,timestamp:Date.now()})}}yield{type:"complete",timestamp:Date.now()}}catch(r){yield{type:"error",error:r instanceof Error?r:new Error(String(r)),timestamp:Date.now()}}}function ds(t){return{type:"token",value:t,timestamp:Date.now()}}function ps(){return{type:"complete",timestamp:Date.now()}}function ms(t){return{type:"error",error:t instanceof Error?t:new Error(String(t)),timestamp:Date.now()}}function fs(t,e){return{type:"message",value:t,role:e,timestamp:Date.now()}}function or(t){return{type:"data",data:t,timestamp:Date.now()}}function hs(t){return{type:"progress",progress:t,timestamp:Date.now()}}function Fl(t){let e={contentType:"image",mimeType:t.mimeType??"image/png",url:t.url,base64:t.base64,bytes:t.bytes,metadata:{width:t.width,height:t.height,seed:t.seed,model:t.model}};return e.metadata&&(e.metadata=Object.fromEntries(Object.entries(e.metadata).filter(([r,n])=>n!==void 0)),Object.keys(e.metadata).length===0&&delete e.metadata),or(e)}function jl(t){let e={contentType:"audio",mimeType:t.mimeType??"audio/mp3",url:t.url,base64:t.base64,bytes:t.bytes,metadata:{duration:t.duration,model:t.model}};return e.metadata&&(e.metadata=Object.fromEntries(Object.entries(e.metadata).filter(([r,n])=>n!==void 0)),Object.keys(e.metadata).length===0&&delete e.metadata),or(e)}function Gl(t,e){return or({contentType:"json",mimeType:"application/json",json:t,metadata:e})}async function*Vl(t,e){try{for await(let r of t){if(e.extractText){let n=e.extractText(r);if(n!=null){yield ds(n);continue}}if(e.extractData){let n=e.extractData(r);if(n!=null){yield or(n);continue}}if(e.extractProgress){let n=e.extractProgress(r);if(n!=null){yield hs(n);continue}}if(e.extractMessage){let n=e.extractMessage(r);if(n!=null){yield fs(n.value,n.role);continue}}}yield ps()}catch(r){yield ms(r)}}async function*Vn(t,e={}){let{includeUsage:r=!0,includeToolCalls:n=!0,emitFunctionCallsAsTokens:o=!1,choiceIndex:s=0}=e,i,a=new Map,u=c=>(a.has(c)||a.set(c,{functionCallAccumulator:null,toolCallsAccumulator:new Map,finished:!1}),a.get(c));try{for await(let c of t){let l=c.choices;if(!(!l||l.length===0)){c.usage&&(i=c.usage);for(let p of l){if(!p)continue;let h=p.index;if(s!=="all"&&h!==s)continue;let m=u(h),g=p.delta;if(!g)continue;let T=s==="all"?`[choice:${h}]`:"";if(g.content&&(yield{type:"token",value:T?`${T}${g.content}`:g.content,timestamp:Date.now()}),g.function_call&&(g.function_call.name?m.functionCallAccumulator={name:g.function_call.name,arguments:g.function_call.arguments||""}:g.function_call.arguments&&m.functionCallAccumulator&&(m.functionCallAccumulator.arguments+=g.function_call.arguments),o&&g.function_call.arguments&&(yield{type:"token",value:g.function_call.arguments,timestamp:Date.now()})),g.tool_calls)for(let b of g.tool_calls){let R=m.toolCallsAccumulator.get(b.index);b.id||b.function?.name?m.toolCallsAccumulator.set(b.index,{id:b.id||R?.id||"",name:b.function?.name||R?.name||"",arguments:b.function?.arguments||""}):b.function?.arguments&&R&&(R.arguments+=b.function.arguments),o&&b.function?.arguments&&(yield{type:"token",value:b.function.arguments,timestamp:Date.now()})}if(p.finish_reason&&!m.finished&&(m.finished=!0,m.functionCallAccumulator&&n&&(yield{type:"message",value:JSON.stringify({type:"function_call",function_call:m.functionCallAccumulator,...s==="all"?{choiceIndex:h}:{}}),role:"assistant",timestamp:Date.now()}),m.toolCallsAccumulator.size>0&&n)){let b=Array.from(m.toolCallsAccumulator.values());yield{type:"message",value:JSON.stringify({type:"tool_calls",tool_calls:b,...s==="all"?{choiceIndex:h}:{}}),role:"assistant",timestamp:Date.now()}}}}}yield{type:"complete",timestamp:Date.now(),...r&&i?{usage:i}:{}}}catch(c){yield{type:"error",error:c instanceof Error?c:new Error(String(c)),timestamp:Date.now()}}}function jr(t,e,r){return async()=>{let n=await t.chat.completions.create({...e,stream:!0});return Vn(n,r)}}function zl(t,e,r,n){let o=typeof r=="string"?[{role:"user",content:r}]:r,{includeUsage:s,includeToolCalls:i,emitFunctionCallsAsTokens:a,...u}=n||{};return jr(t,{model:e,messages:o,...u},{includeUsage:s,includeToolCalls:i,emitFunctionCallsAsTokens:a})}function Bl(t,e,r,n){let o=typeof r=="string"?[{role:"user",content:r}]:r,{includeUsage:s,includeToolCalls:i,emitFunctionCallsAsTokens:a,...u}=n||{};return jr(t,{model:e,messages:o,response_format:{type:"json_object"},...u},{includeUsage:s,includeToolCalls:i,emitFunctionCallsAsTokens:a})}function Jl(t,e,r,n,o){let{includeUsage:s,includeToolCalls:i,emitFunctionCallsAsTokens:a,...u}=o||{};return jr(t,{model:e,messages:r,tools:n,...u},{includeUsage:s,includeToolCalls:i??!0,emitFunctionCallsAsTokens:a})}function Ul(t){if(!t||typeof t!="object"||!("choices"in t))return!1;let e=t;if(!Array.isArray(e.choices)||e.choices.length===0)return!1;let r=e.choices[0];return r!==void 0&&"delta"in r}async function Wl(t){let e="";for await(let r of t){let n=r.choices?.[0]?.delta?.content;n&&(e+=n)}return e}function gs(t){if(!t||typeof t!="object"||!(Symbol.asyncIterator in t))return!1;let e=t;return typeof e.toReadableStream=="function"&&"controller"in e||"response"in e&&typeof e.toReadableStream=="function"}var Zl={name:"openai",detect:gs,wrap:Vn};function ql(t){if(!t||typeof t!="object")return!1;let e=t;return typeof e.type!="string"?!1:["message_start","content_block_start","content_block_delta","content_block_stop","message_delta","message_stop"].includes(e.type)}function ys(t){if(!t||typeof t!="object"||!(Symbol.asyncIterator in t))return!1;let e=t;return typeof e.on=="function"&&typeof e.finalMessage=="function"||"controller"in e&&"body"in e}async function*zn(t,e={}){let{includeUsage:r=!0,includeToolUse:n=!0}=e,o={},s=!1,i=new Map;try{for await(let a of t)switch(a.type){case"message_start":{let c=a;c.message?.usage&&(o.input_tokens=c.message.usage.input_tokens,o.output_tokens=c.message.usage.output_tokens);break}case"content_block_start":{let c=a;c.content_block?.type==="tool_use"&&n&&i.set(c.index,{id:c.content_block.id||"",name:c.content_block.name||"",input:""});break}case"content_block_delta":{let c=a;if(c.delta?.type==="text_delta"&&c.delta.text!=null)yield{type:"token",value:c.delta.text,timestamp:Date.now()};else if(c.delta?.type==="input_json_delta"&&c.delta.partial_json!=null){let l=i.get(c.index);l&&(l.input+=c.delta.partial_json)}break}case"content_block_stop":{let c=a;if(n){let l=i.get(c.index);l&&(yield{type:"message",value:JSON.stringify({type:"tool_use",tool_use:{id:l.id,name:l.name,input:l.input}}),role:"assistant",timestamp:Date.now()},i.delete(c.index))}break}case"message_delta":{let c=a;c.usage?.output_tokens!=null&&(o.output_tokens=c.usage.output_tokens);break}case"message_stop":{s||(s=!0,yield{type:"complete",timestamp:Date.now(),...r&&(o.input_tokens||o.output_tokens)?{usage:o}:{}});break}}s||(s=!0,yield{type:"complete",timestamp:Date.now(),...r&&(o.input_tokens||o.output_tokens)?{usage:o}:{}})}catch(a){yield{type:"error",error:a instanceof Error?a:new Error(String(a)),timestamp:Date.now()}}}var Hl={name:"anthropic",detect:ys,wrap:zn};function vs(t,e,r){return async()=>{let n=t.messages.stream(e);return zn(n,r)}}function Kl(t,e,r,n){let{maxTokens:o=1024,system:s,includeUsage:i,includeToolUse:a}=n||{};return vs(t,{model:e,max_tokens:o,messages:[{role:"user",content:r}],...s?{system:s}:{}},{includeUsage:i,includeToolUse:a})}async function*Bn(t,e={}){let{includeUsage:r=!0,includeToolCalls:n=!0,includeReasoning:o=!1}=e;try{let i=t.textStream.getReader();for(;;){let{done:c,value:l}=await i.read();if(c)break;l&&(yield{type:"token",value:l,timestamp:Date.now()})}if(o)try{let c=await t.reasoningText;c&&(yield{type:"message",value:JSON.stringify({type:"reasoning",reasoning:c}),role:"assistant",timestamp:Date.now()})}catch{}if(n){try{let c=await t.toolCalls;c&&c.length>0&&(yield{type:"message",value:JSON.stringify({type:"tool_calls",tool_calls:c.map(l=>({id:l.payload?.toolCallId??l.toolCallId,name:l.payload?.toolName??l.toolName,arguments:JSON.stringify(l.payload?.args??l.args)}))}),role:"assistant",timestamp:Date.now()})}catch{}try{let c=await t.toolResults;c&&c.length>0&&(yield{type:"message",value:JSON.stringify({type:"tool_results",tool_results:c.map(l=>({id:l.payload?.toolCallId??l.toolCallId,name:l.payload?.toolName??l.toolName,result:l.payload?.result??l.result}))}),role:"assistant",timestamp:Date.now()})}catch{}}let a,u;if(r)try{a=await t.usage}catch{}try{u=await t.finishReason}catch{}yield{type:"complete",timestamp:Date.now(),...r&&a?{usage:a}:{},...u?{finishReason:u}:{}}}catch(s){yield{type:"error",error:s instanceof Error?s:new Error(String(s)),timestamp:Date.now()}}}function Jn(t,e,r,n){return async()=>{let o=await t.stream(e,r);return Bn(o,n)}}function Yl(t,e,r){let{includeUsage:n,includeToolCalls:o,includeReasoning:s,...i}=r||{};return Jn(t,e,i,{includeUsage:n,includeToolCalls:o,includeReasoning:s})}function Xl(t,e,r,n){let{includeUsage:o,includeToolCalls:s,includeReasoning:i,...a}=n||{};return Jn(t,e,{...a,structuredOutput:{schema:r}},{includeUsage:o,includeToolCalls:s,includeReasoning:i})}async function*Ql(t,e={}){let{includeUsage:r=!0,includeToolCalls:n=!0,includeReasoning:o=!1}=e;try{let i=t.fullStream.getReader();for(;;){let{done:a,value:u}=await i.read();if(a)break;if(!u)continue;let c=u;switch(c.type){case"text-delta":yield{type:"token",value:c.payload?.text??c.textDelta,timestamp:Date.now()};break;case"reasoning":o&&(yield{type:"message",value:JSON.stringify({type:"reasoning",reasoning:c.payload?.text??c.textDelta}),role:"assistant",timestamp:Date.now()});break;case"tool-call":if(n){let p=c.payload??c;yield{type:"message",value:JSON.stringify({type:"tool_call",tool_call:{id:p.toolCallId,name:p.toolName,arguments:JSON.stringify(p.args)}}),role:"assistant",timestamp:Date.now()}}break;case"tool-result":if(n){let p=c.payload??c;yield{type:"message",value:JSON.stringify({type:"tool_result",tool_result:{id:p.toolCallId,name:p.toolName,result:p.result}}),role:"assistant",timestamp:Date.now()}}break;case"finish":let l;if(r)try{l=await t.usage}catch{}yield{type:"complete",timestamp:Date.now(),...r&&l?{usage:l}:{},...c.finishReason?{finishReason:c.finishReason}:{}};break;case"error":yield{type:"error",error:c.error instanceof Error?c.error:new Error(String(c.error)),timestamp:Date.now()};break}}}catch(s){yield{type:"error",error:s instanceof Error?s:new Error(String(s)),timestamp:Date.now()}}}function xs(t){if(!t||typeof t!="object")return!1;let e=t;return"textStream"in e&&"text"in e&&"usage"in e&&"finishReason"in e&&typeof e.textStream=="object"&&e.textStream!==null&&"getReader"in e.textStream}async function ed(t){return t.text}async function td(t){return t.object}var rd={name:"mastra",detect:xs,wrap:Bn};function nd(t){return{name:t.name,message:t.message,stack:t.stack,code:t.code,metadata:t.metadata}}function Un(t){let e=new Error(t.message);return e.name=t.name,e.stack=t.stack,e.code=t.code,e.metadata=t.metadata,e}function Wn(){let t=Date.now().toString(36),e=Math.random().toString(36).substring(2,10);return`l0_${t}_${e}`}var Vt=class{streams=new Map;snapshots=new Map;async append(e,r){let n=this.streams.get(e);n||(n=[],this.streams.set(e,n));let o={streamId:e,seq:n.length,event:r};n.push(o)}async getEvents(e){return this.streams.get(e)??[]}async exists(e){return this.streams.has(e)}async getLastEvent(e){let r=this.streams.get(e);return!r||r.length===0?null:r[r.length-1]}async getEventsAfter(e,r){let n=this.streams.get(e);return n?n.filter(o=>o.seq>r):[]}async delete(e){this.streams.delete(e),this.snapshots.delete(e)}async listStreams(){return Array.from(this.streams.keys())}async saveSnapshot(e){let r=this.snapshots.get(e.streamId);r||(r=[],this.snapshots.set(e.streamId,r)),r.push(e)}async getSnapshot(e){let r=this.snapshots.get(e);return!r||r.length===0?null:r[r.length-1]}async getSnapshotBefore(e,r){let n=this.snapshots.get(e);if(!n||n.length===0)return null;let o=null;for(let s of n)s.seq<=r&&(!o||s.seq>o.seq)&&(o=s);return o}clear(){this.streams.clear(),this.snapshots.clear()}getTotalEventCount(){let e=0;for(let r of this.streams.values())e+=r.length;return e}getStreamCount(){return this.streams.size}},Gr=class{streamId;eventStore;seq=0;constructor(e,r){this.eventStore=e,this.streamId=r??Wn()}getStreamId(){return this.streamId}getSeq(){return this.seq}async record(e){await this.eventStore.append(this.streamId,e),this.seq++}async recordStart(e){await this.record({type:"START",ts:Date.now(),options:e})}async recordToken(e,r){await this.record({type:"TOKEN",ts:Date.now(),value:e,index:r})}async recordCheckpoint(e,r){await this.record({type:"CHECKPOINT",ts:Date.now(),at:e,content:r})}async recordGuardrail(e,r){await this.record({type:"GUARDRAIL",ts:Date.now(),at:e,result:r})}async recordDrift(e,r){await this.record({type:"DRIFT",ts:Date.now(),at:e,result:r})}async recordRetry(e,r,n){await this.record({type:"RETRY",ts:Date.now(),reason:e,attempt:r,countsTowardLimit:n})}async recordFallback(e){await this.record({type:"FALLBACK",ts:Date.now(),to:e})}async recordContinuation(e,r){await this.record({type:"CONTINUATION",ts:Date.now(),checkpoint:e,at:r})}async recordComplete(e,r){await this.record({type:"COMPLETE",ts:Date.now(),content:e,tokenCount:r})}async recordError(e,r){await this.record({type:"ERROR",ts:Date.now(),error:e,recoverable:r})}},Vr=class{eventStore;constructor(e){this.eventStore=e}async*replay(e,r={}){let{speed:n=0,fromSeq:o=0,toSeq:s=1/0}=r,i=await this.eventStore.getEvents(e),a=null;for(let u of i)if(!(u.seq<o)){if(u.seq>s)break;if(n>0&&a!==null){let c=(u.event.ts-a)/n;c>0&&await new Promise(l=>setTimeout(l,c))}a=u.event.ts,yield u}}async replayToState(e){let r={content:"",tokenCount:0,checkpoint:"",violations:[],driftDetected:!1,retryAttempts:0,networkRetryCount:0,fallbackIndex:0,completed:!1,error:null,startTs:0,endTs:0},n=await this.eventStore.getEvents(e);for(let o of n){let s=o.event;switch(s.type){case"START":r.startTs=s.ts;break;case"TOKEN":r.content+=s.value,r.tokenCount=s.index+1;break;case"CHECKPOINT":r.checkpoint=s.content;break;case"GUARDRAIL":r.violations.push(...s.result.violations);break;case"DRIFT":s.result.detected&&(r.driftDetected=!0);break;case"RETRY":s.countsTowardLimit?r.retryAttempts++:r.networkRetryCount++;break;case"FALLBACK":r.fallbackIndex=s.to;break;case"CONTINUATION":r.content=s.checkpoint;break;case"COMPLETE":r.completed=!0,r.content=s.content,r.tokenCount=s.tokenCount,r.endTs=s.ts;break;case"ERROR":r.error=s.error,r.endTs=s.ts;break}}return r}async*replayTokens(e,r={}){for await(let n of this.replay(e,r))n.event.type==="TOKEN"&&(yield n.event.value)}};function od(){return new Vt}function sd(t,e){return new Gr(t,e)}function id(t){return new Vr(t)}async function ad(t){let{streamId:e,eventStore:r,speed:n=0,fireCallbacks:o=!0,fromSeq:s=0,toSeq:i=1/0}=t;if(!await r.exists(e))throw new Error(`Stream not found: ${e}`);let u=await r.getEvents(e);if(u.length===0)throw new Error(`Stream has no events: ${e}`);let c=u.find(C=>C.event.type==="START"),l=c?c.event.options:{},p=ud(),h=[],m=new AbortController,g=new ze({enabled:!0,includeTimings:!0});g.start();let T,b,R,M;return{stream:async function*(){let C=null;for(let E of u){if(E.seq<s)continue;if(E.seq>i||m.signal.aborted)break;let x=E.event;if(n>0&&C!==null){let D=(x.ts-C)/n;D>0&&await new Promise(te=>setTimeout(te,D))}switch(C=x.ts,x.type){case"START":break;case"TOKEN":{p.content+=x.value,p.tokenCount=x.index+1,g.recordToken(x.ts);let D={type:"token",value:x.value,timestamp:x.ts};o&&(T&&T(x.value),M&&M(D)),yield D;break}case"CHECKPOINT":p.checkpoint=x.content;break;case"GUARDRAIL":{if(p.violations.push(...x.result.violations),g.recordGuardrailViolations(x.result.violations),o&&b)for(let D of x.result.violations)b(D);break}case"DRIFT":x.result.detected&&(p.driftDetected=!0,g.recordDrift(!0,x.result.types));break;case"RETRY":{x.countsTowardLimit?p.modelRetryCount++:p.networkRetryCount++,g.recordRetry(!x.countsTowardLimit),o&&R&&R(x.attempt,x.reason);break}case"FALLBACK":p.fallbackIndex=x.to;break;case"CONTINUATION":p.resumed=!0,p.resumePoint=x.checkpoint,g.recordContinuation(!0,!0,x.checkpoint);break;case"COMPLETE":{p.completed=!0,p.content=x.content,p.tokenCount=x.tokenCount,g.complete();let D={type:"complete",timestamp:x.ts};o&&M&&M(D),yield D;break}case"ERROR":{let D=Un(x.error);h.push(D);let te={type:"error",error:D,timestamp:x.ts};o&&M&&M(te),yield te;break}}}}(),state:p,errors:h,telemetry:g.export(),abort:()=>m.abort(),streamId:e,isReplay:!0,originalOptions:l,setCallbacks(C){T=C.onToken,b=C.onViolation,R=C.onRetry,M=C.onEvent}}}function ud(){return{content:"",checkpoint:"",tokenCount:0,modelRetryCount:0,networkRetryCount:0,fallbackIndex:0,violations:[],driftDetected:!1,completed:!1,networkErrors:[],resumed:!1,dataOutputs:[]}}function cd(t,e){let r=[];return t.content!==e.content&&r.push(`content: "${t.content.slice(0,50)}..." vs "${e.content.slice(0,50)}..."`),t.tokenCount!==e.tokenCount&&r.push(`tokenCount: ${t.tokenCount} vs ${e.tokenCount}`),t.completed!==e.completed&&r.push(`completed: ${t.completed} vs ${e.completed}`),t.modelRetryCount!==e.modelRetryCount&&r.push(`modelRetryCount: ${t.modelRetryCount} vs ${e.modelRetryCount}`),t.fallbackIndex!==e.fallbackIndex&&r.push(`fallbackIndex: ${t.fallbackIndex} vs ${e.fallbackIndex}`),t.violations.length!==e.violations.length&&r.push(`violations: ${t.violations.length} vs ${e.violations.length}`),t.driftDetected!==e.driftDetected&&r.push(`driftDetected: ${t.driftDetected} vs ${e.driftDetected}`),{identical:r.length===0,differences:r}}async function ld(t,e){if(!await t.exists(e))return null;let n=await t.getEvents(e);if(n.length===0)return null;let o=n.find(u=>u.event.type==="START"),s=n.find(u=>u.event.type==="COMPLETE"),i=n.find(u=>u.event.type==="ERROR"),a=n.filter(u=>u.event.type==="TOKEN");return{streamId:e,eventCount:n.length,tokenCount:a.length,startTs:o?.event.ts??n[0].event.ts,endTs:(s??i??n[n.length-1]).event.ts,completed:!!s,hasError:!!i,options:o?o.event.options:{}}}var Zr=new Map;function qr(t,e){Zr.set(t,e)}function dd(t){return Zr.delete(t)}function bs(){return Array.from(Zr.keys())}async function pd(t){let e=Zr.get(t.type);if(!e){let r=bs().join(", ")||"none";throw new Error(`Unknown storage adapter type: "${t.type}". Available adapters: ${r}`)}return e(t)}qr("memory",()=>new Vt);var zr=class{prefix;ttl;constructor(e={type:"base"}){this.prefix=e.prefix??"l0",this.ttl=e.ttl??0}getStreamKey(e){return`${this.prefix}:stream:${e}`}getMetaKey(e){return`${this.prefix}:meta:${e}`}isExpired(e){return this.ttl===0?!1:Date.now()-e>this.ttl}async getLastEvent(e){let r=await this.getEvents(e);return r.length>0?r[r.length-1]:null}async getEventsAfter(e,r){return(await this.getEvents(e)).filter(o=>o.seq>r)}},sr=class extends zr{getSnapshotKey(e){return`${this.prefix}:snapshot:${e}`}async getSnapshotBefore(e,r){let n=await this.getSnapshot(e);return n&&n.seq<=r?n:null}},Br=class t extends sr{basePath;fs=null;path=null;constructor(e){super(e),this.basePath=e.basePath??e.connection??"./l0-events"}async ensureFs(){this.fs||(this.fs=await import("fs/promises"),this.path=await import("path"),await this.fs.mkdir(this.basePath,{recursive:!0}))}static validateStreamId(e){if(!e||e.length===0)throw new Error("Invalid stream ID: must not be empty");if(!/^[a-zA-Z0-9_-]+$/.test(e))throw new Error("Invalid stream ID: only alphanumeric characters, hyphens, and underscores are allowed");return e}getFilePath(e){let r=t.validateStreamId(e);return this.path.join(this.basePath,`${r}.json`)}getSnapshotFilePath(e){let r=t.validateStreamId(e);return this.path.join(this.basePath,`${r}.snapshot.json`)}async append(e,r){await this.ensureFs();let n=this.getFilePath(e),o=[];try{let i=await this.fs.readFile(n,"utf-8");o=JSON.parse(i)}catch{}let s={streamId:e,seq:o.length,event:r};o.push(s),await this.fs.writeFile(n,JSON.stringify(o,null,2))}async getEvents(e){await this.ensureFs();let r=this.getFilePath(e);try{let n=await this.fs.readFile(r,"utf-8"),o=JSON.parse(n);return this.ttl>0?o.filter(s=>!this.isExpired(s.event.ts)):o}catch{return[]}}async exists(e){await this.ensureFs();let r=this.getFilePath(e);try{return await this.fs.access(r),!0}catch{return!1}}async delete(e){await this.ensureFs();let r=this.getFilePath(e),n=this.getSnapshotFilePath(e);try{await this.fs.unlink(r)}catch{}try{await this.fs.unlink(n)}catch{}}async listStreams(){await this.ensureFs();try{return(await this.fs.readdir(this.basePath)).filter(r=>r.endsWith(".json")&&!r.endsWith(".snapshot.json")).map(r=>r.replace(".json",""))}catch{return[]}}async saveSnapshot(e){await this.ensureFs();let r=this.getSnapshotFilePath(e.streamId);await this.fs.writeFile(r,JSON.stringify(e,null,2))}async getSnapshot(e){await this.ensureFs();let r=this.getSnapshotFilePath(e);try{let n=await this.fs.readFile(r,"utf-8");return JSON.parse(n)}catch{return null}}};qr("file",t=>new Br(t));var Jr=class extends sr{storage;constructor(e={type:"localStorage"}){super(e);let n=(typeof globalThis<"u"?globalThis:{}).localStorage;if(!n)throw new Error("LocalStorage is not available in this environment");this.storage=n}async append(e,r){let n=this.getStreamKey(e),o=this.storage.getItem(n),s=o?JSON.parse(o):[],i={streamId:e,seq:s.length,event:r};s.push(i),this.storage.setItem(n,JSON.stringify(s)),this.addToStreamList(e)}async getEvents(e){let r=this.getStreamKey(e),n=this.storage.getItem(r);if(!n)return[];let o=JSON.parse(n);return this.ttl>0?o.filter(s=>!this.isExpired(s.event.ts)):o}async exists(e){let r=this.getStreamKey(e);return this.storage.getItem(r)!==null}async delete(e){this.storage.removeItem(this.getStreamKey(e)),this.storage.removeItem(this.getSnapshotKey(e)),this.removeFromStreamList(e)}async listStreams(){let e=`${this.prefix}:streams`,r=this.storage.getItem(e);return r?JSON.parse(r):[]}async saveSnapshot(e){let r=this.getSnapshotKey(e.streamId);this.storage.setItem(r,JSON.stringify(e))}async getSnapshot(e){let r=this.getSnapshotKey(e),n=this.storage.getItem(r);return n?JSON.parse(n):null}addToStreamList(e){let r=`${this.prefix}:streams`,n=this.storage.getItem(r),o=n?JSON.parse(n):[];o.includes(e)||(o.push(e),this.storage.setItem(r,JSON.stringify(o)))}removeFromStreamList(e){let r=`${this.prefix}:streams`,n=this.storage.getItem(r);if(!n)return;let s=JSON.parse(n).filter(i=>i!==e);this.storage.setItem(r,JSON.stringify(s))}};qr("localStorage",t=>new Jr(t));var Ur=class{stores;primaryIndex;constructor(e,r=0){if(e.length===0)throw new Error("CompositeEventStore requires at least one store");this.stores=e,this.primaryIndex=r}get primary(){return this.stores[this.primaryIndex]}async append(e,r){await Promise.all(this.stores.map(n=>n.append(e,r)))}async getEvents(e){return this.primary.getEvents(e)}async exists(e){return this.primary.exists(e)}async getLastEvent(e){return this.primary.getLastEvent(e)}async getEventsAfter(e,r){return this.primary.getEventsAfter(e,r)}async delete(e){await Promise.all(this.stores.map(r=>r.delete(e)))}async listStreams(){return this.primary.listStreams()}};function md(t,e){return new Ur(t,e)}var Wr=class{store;ttl;constructor(e,r){this.store=e,this.ttl=r}isExpired(e){return Date.now()-e>this.ttl}filterExpired(e){return e.filter(r=>!this.isExpired(r.event.ts))}async append(e,r){return this.store.append(e,r)}async getEvents(e){let r=await this.store.getEvents(e);return this.filterExpired(r)}async exists(e){return(await this.getEvents(e)).length>0}async getLastEvent(e){let r=await this.getEvents(e);return r.length>0?r[r.length-1]:null}async getEventsAfter(e,r){return(await this.getEvents(e)).filter(o=>o.seq>r)}async delete(e){return this.store.delete(e)}async listStreams(){return this.store.listStreams()}};function fd(t,e){return new Wr(t,e)}function hd(t){if(!t||typeof t!="object")return!1;let e=t;return typeof e.parse=="function"&&typeof e.safeParse=="function"&&"_def"in e}function gd(t){if(!t||typeof t!="object")return!1;let e=t;return e.name==="ZodError"&&Array.isArray(e.issues)&&typeof e.format=="function"}function yd(t,e){return t.safeParse(e)}function vd(t){return t.issues.map(e=>`${e.path.length>0?`${e.path.join(".")}: `:""}${e.message}`)}function xd(t){let e=t.flatten();return{formErrors:e.formErrors,fieldErrors:e.fieldErrors}}function bd(t){if(!t||typeof t!="object"&&typeof t!="function")return!1;let e=t;return"ast"in e&&e.ast!==void 0&&typeof e.pipe=="function"}function kd(t){if(!t||typeof t!="object")return!1;let e=t;return e._tag==="ParseError"&&"issue"in e}function ks(t){return t._tag==="Right"}function Td(t){return t._tag==="Left"}var vt=null;function Ed(t){vt=t}function wd(){vt=null}function Sd(){return vt!==null}function Zn(){if(!vt)throw new Error("Effect Schema adapter not registered. Call registerEffectSchemaAdapter() first.");return vt}function Ts(t,e){let n=Zn().decodeUnknownEither(t,e);return ks(n)?{success:!0,data:n.right}:{success:!1,error:n.left}}function Es(t){return vt?vt.formatError(t):t.message||"Schema validation failed"}function Cd(t){return{_tag:"effect",parse(e){return Zn().decodeUnknownSync(t,e)},safeParse(e){let r=Ts(t,e);return r.success?{success:!0,data:r.data}:{success:!1,error:new Error(Es(r.error))}}}}var ir=null;function Rd(t){ir=t}function _d(){ir=null}function Od(){return ir!==null}function ws(){if(!ir)throw new Error("JSON Schema adapter not registered. Call registerJSONSchemaAdapter() first.");return ir}function Ad(t){if(!t||typeof t!="object")return!1;let e=t;return"$schema"in e||"type"in e||"properties"in e||"$ref"in e||"allOf"in e||"anyOf"in e||"oneOf"in e}function qn(t,e){let r=ws(),n=r.validate(t,e);if(n.valid)return{success:!0,data:n.data};{let o=r.formatErrors(n.errors);return{success:!1,error:new Error(o)}}}function Ld(t){return{_tag:"jsonschema",parse(e){let r=qn(t,e);if(r.success)return r.data;throw r.error},safeParse(e){return qn(t,e)}}}function Dd(){return{validate:(t,e)=>{let r=[];function n(o,s,i){if(o.type){let a=Array.isArray(o.type)?o.type:[o.type],u=Pd(s);if(!a.some(l=>l===u?!0:l==="integer"&&u==="number"?Number.isInteger(s):!1)){r.push({path:i,message:`Expected ${a.join(" or ")}, got ${u}`,keyword:"type"});return}}if(o.enum&&!o.enum.includes(s)&&r.push({path:i,message:`Value must be one of: ${o.enum.join(", ")}`,keyword:"enum"}),o.const!==void 0&&s!==o.const&&r.push({path:i,message:`Value must be ${JSON.stringify(o.const)}`,keyword:"const"}),o.type==="object"&&typeof s=="object"&&s!==null){let a=s;if(o.required)for(let u of o.required)u in a||r.push({path:`${i}/${u}`,message:`Missing required property: ${u}`,keyword:"required"});if(o.properties)for(let[u,c]of Object.entries(o.properties))u in a&&n(c,a[u],`${i}/${u}`)}o.type==="array"&&Array.isArray(s)&&o.items&&!Array.isArray(o.items)&&s.forEach((a,u)=>{n(o.items,a,`${i}/${u}`)}),o.type==="string"&&typeof s=="string"&&(o.minLength!==void 0&&s.length<o.minLength&&r.push({path:i,message:`String must be at least ${o.minLength} characters`,keyword:"minLength"}),o.maxLength!==void 0&&s.length>o.maxLength&&r.push({path:i,message:`String must be at most ${o.maxLength} characters`,keyword:"maxLength"}),o.pattern&&(new RegExp(o.pattern).test(s)||r.push({path:i,message:`String must match pattern: ${o.pattern}`,keyword:"pattern"}))),o.type==="number"&&typeof s=="number"&&(o.minimum!==void 0&&s<o.minimum&&r.push({path:i,message:`Number must be >= ${o.minimum}`,keyword:"minimum"}),o.maximum!==void 0&&s>o.maximum&&r.push({path:i,message:`Number must be <= ${o.maximum}`,keyword:"maximum"}))}return n(t,e,""),r.length===0?{valid:!0,data:e}:{valid:!1,errors:r}},formatErrors:t=>t.map(e=>`${e.path||"/"}: ${e.message}`).join("; ")}}function Pd(t){return t===null?"null":Array.isArray(t)?"array":typeof t}function Id(t){return t==null||typeof t!="object"?t:Array.isArray(t)?[...t]:{...t}}function Nd(t,e){Object.assign(e,t)}co(()=>new Ye);lo(t=>new ze(t));po(t=>new St(t));mo({getAdapter:yn,hasMatchingAdapter:xn,detectAdapter:vn});export{zr as BaseEventStore,sr as BaseEventStoreWithSnapshots,Ur as CompositeEventStore,rc as DEFAULT_BUCKETS,kr as DocumentWindowImpl,Ye as DriftDetector,pe as ERROR_TYPE_DELAY_DEFAULTS,Jt as ErrorCategory,Br as FileEventStore,Tt as GuardrailEngine,Vt as InMemoryEventStore,St as InterceptorManager,re as L0Error,Gr as L0EventRecorder,Vr as L0EventReplayer,ze as L0Monitor,tr as L0OpenTelemetry,Cr as L0PrometheusCollector,_r as L0Sentry,Jr as LocalStorageEventStore,nc as METRIC_NAMES,wt as Metrics,en as NetworkErrorType,Or as OperationPool,Rr as PrometheusCollector,er as PrometheusRegistry,_ as RETRY_DEFAULTS,Ve as RetryManager,Q as RuntimeStates,Te as SemanticAttributes,ht as SpanKind,gt as SpanStatusCode,Et as StateMachine,Wr as TTLEventStore,hn as TelemetryExporter,Xr as Timer,di as analyticsInterceptor,Ge as analyzeNetworkError,Us as analyzeZeroToken,Hl as anthropicAdapter,vs as anthropicStream,Kl as anthropicText,si as authInterceptor,Ae as autoCorrectJSON,us as balanceBraces,cs as balanceBrackets,lc as batched,Oc as bestConsensus,ci as cachingInterceptor,cr as calculateBackoff,Ir as calculateFieldConsensus,el as calculateMemorySize,Pr as calculateOutputSimilarity,Pn as calculateSimilarityMatrix,hc as calculateSimilarityScore,Dr as calculateStructuralSimilarity,Lc as chainPipelines,ti as checkDrift,_s as checkGuardrails,br as chunkByChars,Co as chunkByParagraphs,Ro as chunkBySentences,Sn as chunkByTokens,Cn as chunkDocument,sl as cleanOutput,hi as clearAdapters,Wo as compareArrays,Uo as compareNumbers,Zo as compareObjects,cd as compareReplays,jt as compareStrings,Dn as compareValues,bc as consensus,uo as consumeStream,Jo as cosineSimilarity,Ln as countFields,js as countMeaningfulTokens,or as createAdapterDataEvent,ps as createAdapterDoneEvent,ms as createAdapterErrorEvent,fs as createAdapterMessageEvent,hs as createAdapterProgressEvent,ds as createAdapterTokenEvent,jl as createAudioEvent,Pc as createBranchStep,Hs as createCompleteEvent,md as createCompositeStore,ei as createDriftDetector,Ks as createErrorEvent,sd as createEventRecorder,id as createEventReplayer,pd as createEventStore,Hn as createGuardrailEngine,Fl as createImageEvent,od as createInMemoryEventStore,pi as createInterceptorManager,Gl as createJsonDataEvent,Yu as createL0PrometheusCollector,Kc as createMemoryEntry,qs as createMessageEvent,ri as createMonitor,ic as createOpenTelemetry,nl as createOutputFormatSection,dl as createParameter,Fn as createPipeline,yi as createPipelineContext,pc as createPool,ec as createPrometheusCollector,Qu as createPrometheusRegistry,Ns as createRetryManager,On as createSentryIntegration,Dd as createSimpleJSONSchemaAdapter,Ac as createStep,Zs as createTokenEvent,ll as createTool,Ao as createWindow,Pu as customPatternRule,$r as dedent,Bs as deduplicateContinuation,Ft as deepEqual,wn as describeJSONError,Ps as describeNetworkError,Un as deserializeError,vn as detectAdapter,no as detectInstantFinish,Wt as detectOverlap,Vs as detectRepeatedTokens,mr as detectZeroToken,Js as detectZeroTokenBeforeFirstMeaningful,zs as endsAbruptly,Nl as ensureJson,yl as escape,Bc as escapeDelimiters,xl as escapeHtml,kl as escapeRegex,Rn as estimateTokenCount,Yr as exponentialBackoff,Ku as exponentialRetry,Xt as extractJSON,Pl as extractJson,ol as extractJsonFromOutput,td as extractMastraObject,ed as extractMastraText,ro as extractMeaningfulTokens,Wl as extractOpenAIText,so as extractTokens,Ic as fastPipeline,Xs as filterEventsByType,Xc as filterMemoryByRole,In as findAgreements,Nn as findDisagreements,Yn as fixedBackoff,Xn as fixedJitterBackoff,xd as flattenZodError,Fr as formatContext,Vc as formatDocument,fl as formatFunctionArguments,zc as formatInstructions,ns as formatJsonOutput,Uc as formatMemory,Gc as formatMultipleContexts,ss as formatOutputConstraints,os as formatStructuredOutput,as as formatTool,cl as formatTools,Qn as fullJitterBackoff,Wn as generateStreamId,yn as getAdapter,Oo as getChunkOverlap,wc as getConsensusValue,Es as getEffectErrorMessage,Zn as getEffectSchemaAdapter,$s as getErrorCategory,ws as getJSONSchemaAdapter,Qc as getLastNEntries,qa as getProcessingStats,bs as getRegisteredAdapters,fo as getRegisteredStreamAdapters,ld as getStreamMetadata,ao as getText,Lr as getType,vd as getZodErrorMessages,Sd as hasEffectSchemaAdapter,Od as hasJSONSchemaAdapter,xn as hasMatchingAdapter,Ce as hasMeaningfulContent,$c as indent,ys as isAnthropicStream,ql as isAnthropicStreamEvent,cn as isBackgroundThrottle,tn as isConnectionDropped,ln as isDNSError,on as isECONNREFUSED,nn as isECONNRESET,Td as isEffectLeft,kd as isEffectParseError,ks as isEffectRight,bd as isEffectSchema,rn as isFetchTypeError,Ad as isJSONSchema,Ls as isL0Error,xs as isMastraStream,Fs as isMeaningfulToken,Pe as isNetworkError,an as isNoBytes,Ul as isOpenAIChunk,gs as isOpenAIStream,dr as isPartialChunks,Ms as isRetryableError,un as isRuntimeKilled,sn as isSSEAborted,to as isSSLError,Is as isStreamInterrupted,Ut as isTimeoutError,En as isValidJSON,Gn as isValidJson,gd as isZodError,hd as isZodSchema,Bo as jaroWinklerSimilarity,Ju as jsonOnlyGuardrails,Mt as jsonRule,ue as l0,Xu as l0PrometheusMiddleware,Wa as l0WithWindow,Ya as largeWindow,Wu as latexOnlyGuardrails,wr as latexRule,_c as lenientConsensus,zo as levenshteinDistance,An as levenshteinSimilarity,Kn as linearBackoff,ni as loggingInterceptor,Uu as markdownOnlyGuardrails,Qt as markdownRule,rd as mastraAdapter,Jn as mastraStream,Xl as mastraStructured,Yl as mastraText,Ka as mediumWindow,$n as meetsMinimumAgreement,_n as mergeChunks,Yc as mergeMemory,Za as mergeResults,oi as metadataInterceptor,Vu as minimalGuardrails,Zu as minimalRetry,Va as minimalStructured,qe as normalizeForModel,Xo as normalizeIndentation,yt as normalizeNewlines,fr as normalizeStreamEvent,Ys as normalizeStreamEvents,es as normalizeText,Yo as normalizeWhitespace,ac as openTelemetryInterceptor,Zl as openaiAdapter,Bl as openaiJSON,jr as openaiStream,zl as openaiText,Jl as openaiWithTools,Cl as pad,Xa as paragraphWindow,Ar as parallel,uc as parallelAll,Dc as parallelPipelines,hl as parseFunctionCall,Dl as parseOrRepairJson,Sr as patternRule,Ko as pipe,Ua as processWithWindow,Mc as productionPipeline,tc as prometheusMiddleware,Ec as quickConsensus,dc as race,ui as rateLimitInterceptor,zu as recommendedGuardrails,qu as recommendedRetry,za as recommendedStructured,Qs as reconstructText,mi as registerAdapter,Ed as registerEffectSchemaAdapter,Rd as registerJSONSchemaAdapter,qr as registerStorageAdapter,Nc as reliablePipeline,Rl as removeAnsi,ls as removeTrailingCommas,Ma as repairJSON,nr as repairJson,Al as repairLatexEnvironments,Ol as repairMarkdownFences,Ll as repairToolCallArguments,ad as replay,Mr as resolveBest,Gt as resolveMajority,Mn as resolveMerge,bi as runAsyncDriftCheck,vi as runAsyncGuardrailCheck,ki as runDriftCheckAsync,xi as runGuardrailCheckAsync,gi as runStages,Ts as safeDecodeEffectSchema,$a as safeJSONParse,yd as safeParse,Tl as sanitize,Qa as sentenceWindow,oc as sentryInterceptor,cc as sequential,nd as serializeError,Id as shallowClone,Nd as shallowCopy,Qr as sleep,Ha as smallWindow,_o as splitIntoSentences,Rc as standardConsensus,Cc as strictConsensus,Bu as strictGuardrails,nu as strictJsonRule,Hu as strictRetry,Ba as strictStructured,It as structured,ja as structuredArray,Fa as structuredObject,Ga as structuredStream,pr as suggestRetryDelay,eo as timeout,ii as timingInterceptor,Ml as toL0Events,$l as toL0EventsWithMessages,Vl as toMultimodalL0Events,li as transformInterceptor,gl as trim,Qo as trimText,El as truncate,tl as truncateMemory,wl as truncateWords,vl as unescape,Jc as unescapeDelimiters,bl as unescapeHtml,fi as unregisterAdapter,wd as unregisterEffectSchemaAdapter,_d as unregisterJSONSchemaAdapter,dd as unregisterStorageAdapter,Sc as validateConsensus,qn as validateJSONSchema,pl as validateTool,ai as validationInterceptor,sc as withSentry,fd as withTTL,Os as withTimeout,Sl as wrap,zn as wrapAnthropicStream,Cd as wrapEffectSchema,Ld as wrapJSONSchema,Ql as wrapMastraFullStream,Bn as wrapMastraStream,Vn as wrapOpenAIStream,Ze as zeroOutputRule};
